<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Memorial Video</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Atkinson Hyperlegible', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(180deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #d0a789;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .header-logo {
      max-width: 500px;
      height: auto;
      margin-bottom: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    
    .content {
      padding: 30px;
    }
    
    /* Summary Sentence */
    .summary-box {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border-left: 4px solid #2a5298;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      font-size: 16px;
      line-height: 1.6;
      color: #333;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
    }
    
    .summary-box strong {
      color: #2a5298;
      font-weight: 700;
    }
    
    /* Video Player Section */
    .video-section {
      margin-bottom: 30px;
    }
    
    .video-wrapper {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    video {
      width: 100%;
      display: block;
    }
    
    .loading {
      padding: 100px 20px;
      text-align: center;
      color: #999;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2a5298;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      padding: 30px;
      background: #fee;
      border-left: 4px solid #e33;
      border-radius: 8px;
      color: #c33;
    }
    
    /* Action Buttons */
    .actions {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    /* Top Row Actions - 4 Equal Buttons */
    #actionButtons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    #actionButtons .btn {
      width: 100%;
      justify-content: center;
      padding: 16px 12px;
      font-size: 14px;
      line-height: 1.3;
    }
    
    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    
    .btn-primary:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }
    
    .btn-secondary {
      background: #2196F3;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #0b7dda;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }
    
    .btn-outline {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }
    
    .btn-outline:hover {
      background: #667eea;
      color: white;
    }

    .btn-edit {
      background: #FF9800;
      color: white;
    }

    .btn-edit:hover {
      background: #f57c00;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
    }
    
    /* Edit Sections */
    .edit-sections {
      border-top: 2px solid #f0f0f0;
      padding-top: 30px;
      margin-top: 30px;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 25px;
    }
    
    .section-header h2 {
      font-size: 22px;
      color: #333;
    }
    
    .section-header .badge {
      background: #667eea;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .edit-option {
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    
    .edit-option:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }
    
    .edit-option-header {
      padding: 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    
    .edit-option-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
    }
    
    .edit-option-icon {
      font-size: 24px;
    }
    
    .chevron {
      font-size: 20px;
      transition: transform 0.3s;
      color: #999;
    }
    
    .edit-option.expanded .chevron {
      transform: rotate(180deg);
    }
    
    .edit-option-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding: 0 20px;
    }
    
    .edit-option.expanded .edit-option-content {
      max-height: 3000px;
      padding: 0 20px 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
      font-size: 14px;
    }

    .form-group .help-text {
      font-size: 13px;
      color: #777;
      font-weight: 400;
      margin-top: 4px;
    }
    
    .form-group select,
    .form-group input[type="number"],
    .form-group input[type="file"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    
    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .radio-option {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .radio-option:hover {
      border-color: #2a5298;
      background: #f8f9ff;
    }

    .radio-option.selected {
      border-color: #2a5298;
      background: #f8f9ff;
    }
    
    .radio-option input[type="radio"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin-top: 2px;
      flex-shrink: 0;
    }

    .radio-option-content {
      flex: 1;
    }

    .radio-option-label {
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    .radio-option-desc {
      font-size: 13px;
      color: #666;
    }

    .conditional-input {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border-radius: 6px;
    }
    
    .placeholder {
      padding: 20px;
      background: #fff9e6;
      border: 2px dashed #ffd700;
      border-radius: 8px;
      text-align: center;
      color: #886600;
      font-style: italic;
    }

    .info-box {
      padding: 16px;
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #1565c0;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .song-list {
      margin-bottom: 20px;
    }

    .song-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }

    .song-item:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .song-item.new-upload {
      border-color: #4CAF50;
      background: #f1f8f4;
    }

    .song-item.library-song {
      border-color: #FF9800;
      background: #fff9f0;
    }

    .song-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .song-position {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .song-item:hover .song-position {
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .song-name {
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .song-badge {
      background: #4CAF50;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .song-badge.library {
      background: #FF9800;
    }

    .song-controls {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }

    .btn-play {
      background: #2196F3;
      color: white;
    }

    .btn-play:hover {
      background: #0b7dda;
    }

    .btn-play.playing {
      background: #FF9800;
    }

    .btn-move {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #ddd;
    }

    .btn-move:hover {
      background: #e0e0e0;
    }

    .btn-move:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    /* Song Library Styles */
    .library-section {
      background: linear-gradient(135deg, #fff9f0 0%, #ffe8cc 100%);
      border: 2px solid #FF9800;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .library-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      font-size: 16px;
      font-weight: 700;
      color: #e65100;
    }

    .library-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    .library-song-card {
      background: white;
      border: 2px solid #FFE0B2;
      border-radius: 10px;
      padding: 12px;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .library-song-card:hover {
      border-color: #FF9800;
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
      transform: translateY(-2px);
    }

    .library-song-card.added {
      border-color: #4CAF50;
      background: #f1f8f4;
    }

    .library-song-name {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      line-height: 1.3;
    }

    .library-song-controls {
      display: flex;
      gap: 6px;
    }

    .btn-add-library {
      flex: 1;
      padding: 8px 12px;
      background: #FF9800;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-add-library:hover:not(:disabled) {
      background: #f57c00;
    }

    .btn-add-library:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-add-library.added {
      background: #4CAF50;
    }

    .upload-section {
      margin-top: 15px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
      border: 2px dashed #ccc;
    }

    .upload-section.max-reached {
      opacity: 0.6;
      pointer-events: none;
    }

    .upload-label {
      display: inline-block;
      padding: 10px 20px;
      background: #2a5298;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }

    .upload-label:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }

    .upload-label.disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* PowerPoint Upload Section */
    .pptx-upload-section {
      margin-top: 15px;
      padding: 20px;
      background: #fff9e6;
      border: 2px dashed #FF9800;
      border-radius: 8px;
    }

    .pptx-upload-section .upload-label {
      background: #FF9800;
      padding: 12px 24px;
      font-size: 15px;
    }

    .pptx-upload-section .upload-label:hover {
      background: #f57c00;
    }

    .pptx-file-preview {
      margin-top: 15px;
      padding: 12px;
      background: white;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .pptx-file-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pptx-file-icon {
      font-size: 24px;
    }

    .pptx-file-details {
      display: flex;
      flex-direction: column;
    }

    .pptx-file-name {
      font-weight: 600;
      color: #333;
    }

    .pptx-file-size {
      font-size: 13px;
      color: #666;
    }

    /* Song Range Sliders */
    .song-ranges-container {
      margin-top: 15px;
    }

    .song-range-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
    }

    .song-range-header {
      font-weight: 600;
      color: #2a5298;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slide-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .slide-input-group {
      display: flex;
      flex-direction: column;
    }

    .slide-input-group label {
      font-size: 13px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
    }

    .slide-input-group input {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }

    .slide-input-group input:focus {
      outline: none;
      border-color: #2a5298;
    }
    
    /* Resubmit Button */
    .resubmit-section {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 2px solid #f0f0f0;
      text-align: center;
    }
    
    .btn-resubmit {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 18px 40px;
      font-size: 18px;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 6px 20px rgba(30, 60, 114, 0.4);
    }
    
    .btn-resubmit:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(30, 60, 114, 0.5);
    }
    
    .btn-resubmit:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
      animation: fadeIn 0.3s;
    }

    .modal-overlay.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Modal Container */
    .modal {
      background: white;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      animation: slideUp 0.3s;
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      padding: 24px 30px;
      border-radius: 16px 16px 0 0;
      position: relative;
    }

    .modal-header.help-header {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    }

    .modal-header.share-header {
      background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
    }
    
    .modal-header h2 {
      margin: 0 0 8px 0;
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-header p {
      margin: 0;
      opacity: 0.95;
      font-size: 15px;
      line-height: 1.5;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 30px;
    }

    .modal-form-group {
      margin-bottom: 20px;
    }

    .modal-form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }

    .modal-form-group label .required {
      color: #f44336;
      margin-left: 2px;
    }

    .modal-form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }

    .modal-form-group input:focus {
      outline: none;
      border-color: #4CAF50;
    }

    .modal-form-group input.error {
      border-color: #f44336;
    }

    .modal-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .modal-info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #1565c0;
      line-height: 1.6;
    }

    .modal-footer {
      padding: 20px 30px 30px;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn-primary {
      background: #4CAF50;
      color: white;
    }

    .modal-btn-primary:hover:not(:disabled) {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }

    .modal-btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .modal-btn-danger {
      background: #f44336;
      color: white;
    }

    .modal-btn-danger:hover:not(:disabled) {
      background: #d32f2f;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
    }

    .modal-btn-danger:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .modal-btn-secondary {
      background: #f5f5f5;
      color: #666;
      border: 2px solid #e0e0e0;
    }

    .modal-btn-secondary:hover {
      background: #e0e0e0;
    }

    .modal-btn-info {
      background: #2196F3;
      color: white;
    }

    .modal-btn-info:hover:not(:disabled) {
      background: #0b7dda;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }

    .modal-btn-info:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* Share Recipients List */
    .recipients-list {
      margin-bottom: 20px;
    }

    .recipient-item {
      background: #f5f5f5;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
      position: relative;
    }

    .recipient-item.last {
      border-color: #2196F3;
      background: #e3f2fd;
    }

    .recipient-number {
      position: absolute;
      top: 15px;
      left: 15px;
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }

    .recipient-fields {
      margin-left: 40px;
    }

   .recipient-remove {
     position: absolute;
     top: 15px;
     right: 15px;
     background: #f44336;
     color: white;
     border: none;
     width: 28px;
     height: 28px;
     border-radius: 50%;
     cursor: pointer;
     font-size: 16px;
     display: flex;
     align-items: center;
     justify-content: center;
     transition: all 0.2s;
   }

   .recipient-remove:hover {
     background: #d32f2f;
     transform: scale(1.1);
   }

   .btn-add-recipient {
     width: 100%;
     padding: 12px;
     background: #f5f5f5;
     border: 2px dashed #2196F3;
     border-radius: 8px;
     color: #2196F3;
     font-weight: 600;
     font-size: 14px;
     cursor: pointer;
     transition: all 0.2s;
     display: flex;
     align-items: center;
     justify-content: center;
     gap: 8px;
   }

   .btn-add-recipient:hover {
     background: #e3f2fd;
     border-color: #0b7dda;
     color: #0b7dda;
   }
    
    /* Notification Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 16px 24px;
      background: #333;
      color: white;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
      max-width: 400px;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .toast.success {
      background: #4CAF50;
    }
    
    .toast.error {
      background: #f44336;
    }
    
    @media (max-width: 768px) {
      .header h1 { font-size: 24px; }
      .actions { flex-direction: column; }
      .btn { width: 100%; justify-content: center; }
      .toast { right: 20px; left: 20px; max-width: none; }
      .slide-inputs { grid-template-columns: 1fr; }
      .song-controls { flex-wrap: wrap; }
      .library-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://www.dropbox.com/scl/fi/i5ye9vg5wzfvxwyrwczq6/Untitled-940-x-600-px-1400-x-600-px.png?rlkey=rk5t9ot5gchvjcqx71lwiln1o&st=8orea38d&dl=1" alt="Company Logo" class="header-logo">
      <h1 id="headerTitle">‚ú® Your Memorial Video</h1>
      <p id="jobInfo">Loading...</p>
      <div id="versionSelector" style="display:none; margin-top: 15px;">
        <label for="versionDropdown" style="color: white; font-size: 14px; margin-right: 8px;">Video Version:</label>
        <select id="versionDropdown" style="padding: 8px 12px; border-radius: 6px; border: 2px solid white; font-weight: 600; font-size: 14px; cursor: pointer;">
          <!-- Will be populated dynamically -->
        </select>
        <button id="revertBtn" class="btn btn-outline" style="display:none; margin-left: 12px; padding: 8px 16px; font-size: 13px;">
          üîÑ Revert to This Version
        </button>
      </div>
    </div>
      
      <!-- Video Player Section -->
      <div class="video-section">
        <div id="videoContainer" class="loading">
          <div class="spinner"></div>
          <p>Loading your video...</p>
        </div>
      </div>
      
      <!-- Primary Actions - Top Row -->
      <div class="actions" id="actionButtons" style="margin-bottom: 15px;">
        <button id="editBtn" class="btn btn-edit" style="display:none;">
          ‚úèÔ∏è Edit & Republish My Video (unlimited submissions)
        </button>
        <button id="shareBtn" class="btn btn-secondary" style="display:none;">
          üì© Share Draft Video with Others
        </button>
        <button id="deliverBtn" class="btn btn-primary" style="display:none;">
          ‚õ™Ô∏è Deliver Final Downloadable Video to My Event Coordinator
        </button>
        <button id="helpBtn" class="btn btn-danger" style="display:none;">
          üôã‚Äç‚ôÄÔ∏è Help Needed
        </button>
      </div>
      
      <!-- Secondary Action - Bottom Row -->
      <div class="actions" id="finalizeButtonContainer" style="justify-content: center;">
        <button id="finalizeBtn" class="btn-resubmit" style="display:none; padding: 18px 40px; font-size: 16px;">
          ‚úÖ I am finished (Send me a Video Download Link)
        </button>
      </div>
      
      <!-- Finalized State -->
      <div id="finalizedMessage" style="display:none;">
        <div style="background: #e8f5e9; border: 2px solid #4CAF50; border-radius: 12px; padding: 30px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
          <h2 style="color: #2e7d32; margin-bottom: 10px;">Order Complete!</h2>
          <p style="color: #555; margin-bottom: 20px;">Your memorial video has been finalized. A backup copy has been sent to your email.</p>
          <a id="finalDownloadBtn" href="#" class="btn btn-primary">
            üì• Download Video Again
          </a>
        </div>
      </div>
      
      <!-- Edit Sections -->
      <div class="edit-sections" id="editSections" style="display:none;">
        <div class="section-header">
          <h2>‚úèÔ∏è Make Changes to Your Video</h2>
        </div>
        
        <!-- Change Songs (MOVED TO TOP) -->
        <div class="edit-option" data-section="songs">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">üéµ</span>
              <span>Change Songs</span>
            </div>
            <span class="chevron">‚ñº</span>
          </div>
          <div class="edit-option-content">
            <!-- Song Library -->
            <div class="library-section">
              <div class="library-header">
               üéº Song Library - Choose from our curated memorial music
              </div>
              <div style="margin-bottom: 15px;">
                <label for="genreSelect" style="font-weight: 600; color: #e65100; margin-bottom: 6px; display: block;">Select Genre:</label>
                <select id="genreSelect" style="padding: 10px; border: 2px solid #FF9800; border-radius: 8px; font-size: 14px; font-weight: 600; background: white; cursor: pointer; width: 200px;">
                  <option value="Classical">Classical</option>
                  <option value="Soft Pop">Soft Pop</option>
                  <option value="Country">Country</option>
                </select>
              </div>
              <div class="library-grid" id="libraryGrid">
                <!-- Will be populated dynamically -->
              </div>
            </div>

            <div class="form-group">
              <label>Your Selected Songs (drag to reorder, max 6 total)</label>
              <div id="songList" class="song-list">
                <!-- Will be populated dynamically -->
              </div>
            </div>
            
            <div class="upload-section" id="uploadSection">
              <label class="upload-label" id="uploadLabel">
                üì§ Upload Your Own Songs (MP3)
                <input type="file" id="newSongUpload" accept=".mp3,audio/mpeg" multiple style="display: none;">
              </label>
              <div style="margin-top: 8px; font-size: 13px; color: #666;">
                <span id="songCountDisplay">0 of 6 songs</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Change Transitions -->
        <div class="edit-option" data-section="transitions">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">üé®</span>
              <span>Change Transitions</span>
            </div>
            <span class="chevron">‚ñº</span>
          </div>
          <div class="edit-option-content">
            <div class="form-group">
              <label for="visualPackage">
                Visual Package
                <div class="help-text">Choose the style of transitions between slides</div>
              </label>
              <select id="visualPackage" name="visualPackage">
                <option value="">-- Select a package --</option>
                <option value="simple-fade-wipe">Simple Fade & Wipe</option>
                <option value="pages-of-life">Pages of Life</option>
                <option value="floating-frames">Floating Frames</option>
                <option value="zoom-through">Zoom Through</option>
                <option value="blinds-combs-bars">Blinds, Combs & Bars</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Change Timing -->
        <div class="edit-option" data-section="timing">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">‚è±Ô∏è</span>
              <span>Change Video Length</span>
            </div>
            <span class="chevron">‚ñº</span>
          </div>
          <div class="edit-option-content">
            <div class="form-group">
              <label for="slideCount">
                Number of Slides in Your Presentation
                <div class="help-text">Total number of slides (first and last slides display 2x longer)</div>
              </label>
              <input type="number" id="slideCount" name="slideCount" min="2" max="250" value="" placeholder="e.g., 50">
            </div>
            <div class="form-group">
              <label>Timing Mode</label>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" name="timingMode" value="perSlide">
                  <div class="radio-option-content">
                    <span class="radio-option-label">Per Slide Duration</span>
                    <span class="radio-option-desc">Set how many seconds each slide should display</span>
                    <div class="conditional-input" id="perSlideInput" style="display:none;">
                      <label for="perSlideSec" style="font-size: 13px; margin-bottom: 6px;">Seconds per slide:</label>
                      <input type="number" id="perSlideSec" name="perSlideSec" min="2" max="30" value="5" style="padding: 8px;">
                    </div>
                  </div>
                </label>
                
                <label class="radio-option">
                  <input type="radio" name="timingMode" value="fixedRuntime">
                  <div class="radio-option-content">
                    <span class="radio-option-label">Fixed Total Runtime</span>
                    <span class="radio-option-desc">Set the total video length in seconds</span>
                    <div class="conditional-input" id="fixedRuntimeInput" style="display:none;">
                      <label for="fixedRuntimeSec" style="font-size: 13px; margin-bottom: 6px;">Total runtime (seconds):</label>
                      <input type="number" id="fixedRuntimeSec" name="fixedRuntimeSec" min="30" max="1800" value="320" style="padding: 8px;">
                    </div>
                  </div>
                </label>
                
                <label class="radio-option">
                  <input type="radio" name="timingMode" value="fitToSongs">
                  <div class="radio-option-content">
                    <span class="radio-option-label">Fit to Music Length</span>
                    <span class="radio-option-desc">Video duration matches your music (automatic)</span>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- ‚úÖ NEW: Duration Display -->
        <div id="durationDisplay" class="preview-section" style="display:none; background: #e8f5e9; border-color: #4CAF50; margin-top: 20px; margin-bottom: 20px;">
          <div class="preview-header" style="color: #2e7d32;">
            ‚è±Ô∏è Estimated Video Duration
          </div>
          <div style="padding: 15px; background: white; border-radius: 8px;">
            <div style="font-size: 32px; font-weight: 700; color: #4CAF50; text-align: center;" id="durationValue">
              --:--
            </div>
            <div style="font-size: 14px; color: #666; text-align: center; margin-top: 8px;" id="durationDetails">
              Enter slide count to calculate
            </div>
          </div>
        </div>
        
        <!-- Change Song Logic -->
        <div class="edit-option" data-section="songlogic">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">üéº</span>
              <span>Change Song Logic</span>
            </div>
            <span class="chevron">‚ñº</span>
          </div>
          <div class="edit-option-content">
            <div class="form-group">
              <label for="musicDistribution">
                Music Distribution
                <div class="help-text">How songs should be spread across the video</div>
              </label>
              <select id="musicDistribution" name="musicDistribution">
                <option value="">-- Select distribution --</option>
                <option value="evenlyDistributed">Evenly Distributed</option>
                <option value="specifyPlacement">Specify Placement</option>
              </select>
            </div>

            <!-- Conditional Song Range Sliders -->
            <div id="songRangesContainer" class="song-ranges-container" style="display:none;">
              <div class="info-box">
                üìç Specify which slides each song should play during. The backend will automatically prevent overlaps and fill gaps.
              </div>
              <div id="songRangesList">
                <!-- Will be populated dynamically based on number of songs -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Manual Changes -->
        <div class="edit-option" data-section="manual">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">‚úèÔ∏è</span>
              <span>Edit Slideshow</span>
            </div>
            <span class="chevron">‚ñº</span>
          </div>
          <div class="edit-option-content">
            <div class="info-box" id="manualEditInfoBox">
              Edit your presentation directly, then come back here and click "Resubmit Changes" to create a new video with your edits.
            </div>
            <div id="manualEditButtons" class="button-group">
              <!-- Buttons will be populated based on presentation type -->
            </div>
            
            <!-- PowerPoint Upload Section (Only shows for PowerPoint providers) -->
            <div id="pptxUploadSection" class="pptx-upload-section" style="display:none;">
              <div style="margin-bottom: 12px; font-weight: 600; color: #FF9800;">
                üìÑ Upload a New PowerPoint File
              </div>
              <label class="upload-label">
                üì§ Choose PowerPoint File (.pptx)
                <input type="file" id="newPptxUpload" accept=".pptx,application/vnd.openxmlformats-officedocument.presentationml.presentation" style="display: none;">
              </label>
              <div id="pptxFilePreview" style="display:none;">
                <!-- File preview will appear here -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Resubmit Section -->
        <div class="resubmit-section">
          <button id="resubmitBtn" class="btn-resubmit" disabled>
            üöÄ Resubmit Changes
          </button>
          <p style="margin-top:12px; color:#999; font-size:14px;">
            Make changes above, then click to create a new video
          </p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Deliver to Coordinator Modal -->
  <div id="deliverModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="closeDeliverModal()">√ó</button>
        <h2>‚õ™Ô∏è Deliver to Event Coordinator</h2>
        <p>Ready to deliver your final memorial video? Send downloadable link to your funeral home or end of life event coordinator.</p>
      </div>
      <div class="modal-body">
        <form id="deliverForm">
          <div class="modal-form-row">
            <div class="modal-form-group">
              <label>First Name<span class="required">*</span></label>
              <input type="text" id="coordFirstName" required placeholder="Jane">
            </div>
            <div class="modal-form-group">
              <label>Last Name<span class="required">*</span></label>
              <input type="text" id="coordLastName" required placeholder="Smith">
            </div>
          </div>
        
          <div class="modal-form-group">
            <label>Event Host Organization Name<span class="required">*</span></label>
            <input type="text" id="coordOrgName" required placeholder="e.g., Family Funeral Homes">
          </div>
        
          <div class="modal-form-group">
            <label>Email Address<span class="required">*</span></label>
            <input type="email" id="coordEmail" required placeholder="jane@familyfuneralhomes.com">
          </div>
        
          <div class="modal-info-box">
            üìß <strong>What happens next?</strong><br>
            The send button will deliver a video view link and MP4 file download link to your end of life event coordinator. It will include a video acceptance confirmation request. We will also copy you on this email to facilitate direct communication.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="modal-btn modal-btn-secondary" onclick="closeDeliverModal()">
          Cancel
        </button>
        <button type="button" class="modal-btn modal-btn-primary" onclick="submitDelivery()" id="deliverSubmitBtn">
          üì§ Send to Coordinator
        </button>
      </div>
    </div>
  </div>

  <!-- Help Needed Modal -->
  <div id="helpModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header help-header">
        <button class="modal-close" onclick="closeHelpModal()">√ó</button>
        <h2>üôã‚Äç‚ôÄÔ∏è Help Needed</h2>
        <p>I have tried editing and re-publishing my video, but it's not quite right. I would like some human help with final video revisions. Please send me a revision request form for your team to help me finalize my video.</p>
      </div>
      <div class="modal-body">
        <form id="helpForm">
          <div class="modal-form-row">
            <div class="modal-form-group">
              <label>First Name<span class="required">*</span></label>
              <input type="text" id="helpFirstName" required placeholder="John">
            </div>
            <div class="modal-form-group">
              <label>Last Name<span class="required">*</span></label>
              <input type="text" id="helpLastName" required placeholder="Doe">
            </div>
          </div>
        
          <div class="modal-form-group">
            <label>Email Address<span class="required">*</span></label>
            <input type="email" id="helpEmail" required placeholder="john@example.com">
          </div>
        
          <div class="modal-info-box">
            üìù <strong>What happens next?</strong><br>
            The send button will deliver you a revision request form to help you describe the assistance needed so that we can get your request to the right team member for review.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="modal-btn modal-btn-secondary" onclick="closeHelpModal()">
          Cancel
        </button>
        <button type="button" class="modal-btn modal-btn-danger" onclick="submitHelp()" id="helpSubmitBtn">
          ‚úâÔ∏è Send me a help request form
        </button>
      </div>
    </div>
  </div>

  <!-- Share Draft Video Modal -->
  <div id="shareModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header share-header">
        <button class="modal-close" onclick="closeShareModal()">√ó</button>
        <h2>üì© Share Draft Video</h2>
        <p>Invite family and friends to review & comment and/or edit your video</p>
      </div>
      <div class="modal-body">
        <form id="shareForm">
          <div class="recipients-list" id="recipientsList">
            <!-- Recipients will be added here dynamically -->
          </div>
        
          <button type="button" class="btn-add-recipient" onclick="addRecipient()">
            ‚ûï Add Another Recipient
          </button>
        
          <div class="modal-info-box" style="margin-top: 20px;">
            üîó <strong>What happens next?</strong><br>
            Each recipient will receive an email with a link to view your draft video. They'll be able to leave comments and suggestions to help you finalize it.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="modal-btn modal-btn-secondary" onclick="closeShareModal()">
          Cancel
        </button>
        <button type="button" class="modal-btn modal-btn-info" onclick="submitShare()" id="shareSubmitBtn">
          üì§ Send Invitations
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // Configuration
    const API_BASE = 'https://4hyy6kr2id.execute-api.us-east-2.amazonaws.com/prod';
    const MAX_SONGS = 6;

    // Global state
    let allVersions = [];
    let currentVersionIndex = 0;
    
    // Song Library with S3 URLs
    const SONG_LIBRARY = [
      // Existing 11 songs with genres added
      {
        id: 'lib-abandoned-house',
        name: 'abandoned-house-115974.mp3',
        displayName: 'Abandoned House',
        genre: 'Classical',
        duration: 272,
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/abandoned-house-115974.mp3'
      },
      {
        id: 'lib-cathedral',
        name: 'cathedral-164234.mp3',
        displayName: 'Cathedral',
        genre: 'Classical',
        duration: 85,
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/cathedral-164234.mp3'
      },
      {
        id: 'lib-eulogy',
        name: 'eulogy-ambient-piano-music-for-furneral-exit-download-royalty-free-196437.mp3',
        displayName: 'Eulogy - Ambient Piano',
        genre: 'Soft Pop',
        duration: 75,
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/eulogy-ambient-piano-music-for-furneral-exit-download-royalty-free-196437.mp3'
      },
      {
        id: 'lib-flowers',
        name: 'flowers-of-sorrow-115981.mp3',
        displayName: 'Flowers of Sorrow',
        genre: 'Classical',
        duration: 208,
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/flowers-of-sorrow-115981.mp3'
      },
      {
        id: 'lib-funeral-memories',
        name: 'funeral-memories-sad-asmr-piano-soft-farewell-334314.mp3',
        displayName: 'Funeral Memories - Soft Farewell',
        genre: 'Classical',
        duration: 129,
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/funeral-memories-sad-asmr-piano-soft-farewell-334314.mp3'
      },
      {
        id: 'lib-gentle-remembrance',
        name: 'gentle-remembrance-359855.mp3',
        displayName: 'Gentle Remembrance',
        genre: 'Classical',
        duration: 90,
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/gentle-remembrance-359855.mp3'
      },
      {
        id: 'lib-sad-cinematic',
        name: 'sad-cinematic-despair-mourning-tragic-music-340712.mp3',
        displayName: 'Sad Cinematic - Mourning',
        genre: 'Classical',
        duration: 633,
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/sad-cinematic-despair-mourning-tragic-music-340712.mp3'
      },
      {
        id: 'lib-shadows-towers',
        name: 'shadows-of-the-wailing-towers-2-304723.mp3',
        displayName: 'Shadows of the Wailing Towers',
        genre: 'Classical',
        duration: 238,
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/shadows-of-the-wailing-towers-2-304723.mp3'
      },
      {
        id: 'lib-souls-silence',
        name: 'souls-of-silence-369585.mp3',
        displayName: 'Souls of Silence',
        genre: 'Classical',
        duration: 241,
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/souls-of-silence-369585.mp3'
      },
      {
        id: 'lib-hands-loved',
        name: 'the-hands-that-loved-me-301869.mp3',
        displayName: 'The Hands That Loved Me',
        genre: 'Soft Pop',
        duration: 158,
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/the-hands-that-loved-me-301869.mp3'
      },
      {
        id: 'lib-voices-eternity',
        name: 'voices-of-eternity-church-cathedral-choir-195196.mp3',
        displayName: 'Voices of Eternity - Cathedral Choir',
        genre: 'Classical',
        duration: 154,
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/voices-of-eternity-church-cathedral-choir-195196.mp3'
      },
  
      // 14 NEW SONGS
      {
        id: 'lib-tomorrow-fade',
        name: 'today-we-are-tomorrow-we-fade-1-312133.mp3',
        displayName: 'Tomorrow we Fade',
        genre: 'Soft Pop',
        duration: 186,
        url: 'https://www.dropbox.com/scl/fi/0asgkicde2n28tf87b8qo/today-we-are-tomorrow-we-fade-1-312133.mp3?rlkey=v6ei0lgzs8w0pkn8bbdac8o6b&st=iqwkrjxm&dl=1'
      },
      {
        id: 'lib-farewell-love',
        name: 'farewell-full-of-love-346874.mp3',
        displayName: 'Farewell Full Of Love',
        genre: 'Soft Pop',
        duration: 226,
        url: 'https://www.dropbox.com/scl/fi/veydq16v6o1fc9wbib9mb/farewell-full-of-love-346874.mp3?rlkey=z2c1op2lwux73w42h27pyjemo&st=9hqb5auf&dl=1'
      },
      {
        id: 'lib-remember',
        name: 'remember-116568.mp3',
        displayName: 'Remember',
        genre: 'Classical',
        duration: 232,
        url: 'https://www.dropbox.com/scl/fi/gn9wrfgu68od861d7jp6m/remember-116568.mp3?rlkey=39ksfzdo1jct5she6at0fadg4&st=vikyio0s&dl=1'
      },
      {
        id: 'lib-sad-violin',
        name: 'sad-violin-150146.mp3',
        displayName: 'Sad Violin',
        genre: 'Classical',
        duration: 116,
        url: 'https://www.dropbox.com/scl/fi/h30dhlibvdvntrb7du2pt/sad-violin-150146.mp3?rlkey=tbf9768lw6n91fqovclt7tih9&st=njiipgri&dl=1'
      },
      {
        id: 'lib-across-oceans',
        name: 'across-the-oceans-269104.mp3',
        displayName: 'Across the Oceans',
        genre: 'Soft Pop',
        duration: 229,
        url: 'https://www.dropbox.com/scl/fi/cjrv91gurffdzkhe52wl0/across-the-oceans-269104.mp3?rlkey=zlypsu83xz9ub23rksrkk0y4z&st=wd9hcv41&dl=1'
      },
      {
        id: 'lib-sad-song',
        name: 'sad-song-326267.mp3',
        displayName: 'Sad Song',
        genre: 'Soft Pop',
        duration: 237,
        url: 'https://www.dropbox.com/scl/fi/jnpgd88i5fb9iunth1pgy/sad-song-326267.mp3?rlkey=9ez0kvz8h3ksz6gsh44tobq8w&st=ityngxdd&dl=1'
      },
      {
        id: 'lib-funeral',
        name: 'funeral-165257.mp3',
        displayName: 'Funeral',
        genre: 'Classical',
        duration: 99,
        url: 'https://www.dropbox.com/scl/fi/pk1nfassm9zu10u84w077/funeral-165257.mp3?rlkey=zeqegrvt6mn0raxq0z9jb2l2i&st=zy3g1yxu&dl=1'
      },
      {
        id: 'lib-gospel-worship',
        name: 'gospel-worship-christian-church-music-323163.mp3',
        displayName: 'Gospel Worship',
        genre: 'Classical',
        duration: 133,
        url: 'https://www.dropbox.com/scl/fi/qt7vc3pub1d14nql5jggl/gospel-worship-christian-church-music-323163.mp3?rlkey=i2ibmhmcb57tkua7gvrpm54s0&st=85kz2m87&dl=1'
      },
      {
        id: 'lib-hands-heaven',
        name: 'hands-to-heaven-318378.mp3',
        displayName: 'Hands to Heaven',
        genre: 'Country',
        duration: 221,
        url: 'https://www.dropbox.com/scl/fi/l0xrjhpi0zbekenl263cw/hands-to-heaven-318378.mp3?rlkey=sf674v2hyp40ov4n35hk75dpm&st=gwu1ain2&dl=1'
      },
      {
        id: 'lib-moonlight-sonata',
        name: 'beethoven-sonata-no14-op-27-moonlight-sonata-14237.mp3',
        displayName: 'Moonlight Sonata',
        genre: 'Classical',
        duration: 325,
        url: 'https://www.dropbox.com/scl/fi/6697emjmf8eoaku8zsg3d/beethoven-sonata-no14-op-27-moonlight-sonata-14237.mp3?rlkey=3mx2attdzjxmaeabnsjq6n3vl&st=wl6wou9q&dl=1'
      },
      {
        id: 'lib-wailing-towers',
        name: 'shadows-of-the-wailing-towers-2-304723.mp3',
        displayName: 'Wailing Towers',
        genre: 'Classical',
        duration: 238,
        url: 'https://www.dropbox.com/scl/fi/tbj5e1w9dsw3juik4huqu/shadows-of-the-wailing-towers-2-304723.mp3?rlkey=nrlt1agwj7iiy1hlgszq3vt06&st=2a5espf8&dl=1'
      },
      {
        id: 'lib-sad-moment',
        name: 'sad-moment-sad-and-melancholy-piano-background-music-124488.mp3',
        displayName: 'Sad Moment',
        genre: 'Classical',
        duration: 159,
        url: 'https://www.dropbox.com/scl/fi/mbm8geh0luwustak9smd2/sad-moment-sad-and-melancholy-piano-background-music-124488.mp3?rlkey=wsm1n1gt0osemzjejw07v43gp&st=619ztz7q&dl=1'
      },
      {
        id: 'lib-lullaby',
        name: 'lullaby-for-you-391546.mp3',
        displayName: 'Lullaby for You',
        genre: 'Classical',
        duration: 190,
        url: 'https://dl.dropboxusercontent.com/scl/fi/lullaby-for-you-391546.mp3'
      },
      {
        id: 'lib-instrumental-pop',
        name: 'instrumental-pop-339552.mp3',
        displayName: 'Instrumental Pop',
        genre: 'Classical',
        duration: 219,
        url: 'https://www.dropbox.com/scl/fi/thtksxggskeg4fwpbgtk2/instrumental-pop-339552.mp3?rlkey=2k3za21tttuyo819ywqf1md7l&st=15nt3hac&dl=1'
      },
      {
        id: 'lib-country-ballad',
        name: 'country-rodeo-cowboy-ballad-music-full-351039.mp3',
        displayName: 'Country Ballad',
        genre: 'Country',
        duration: 207,
        url: 'https://www.dropbox.com/scl/fi/eei0x2q4swzvkc0zxavnj/country-rodeo-cowboy-ballad-music-full-351039.mp3?rlkey=4dk26852xjegr6vc5cqxmc3kc&st=va434lvi&dl=1'
      }
    ];
    
    // Parse job ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const jobId = urlParams.get('job');
    const isFinalized = urlParams.get('finalized') === 'true';
    const isSharedView = urlParams.get('share') === 'true';
    
    // Track changes made by user
    let pendingChanges = {};
    let currentSettings = {};
    let currentSongs = [];
    let currentlyPlayingAudio = null;
    let newPptxFile = null;
    
    // Prevent going back if finalized
    if (isFinalized) {
      history.pushState(null, null, location.href);
      history.pushState(null, null, location.href);
      
      window.addEventListener('popstate', function(event) {
        history.pushState(null, null, location.href);
      });
    }
    
    if (!jobId) {
      showError('No job ID provided in URL. Please check your link.');
    } else {
      loadJobData(jobId);
    }
    
    // Render song library
    function renderLibrary() {
      const container = document.getElementById('libraryGrid');
      const selectedGenre = document.getElementById('genreSelect').value;
  
      // Filter songs by selected genre
      const filteredSongs = SONG_LIBRARY.filter(song => song.genre === selectedGenre);
  
      let html = '';
      filteredSongs.forEach(song => {
        const isAdded = currentSongs.some(s => s.id === song.id);
        const cardClass = isAdded ? 'library-song-card added' : 'library-song-card';
        const btnClass = isAdded ? 'btn-add-library added' : 'btn-add-library';
        const btnText = isAdded ? '‚úì Added' : '+ Add';
        const audioId = `audio-lib-${song.id}`;
    
        html += `
          <div class="${cardClass}" data-song-id="${song.id}">
            <div class="library-song-name">${song.displayName}</div>
            <div class="library-song-controls">
              <button class="btn-small btn-play" onclick="togglePlay('${audioId}', this)">‚ñ∂Ô∏è</button>
              <button class="${btnClass}" onclick="addLibrarySong('${song.id}')" ${isAdded || currentSongs.length >= MAX_SONGS ? 'disabled' : ''}>
                ${btnText}
              </button>
            </div>
            <audio id="${audioId}" src="${song.url}" preload="none"></audio>
          </div>
        `;
      });
  
      container.innerHTML = html;
    }
    
    // Add library song to current songs
    function addLibrarySong(songId) {
      if (currentSongs.length >= MAX_SONGS) {
        showToast(`Maximum ${MAX_SONGS} songs reached`, 'error');
        return;
      }
      
      const libSong = SONG_LIBRARY.find(s => s.id === songId);
      if (!libSong) return;
      
      // Check if already added
      if (currentSongs.some(s => s.id === songId)) {
        showToast('Song already added', 'error');
        return;
      }
      
      currentSongs.push({
        id: libSong.id,
        name: libSong.name,
        displayName: libSong.displayName,
        url: libSong.url,
        isNew: false,
        isLibrary: true,
        file: null,
        duration: libSong.duration
      });
      
      renderLibrary();
      renderSongList();
      updateSongCount();
      updateSongRangeSliders();
      calculateVideoDuration();
      showToast(`Added "${libSong.displayName}"`, 'success');
    }
    
    // Load job data from API
    async function loadJobData(jobId) {
      try {
        console.log('[API] Calling:', `${API_BASE}/jobs/${jobId}`);
        const response = await fetch(`${API_BASE}/jobs/${jobId}`);
    
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    
        const data = await response.json();
        console.log('[API] Response:', data);

        // Load version history
        await loadVersionHistory(jobId);
    
        // Store current settings
        if (data.settings) {
          currentSettings = data.settings;
          
          const deceasedName = data.settings.fullName;
          if (deceasedName && deceasedName !== 'your loved one' && deceasedName !== '') {
            document.getElementById('headerTitle').textContent = `‚ú® ${deceasedName}'s Memorial Video`;
            document.title = `${deceasedName}'s Memorial Video`;
          }

          displaySummary(data.settings);
        }
    
        // Initialize songs from API response
        if (data.songs && data.songs.length > 0) {
          currentSongs = data.songs.map(song => {
            // Check if this is a library song
            const libSong = SONG_LIBRARY.find(lib => lib.name === song.name);

            // ‚úÖ GET ORIGINAL FILENAME FROM SETTINGS
            const originalName = data.settings?.originalFilenames?.[song.name] || song.name;
            console.log(`[SONG MAP] ${song.name} -> originalName: ${originalName}`);
        
            return {
              id: libSong ? libSong.id : song.name,
              name: song.name,
              displayName: libSong ? libSong.displayName : originalName,
              url: song.url,
              isNew: false,
              isLibrary: !!libSong,
              file: null,
              duration: libSong ? libSong.duration : (song.duration || null)  // ‚úÖ ADD THIS LINE
            };
          });

          currentSongs.forEach(song => {
            if (!song.isLibrary && song.url) {
              const audio = new Audio(song.url);
              audio.addEventListener('loadedmetadata', () => {
                const duration = Math.round(audio.duration);
                song.duration = duration;
                console.log(`[DURATION LOADED] ${song.name}: ${duration}s`);
                calculateVideoDuration(); // Recalculate when duration loads
              });
              audio.addEventListener('error', (e) => {
                console.error(`[DURATION ERROR] Failed to load ${song.name}:`, e);
              });
            }
          });
        } else if (data.settings && data.settings.audioCount > 0) {
          const audioCount = data.settings.audioCount;
          for (let i = 1; i <= audioCount; i++) {
            currentSongs.push({
              id: `song${i}.mp3`,
              name: `song${i}.mp3`,
              displayName: `song${i}.mp3`,
              url: null,
              isNew: false,
              isLibrary: false,
              file: null
            });
          }
        }
    
        // ‚úÖ MOVED HERE: populate form defaults AFTER songs are loaded
        if (data.settings) {
          populateFormDefaults(data.settings);
        }
    
        // Auto-redirect to finalized page if job is already finalized
        if (data.isFinalized && !isFinalized) {
          console.log('[REDIRECT] Job is finalized, redirecting...');
          window.location.replace(`${window.location.origin}${window.location.pathname}?job=${jobId}&finalized=true`);
          return;
        }
    
        displayVideo(data);
        setupManualEditButtons(data);
        renderLibrary();
        renderSongList();
        updateSongCount();
      } catch (error) {
        console.error('[API ERROR]', error);
        showError('Failed to load video data: ' + error.message);
      }
    }

    // Load version history for this job
    async function loadVersionHistory(baseJobId) {
      try {
        console.log('[VERSIONS] Loading version history for:', baseJobId);
        const response = await fetch(`${API_BASE}/jobs/${baseJobId}/versions`);
    
        if (!response.ok) {
          console.warn('[VERSIONS] No version history available');
          return;
        }
    
        const versions = await response.json();
        console.log('[VERSIONS] Loaded:', versions);
    
        allVersions = versions;
        currentVersionIndex = versions.findIndex(v => v.jobId === baseJobId);
    
        if (versions.length > 1) {
          populateVersionDropdown();
        }
      } catch (error) {
        console.error('[VERSIONS ERROR]', error);
      }
    }

    // Populate version dropdown
    function populateVersionDropdown() {
      const selector = document.getElementById('versionSelector');
      const dropdown = document.getElementById('versionDropdown');
  
      if (allVersions.length <= 1) {
        selector.style.display = 'none';
        return;
      }
  
      let html = '';
      allVersions.forEach((version, index) => {
        const versionNum = version.version;
        const date = new Date(version.createdAt).toLocaleDateString();
        const isCurrent = version.jobId === jobId;
        html += `<option value="${index}" ${isCurrent ? 'selected' : ''}>
          v${versionNum} - ${date}${isCurrent ? ' (Current)' : ''}
        </option>`;
      });
  
      dropdown.innerHTML = html;
      selector.style.display = 'block';
  
      updateRevertButton();
    }

    // Update revert button visibility
    function updateRevertButton() {
      const revertBtn = document.getElementById('revertBtn');
      const dropdown = document.getElementById('versionDropdown');
      const selectedIndex = parseInt(dropdown.value);
  
      // Show revert button if viewing an older version
      if (selectedIndex !== currentVersionIndex) {
        revertBtn.style.display = 'inline-block';
      } else {
        revertBtn.style.display = 'none';
      }
    }
    
    // Display summary sentence
    function displaySummary(settings) {
      const summaryBox = document.getElementById('summaryBox');
      
      // Format duration
      let durationText = '';
      if (settings.timingMode === 'fixedRuntime' && settings.fixedRuntimeSec) {
        const minutes = Math.floor(settings.fixedRuntimeSec / 60);
        const seconds = settings.fixedRuntimeSec % 60;
        durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      } else if (settings.timingMode === 'perSlide' && settings.perSlideSec) {
        durationText = `${settings.perSlideSec}s per slide`;
      } else if (settings.timingMode === 'fitToSongs') {
        durationText = 'matched to music length';
      } else {
        durationText = 'custom timing';
      }
      
      // Timing mode display name
      const timingModeNames = {
        'fixedRuntime': 'Fixed Runtime',
        'perSlide': 'Per Slide Duration',
        'fitToSongs': 'Fit to Music'
      };
      const timingModeName = timingModeNames[settings.timingMode] || settings.timingMode;
      
      // Visual package display name
      const visualPackageNames = {
        'simple-fade-wipe': 'Simple Fade & Wipe',
        'pages-of-life': 'Pages of Life',
        'floating-frames': 'Floating Frames',
        'zoom-through': 'Zoom Through',
        'blinds-combs-bars': 'Blinds, Combs & Bars'
      };
      const visualPackageName = visualPackageNames[settings.visualPackage] || settings.visualPackage;
      
      // Music distribution display name
      const musicDistNames = {
        'evenlyDistributed': 'Evenly Distributed',
        'specifyPlacement': 'Specify Placement'
      };
      const musicDistName = musicDistNames[settings.musicDistribution] || settings.musicDistribution;
      
      // Build summary
      const audioCount = settings.audioCount || 3;
      summaryBox.innerHTML = `
        Your <strong>${durationText}</strong> video uses <strong>${timingModeName}</strong> mode with <strong>${visualPackageName}</strong> transitions and <strong>${audioCount} song${audioCount !== 1 ? 's' : ''}</strong> (${musicDistName}).
      `;
      
      summaryBox.style.display = 'block';
    }
    
    // Populate form defaults from settings
    function populateFormDefaults(settings) {
      // Transitions
      if (settings.visualPackage) {
        document.getElementById('visualPackage').value = settings.visualPackage;
      }
      
      // Timing
      if (settings.timingMode) {
        const radio = document.querySelector(`input[name="timingMode"][value="${settings.timingMode}"]`);
        if (radio) {
          radio.checked = true;
          handleTimingModeChange(settings.timingMode);
        }
      }
      if (settings.perSlideSec) {
        document.getElementById('perSlideSec').value = settings.perSlideSec;
      }
      if (settings.fixedRuntimeSec) {
        document.getElementById('fixedRuntimeSec').value = settings.fixedRuntimeSec;
      }
      
      // Song Logic
      if (settings.musicDistribution) {
        document.getElementById('musicDistribution').value = settings.musicDistribution;
        handleMusicDistributionChange(settings.musicDistribution);
      }
    }
    
    // Render song list
    function renderSongList() {
      const container = document.getElementById('songList');
      
      if (currentSongs.length === 0) {
        container.innerHTML = '<div style="color: #999; font-style: italic;">No songs selected. Choose from the library above or upload your own!</div>';
        return;
      }
      
      let html = '';
      currentSongs.forEach((song, index) => {
        const audioId = `audio-${song.id}`;
        const newBadge = song.isNew ? '<span class="song-badge">NEW</span>' : '';
        const libraryBadge = song.isLibrary ? '<span class="song-badge library">LIBRARY</span>' : '';
        
        let itemClass = 'song-item';
        if (song.isNew) itemClass += ' new-upload';
        if (song.isLibrary) itemClass += ' library-song';
        
        const position = index + 1;
        
        html += `
          <div class="${itemClass}">
            <div class="song-info">
              <div class="song-position">${position}</div>
              <span class="song-name">${song.displayName}</span>
              ${newBadge}
              ${libraryBadge}
            </div>
            <div class="song-controls">
              ${song.url ? `<button class="btn-small btn-play" onclick="togglePlay('${audioId}', this)">‚ñ∂Ô∏è</button>` : ''}
              <button class="btn-small btn-move" onclick="moveSongUp(${index})" ${index === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
              <button class="btn-small btn-move" onclick="moveSongDown(${index})" ${index === currentSongs.length - 1 ? 'disabled' : ''}>‚¨áÔ∏è</button>
              <button class="btn-small btn-danger" onclick="removeSong(${index})">üóëÔ∏è</button>
            </div>
            ${song.url ? `<audio id="${audioId}" src="${song.url}" preload="none"></audio>` : ''}
          </div>
        `;
      });
      
      container.innerHTML = html;
      updateSongTracking();
    }
    
    // Toggle audio play/pause
    function togglePlay(audioId, button) {
      const audio = document.getElementById(audioId);
      
      if (currentlyPlayingAudio && currentlyPlayingAudio !== audio) {
        currentlyPlayingAudio.pause();
        currentlyPlayingAudio.currentTime = 0;
        document.querySelectorAll('.btn-play').forEach(btn => {
          btn.textContent = '‚ñ∂Ô∏è';
          btn.classList.remove('playing');
        });
      }
      
      if (audio.paused) {
        audio.play();
        button.textContent = '‚è∏Ô∏è';
        button.classList.add('playing');
        currentlyPlayingAudio = audio;
        
        audio.onended = () => {
          button.textContent = '‚ñ∂Ô∏è';
          button.classList.remove('playing');
          currentlyPlayingAudio = null;
        };
      } else {
        audio.pause();
        audio.currentTime = 0;
        button.textContent = '‚ñ∂Ô∏è';
        button.classList.remove('playing');
        currentlyPlayingAudio = null;
      }
    }
    
    // Move song up
    function moveSongUp(index) {
      if (index === 0) return;
      const temp = currentSongs[index];
      currentSongs[index] = currentSongs[index - 1];
      currentSongs[index - 1] = temp;
      renderSongList();
      updateSongRangeSliders();
    }
    
    // Move song down
    function moveSongDown(index) {
      if (index === currentSongs.length - 1) return;
      const temp = currentSongs[index];
      currentSongs[index] = currentSongs[index + 1];
      currentSongs[index + 1] = temp;
      renderSongList();
      updateSongRangeSliders();
    }
    
    // Remove song
    function removeSong(index) {
      if (!confirm(`Remove "${currentSongs[index].displayName}"?`)) return;
      currentSongs.splice(index, 1);
      renderLibrary();
      renderSongList();
      updateSongCount();
      updateSongRangeSliders();
      calculateVideoDuration();
    }
      
    // Update song count display
    function updateSongCount() {
      const display = document.getElementById('songCountDisplay');
      const uploadSection = document.getElementById('uploadSection');
      const uploadLabel = document.getElementById('uploadLabel');
      
      display.textContent = `${currentSongs.length} of ${MAX_SONGS} songs`;
      
      if (currentSongs.length >= MAX_SONGS) {
        uploadSection.classList.add('max-reached');
        uploadLabel.classList.add('disabled');
      } else {
        uploadSection.classList.remove('max-reached');
        uploadLabel.classList.remove('disabled');
      }
      
      // Update library add buttons
      renderLibrary();
    }

    // ‚úÖ ADD THIS ENTIRE FUNCTION HERE
    // Calculate and display video duration
    function calculateVideoDuration() {
      const slideCountInput = document.getElementById('slideCount');
      const slideCount = parseInt(slideCountInput.value);
      const timingMode = document.querySelector('input[name="timingMode"]:checked')?.value;

      const displayDiv = document.getElementById('durationDisplay');
      const valueDiv = document.getElementById('durationValue');
      const detailsDiv = document.getElementById('durationDetails');

      console.log('[DURATION CALC] Slide count:', slideCount);
      console.log('[DURATION CALC] Timing mode:', timingMode);
      console.log('[DURATION CALC] Current songs:', currentSongs);
      
      // Hide if no slide count
      if (!slideCount || slideCount < 2) {
        displayDiv.style.display = 'none';
        return;
      }

      let totalSeconds = 0;
      let detailsText = '';

      if (timingMode === 'perSlide') {
        const perSlideSec = parseInt(document.getElementById('perSlideSec').value) || 5;
        totalSeconds = (slideCount - 2) * perSlideSec + (2 * perSlideSec * 2);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        detailsText = `Video will be ${timeDisplay} long with ${slideCount} slides at ${perSlideSec} seconds per slide (beginning and end slide at ${perSlideSec * 2}s)`;

      } else if (timingMode === 'fixedRuntime') {
        totalSeconds = parseInt(document.getElementById('fixedRuntimeSec').value) || 320;
        const avgPerSlide = Math.round(totalSeconds / slideCount);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        detailsText = `Video will be ${timeDisplay} long across ${slideCount} slides at approximately ${avgPerSlide} seconds per slide`;

      } else if (timingMode === 'fitToSongs') {
        console.log('[FIT TO SONGS] Calculating total duration...'); // ‚úÖ ADD THIS LINE
  
        totalSeconds = currentSongs.reduce((sum, song) => {
          console.log(`[FIT TO SONGS] Song: ${song.displayName}, Duration: ${song.duration}`); // ‚úÖ ADD THIS LINE TOO
          return sum + (song.duration || 0);
        }, 0);
  
        console.log('[FIT TO SONGS] Total seconds:', totalSeconds); // ‚úÖ AND THIS LINE

        if (totalSeconds === 0) {
          detailsText = 'Add songs to calculate duration';
          displayDiv.style.display = 'none';
          return;
        }

        const avgPerSlide = Math.round(totalSeconds / slideCount);
        const songWord = currentSongs.length === 1 ? 'song' : 'songs';
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        detailsText = `Video will be ${timeDisplay} long based on ${currentSongs.length} selected ${songWord} at ${avgPerSlide} seconds per slide (beginning and end slide at ${avgPerSlide * 2}s)`;
      }

      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;

      valueDiv.textContent = formattedTime;
      detailsDiv.textContent = detailsText;
      displayDiv.style.display = 'block';
    }
    
    // Handle new song uploads
    document.getElementById('newSongUpload').addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
  
      files.forEach(file => {
        if (currentSongs.length >= MAX_SONGS) {
          showToast(`Maximum ${MAX_SONGS} songs reached`, 'error');
          return;
        }
    
        if (!file.type.includes('audio/mpeg') && !file.name.endsWith('.mp3')) {
          showToast(`${file.name} is not an MP3 file`, 'error');
          return;
        }
    
        const localUrl = URL.createObjectURL(file);
    
        // ‚úÖ CREATE AUDIO ELEMENT TO DETECT DURATION
        const audio = new Audio(localUrl);
        audio.addEventListener('loadedmetadata', () => {
          const duration = Math.round(audio.duration);
      
        // Find the song and update its duration
        const song = currentSongs.find(s => s.url === localUrl);
        if (song) {
          song.duration = duration;
          console.log(`[DURATION] ${file.name}: ${duration}s`);
          calculateVideoDuration(); // Recalculate after getting duration
        }
      });
    
      currentSongs.push({
        id: `new-${Date.now()}-${Math.random()}`,
        name: file.name,
        displayName: file.name,
        url: localUrl,
        isNew: true,
        isLibrary: false,
        file: file,
        duration: null  // ‚úÖ ADD THIS - Will be set when metadata loads
      });
    });
  
    renderSongList();
    updateSongCount();
    updateSongRangeSliders();
    calculateVideoDuration();  // ‚úÖ ADD THIS
  
    e.target.value = '';
  });
    document.getElementById('genreSelect').addEventListener('change', () => {
      renderLibrary();
    });

    // Version dropdown change handler
    document.getElementById('versionDropdown').addEventListener('change', async (e) => {
      updateRevertButton();
  
      const selectedIndex = parseInt(e.target.value);
      const selectedVersion = allVersions[selectedIndex];
  
      if (!selectedVersion) return;
  
      console.log('[VERSIONS] Switching to version:', selectedVersion.jobId);
  
      // Reload page with selected version's jobId
      const newUrl = `${window.location.origin}${window.location.pathname}?job=${selectedVersion.jobId}`;
      window.location.href = newUrl;
    });

    // Revert button handler
    document.getElementById('revertBtn').addEventListener('click', async () => {
      const dropdown = document.getElementById('versionDropdown');
      const selectedIndex = parseInt(dropdown.value);
      const selectedVersion = allVersions[selectedIndex];
  
      if (!selectedVersion) return;
  
      const versionNum = selectedVersion.version;
      const confirmed = confirm(
        `Revert to version ${versionNum}?\n\n` +
        'This will create a new version based on the settings from this previous version. ' +
        'You can always switch back to any version later.'
      );
  
      if (!confirmed) return;
  
      try {
        showToast('Creating new version from v' + versionNum + '...', 'success');
    
        // Submit as a resubmission using the old version's settings
        const response = await fetch(`${API_BASE}/jobs/${jobId}/resubmit`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            originalJobId: jobId,
            revertToJobId: selectedVersion.jobId,
            changes: selectedVersion.settings
          })
        });
    
        if (!response.ok) {
          throw new Error('Failed to revert version');
        }
    
        const result = await response.json();
        console.log('[REVERT] Success:', result);
    
        showToast(
          `‚úÖ Successfully created new version from v${versionNum}! ` +
          'You\'ll receive an email in 5-15 minutes.',
          'success'
        );
    
        // Reload after 2 seconds
        setTimeout(() => {
          location.reload();
        }, 2000);
    
      } catch (error) {
        console.error('[REVERT ERROR]', error);
        showToast('Failed to revert: ' + error.message, 'error');
      }
    });
    
    // Handle PowerPoint file upload
    document.getElementById('newPptxUpload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      
      if (!file) return;
      
      if (!file.name.endsWith('.pptx') && !file.type.includes('presentationml')) {
        showToast('Please select a valid PowerPoint (.pptx) file', 'error');
        e.target.value = '';
        return;
      }
      
      newPptxFile = file;
      
      const previewDiv = document.getElementById('pptxFilePreview');
      const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
      
      previewDiv.innerHTML = `
        <div class="pptx-file-preview">
          <div class="pptx-file-info">
            <span class="pptx-file-icon">üìÑ</span>
            <div class="pptx-file-details">
              <span class="pptx-file-name">${file.name}</span>
              <span class="pptx-file-size">${fileSizeMB} MB</span>
            </div>
          </div>
          <button class="btn-small btn-danger" onclick="clearPptxUpload()">üóëÔ∏è Remove</button>
        </div>
      `;
      previewDiv.style.display = 'block';
      
      trackChange('newPresentationFile', true);
      showToast('PowerPoint file ready to upload!', 'success');
    });
    
    // Clear PowerPoint upload
    function clearPptxUpload() {
      newPptxFile = null;
      document.getElementById('newPptxUpload').value = '';
      document.getElementById('pptxFilePreview').style.display = 'none';
      delete pendingChanges.newPresentationFile;
      updateResubmitButton();
      showToast('PowerPoint file removed', 'success');
    }
    
    // Track song changes for resubmit
    function updateSongTracking() {
      // ‚úÖ USE DISPLAYNAME WHICH HAS THE ORIGINAL FILENAME
      const songOrder = currentSongs.map(song => {
        // For existing songs from previous submission, use the displayName (which is the original filename)
        // For new songs, use the actual filename
        if (song.isNew && song.file) {
          return song.file.name;
        } else if (song.isLibrary) {
          return song.name; // Library songs use their actual filename
        } else {
          // Existing custom song - use displayName which has the original filename
          return song.displayName;
        }
      });
  
      const newSongs = currentSongs.filter(s => s.isNew).map(s => ({
        originalName: s.file ? s.file.name : s.name,
        file: s.file
      }));
  
      const hasChanges = currentSongs.some(s => s.isNew) || 
                        JSON.stringify(songOrder) !== JSON.stringify(currentSongs.map(s => s.name));
  
      if (hasChanges || newSongs.length > 0) {
        trackChange('songOrder', songOrder);
        if (newSongs.length > 0) {
          trackChange('newSongs', newSongs);
        }
     }
  }
    
    // Setup song range sliders
    function setupSongRangeSliders() {
      const container = document.getElementById('songRangesList');
  
      if (currentSongs.length === 0) {
        container.innerHTML = '<div style="color: #999; font-style: italic;">No songs available. Add songs first.</div>';
        return;
      }
  
      let html = '';
      currentSongs.forEach((song, index) => {
        const audioId = `audio-range-${song.id}`;
        const playButton = song.url ? `<button class="btn-small btn-play" onclick="togglePlay('${audioId}', this)" style="margin-left: 8px;">‚ñ∂Ô∏è</button>` : '';
    
        // Auto-populate start value: first song starts at 1, others start at previous end + 1
        const startValue = index === 0 ? '1' : '';
    
        html += `
          <div class="song-range-item">
            <div class="song-range-header">
              üéµ ${song.displayName}
              ${playButton}
              ${song.url ? `<audio id="${audioId}" src="${song.url}" preload="none"></audio>` : ''}
            </div>
            <div class="slide-inputs">
              <div class="slide-input-group">
                <label>Start Slide</label>
                <input type="number" 
                       id="songRange${index}Start" 
                       class="song-range-input"
                       data-song-index="${index}"
                       data-type="start"
                       min="1" 
                       max="250"
                       value="${startValue}"
                       placeholder="e.g., 1">
              </div>
              <div class="slide-input-group">
                <label>End Slide</label>
                <input type="number" 
                       id="songRange${index}End" 
                       class="song-range-input"
                       data-song-index="${index}"
                       data-type="end"
                       min="1" 
                       max="250" 
                       placeholder="e.g., 50">
              </div>
           </div>
        </div>
      `;
    });
  
    container.innerHTML = html;
  
    document.querySelectorAll('.song-range-input').forEach(input => {
      input.addEventListener('input', handleSongRangeChange);
    });
  }
    
    // Update song range sliders (wrapper for setup)
    function updateSongRangeSliders() {
      const musicDist = document.getElementById('musicDistribution').value;
      
      if (musicDist === 'specifyPlacement') {
        setupSongRangeSliders();
      }
    }
    
    // Handle song range input changes
    function handleSongRangeChange(e) {
      const changedIndex = parseInt(e.target.dataset.songIndex);
      const changedType = e.target.dataset.type;
  
      // If an "End Slide" changed, update the next song's start slide
      if (changedType === 'end' && changedIndex < currentSongs.length - 1) {
        const endValue = parseInt(e.target.value);
        if (!isNaN(endValue)) {
          const nextStartInput = document.getElementById(`songRange${changedIndex + 1}Start`);
          if (nextStartInput) {
            nextStartInput.value = endValue + 1;
          }
        }
     }
  
     // Rebuild songRanges array
     const songRanges = [];

     currentSongs.forEach((song, index) => {
       const startInput = document.getElementById(`songRange${index}Start`);
       const endInput = document.getElementById(`songRange${index}End`);

       if (startInput && endInput) {
         const startVal = parseInt(startInput.value);
         const endVal = parseInt(endInput.value);
  
         if (!isNaN(startVal) && !isNaN(endVal)) {
           // FIX: For uploaded songs, extract filename from S3 URL
           // For library songs, use the original name
           let songIdentifier = song.name;
        
           if (!song.isLibrary && song.url && song.url.startsWith('blob:')) {
             // New upload with blob URL - use the original filename
             songIdentifier = song.name;
           } else if (!song.isLibrary && song.url && song.url.includes('/temp-uploads/')) {
             // Previously uploaded song - extract filename from S3 URL
             songIdentifier = song.url.split('/').pop();
             console.log(`[SONG RANGE] Mapped uploaded song: ${song.name} -> ${songIdentifier}`);
           }
        
           songRanges.push({
             song: songIdentifier,
             startSlide: startVal,
             endSlide: endVal
           });
         }
       }
     });

     if (songRanges.length > 0) {
       trackChange('songRanges', songRanges);
     } else {
       delete pendingChanges.songRanges;
       updateResubmitButton();
     }

     console.log('[SONG RANGES]', songRanges);
   }
    
    // Handle music distribution change
    function handleMusicDistributionChange(value) {
      const container = document.getElementById('songRangesContainer');
      
      if (value === 'specifyPlacement') {
        container.style.display = 'block';
        setupSongRangeSliders();
      } else {
        container.style.display = 'none';
        delete pendingChanges.songRanges;
        updateResubmitButton();
      }
    }
    
    // Setup manual edit buttons based on presentation type
    function setupManualEditButtons(data) {
      const container = document.getElementById('manualEditButtons');
      const infoBox = document.getElementById('manualEditInfoBox');
      const pptxUploadSection = document.getElementById('pptxUploadSection');
      
      if (data.provider === 'google_slides') {
        infoBox.innerHTML = 'Select to edit your <strong>Google Slides</strong> to make manual changes, and once you are done you may select "Resubmit Changes" at the bottom along with any other changes you made. This version will be published in the next Video.';
        pptxUploadSection.style.display = 'none';
      } else if (data.provider === 'powerpoint') {
        infoBox.innerHTML = 'Select to edit your <strong>PowerPoint</strong> to make manual changes, or upload a new PowerPoint file below. Once you are done, select "Resubmit Changes" at the bottom along with any other changes you made. This version will be published in the next Video.';
        pptxUploadSection.style.display = 'block';
      }
      
      if (data.provider === 'google_slides' && data.original_url) {
        container.innerHTML = `
          <button class="btn btn-primary" onclick="handleManualEditClick('${data.original_url}')">
            üìä Edit Google Slides
          </button>
        `;
      } else if (data.provider === 'powerpoint' && data.original_url) {
        container.innerHTML = `
          <button class="btn btn-primary" onclick="handleManualEditClick('${data.original_url}')">
            üìÑ Edit PowerPoint
          </button>
        `;
      } else {
        container.innerHTML = `
          <div style="color: #999; font-style: italic;">
            Presentation link not available for this job.
          </div>
        `;
      }
    }
    
    // Handle manual edit button click
    function handleManualEditClick(url) {
      window.open(url, '_blank');
      trackChange('manualEditsRequested', true);
      showToast('Presentation opened! Make your changes, then click "Resubmit Changes" when done.', 'success');
    }
    
    // Display video and controls
    function displayVideo(data) {
      const container = document.getElementById('videoContainer');
      const jobInfo = document.getElementById('jobInfo');
      
      jobInfo.textContent = `Order #${data.jobId}`;
      
      if (isFinalized) {
        container.innerHTML = `
          <div class="video-wrapper">
            <video controls preload="auto">
              <source src="${data.videoUrl}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>
        `;
        
        document.getElementById('actionButtons').style.display = 'none';
        document.getElementById('finalizedMessage').style.display = 'block';
        document.getElementById('finalDownloadBtn').href = data.downloadUrl || data.videoUrl;
        return;
      }
      
      container.innerHTML = `
        <div class="video-wrapper">
          <video controls preload="auto" crossorigin="anonymous">
            <source src="${data.videoUrl}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        </div>
      `;
      
      const video = container.querySelector('video');
      video.addEventListener('loadstart', () => console.log('[VIDEO] Loading started'));
      video.addEventListener('loadedmetadata', () => console.log('[VIDEO] Metadata loaded'));
      video.addEventListener('canplay', () => console.log('[VIDEO] Can play'));
      video.addEventListener('error', (e) => {
        console.error('[VIDEO ERROR]', e);
        console.error('[VIDEO ERROR] Details:', video.error);
        showError('Video failed to load. The file may be corrupted or the URL expired.');
      });
      
      document.getElementById('editBtn').style.display = 'inline-flex';
      document.getElementById('shareBtn').style.display = 'inline-flex';
      document.getElementById('deliverBtn').style.display = 'inline-flex';
      document.getElementById('helpBtn').style.display = 'inline-flex';
      document.getElementById('finalizeBtn').style.display = 'inline-flex';
      
      window.videoData = data;
      
      setupFinalizeButton();
      setupEditButton();
    }
    
    // Show error message
    function showError(message) {
      const container = document.getElementById('videoContainer');
      container.innerHTML = `<div class="error">${message}</div>`;
    }
    
    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }
    
    // Edit button handler
    function setupEditButton() {
      document.getElementById('editBtn').addEventListener('click', () => {
        const editSections = document.getElementById('editSections');
        const isVisible = editSections.style.display !== 'none';
        
        if (isVisible) {
          editSections.style.display = 'none';
          document.getElementById('editBtn').innerHTML = '‚úèÔ∏è Edit & Republish My Video (unlimited submissions)';
        } else {
          editSections.style.display = 'block';
          document.getElementById('editBtn').innerHTML = '‚ùå Hide Edit Options';
          editSections.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }
    
    // Finalize button handler
    function setupFinalizeButton() {
      document.getElementById('finalizeBtn').addEventListener('click', async () => {
        const confirmed = confirm(
          "Are you sure? You won't be able to make anymore edits to the final video. " +
          "You will also be emailed a final copy as a backup."
        );
        
        if (!confirmed) return;
        
        try {
          const downloadUrl = window.videoData.downloadUrl || window.videoData.videoUrl;
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = `memorial_video_${jobId}.mp4`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          showToast('Finalizing your order...', 'success');
          const response = await fetch(`${API_BASE}/jobs/${jobId}/finalize`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error('Failed to finalize order');
          }
          
          const finalizedUrl = `${window.location.origin}${window.location.pathname}?job=${jobId}&finalized=true`;
          history.replaceState(null, '', finalizedUrl);
          location.reload();
          
        } catch (error) {
          console.error('[FINALIZE ERROR]', error);
          showToast('Download started, but email failed. Please contact support.', 'error');
        }
      });
    }
    
    // Share button handler
    document.getElementById('shareBtn').addEventListener('click', async () => {
      openShareModal();
    });

    // Deliver to Coordinator button handler
    document.getElementById('deliverBtn').addEventListener('click', () => {
      openDeliverModal();
    });

    // Open deliver modal
    function openDeliverModal() {
      document.getElementById('deliverModal').classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    // Close deliver modal
    function closeDeliverModal() {
      document.getElementById('deliverModal').classList.remove('show');
      document.body.style.overflow = 'auto';
      document.getElementById('deliverForm').reset();
      document.querySelectorAll('.modal-form-group input').forEach(input => {
        input.classList.remove('error');
      });
    }

    // Submit delivery
    async function submitDelivery() {
      const firstName = document.getElementById('coordFirstName').value.trim();
      const lastName = document.getElementById('coordLastName').value.trim();
      const orgName = document.getElementById('coordOrgName').value.trim();
      const email = document.getElementById('coordEmail').value.trim();
  
     // Validation
     let hasError = false;
  
     if (!firstName) {
       document.getElementById('coordFirstName').classList.add('error');
       hasError = true;
     } else {
       document.getElementById('coordFirstName').classList.remove('error');
     }
  
     if (!lastName) {
       document.getElementById('coordLastName').classList.add('error');
       hasError = true;
     } else {
       document.getElementById('coordLastName').classList.remove('error');
     }
  
     if (!orgName) {
       document.getElementById('coordOrgName').classList.add('error');
       hasError = true;
     } else {
       document.getElementById('coordOrgName').classList.remove('error');
     }
  
     if (!email || !email.includes('@')) {
       document.getElementById('coordEmail').classList.add('error');
       hasError = true;
     } else {
       document.getElementById('coordEmail').classList.remove('error');
     }
  
     if (hasError) {
       showToast('Please fill in all required fields correctly', 'error');
       return;
     }
  
     const submitBtn = document.getElementById('deliverSubmitBtn');
     submitBtn.disabled = true;
     submitBtn.textContent = 'üì§ Sending...';
  
     try {
       console.log('[DELIVER] Sending to coordinator:', {
         jobId,
         firstName,
         lastName,
         orgName,
         email
      });
    
      // Real API call
      const response = await fetch(`${API_BASE}/jobs/${jobId}/deliver-to-coordinator`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
        firstName: firstName,
        lastName: lastName,
        orgName: orgName,
        email: email
      })
    });

if (!response.ok) {
  const errorData = await response.json();
  throw new Error(errorData.error || 'Failed to deliver video');
}

const result = await response.json();
console.log('[DELIVER] Success:', result);

showToast('‚úÖ Video successfully delivered to ' + email, 'success');
closeDeliverModal();
    
    } catch (error) {
      console.error('[DELIVER ERROR]', error);
      showToast('Failed to deliver video: ' + error.message, 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'üì§ Send to Coordinator';
    }
  }

  // Close modal when clicking outside
  document.getElementById('deliverModal').addEventListener('click', (e) => {
    if (e.target.id === 'deliverModal') {
      closeDeliverModal();
    }
  });
    
  // Help Needed button handler
  document.getElementById('helpBtn').addEventListener('click', () => {
    openHelpModal();
  });

  // Open help modal
  function openHelpModal() {
    document.getElementById('helpModal').classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  // Close help modal
  function closeHelpModal() {
    document.getElementById('helpModal').classList.remove('show');
    document.body.style.overflow = 'auto';
    document.getElementById('helpForm').reset();
    document.querySelectorAll('#helpForm .modal-form-group input').forEach(input => {
      input.classList.remove('error');
    });
  }

  // Submit help request
  async function submitHelp() {
    const firstName = document.getElementById('helpFirstName').value.trim();
    const lastName = document.getElementById('helpLastName').value.trim();
    const email = document.getElementById('helpEmail').value.trim();

    // Validation
    let hasError = false;

    if (!firstName) {
      document.getElementById('helpFirstName').classList.add('error');
      hasError = true;
    } else {
      document.getElementById('helpFirstName').classList.remove('error');
    }

    if (!lastName) {
      document.getElementById('helpLastName').classList.add('error');
      hasError = true;
    } else {
      document.getElementById('helpLastName').classList.remove('error');
    } 

    if (!email || !email.includes('@')) {
      document.getElementById('helpEmail').classList.add('error');
      hasError = true;
    } else {
      document.getElementById('helpEmail').classList.remove('error');
    }

    if (hasError) {
      showToast('Please fill in all required fields correctly', 'error');
      return;
    }

    const submitBtn = document.getElementById('helpSubmitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = '‚úâÔ∏è Sending...';

    try {
      console.log('[HELP] Sending help request:', {
        jobId,
        firstName,
        lastName,
        email
      });

      // Real API call
      const response = await fetch(`${API_BASE}/jobs/${jobId}/request-help`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
        firstName: firstName,
        lastName: lastName,
        email: email
      })
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to send help request');
    }

    const result = await response.json();
    console.log('[HELP] Success:', result);

    showToast('‚úÖ Help request form sent to ' + email, 'success');
    closeHelpModal();

    } catch (error) {
      console.error('[HELP ERROR]', error);
      showToast('Failed to send help request: ' + error.message, 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = '‚úâÔ∏è Send me a help request form';
    }
  }

  // Close modal when clicking outside
  document.getElementById('helpModal').addEventListener('click', (e) => {
    if (e.target.id === 'helpModal') {
      closeHelpModal();
    }
  });

  // Share Modal Functions
  let recipientCount = 0;
  let recipients = [];

  // Open share modal
  function openShareModal() {
    document.getElementById('shareModal').classList.add('show');
    document.body.style.overflow = 'hidden';
  
    // Initialize with one recipient if empty
    if (recipientCount === 0) {
      addRecipient();
    }
  }

  // Close share modal
  function closeShareModal() {
    document.getElementById('shareModal').classList.remove('show');
    document.body.style.overflow = 'auto';
  
    // Reset recipients
    recipientCount = 0;
    recipients = [];
    document.getElementById('recipientsList').innerHTML = '';
  }

  // Add recipient
  function addRecipient() {
    recipientCount++;
    const recipientId = `recipient-${recipientCount}`;
  
    const recipientHtml = `
      <div class="recipient-item ${recipientCount === 1 ? '' : 'last'}" id="${recipientId}">
        <div class="recipient-number">${recipientCount}</div>
        ${recipientCount > 1 ? `<button type="button" class="recipient-remove" onclick="removeRecipient('${recipientId}')">√ó</button>` : ''}
        <div class="recipient-fields">
          <div class="modal-form-row">
            <div class="modal-form-group">
              <label>First Name<span class="required">*</span></label>
              <input type="text" id="${recipientId}-firstName" required placeholder="Jane" class="recipient-input">
            </div>
            <div class="modal-form-group">
              <label>Last Name<span class="required">*</span></label>
              <input type="text" id="${recipientId}-lastName" required placeholder="Smith" class="recipient-input">
            </div>
          </div>
          <div class="modal-form-group">
            <label>Email Address<span class="required">*</span></label>
            <input type="email" id="${recipientId}-email" required placeholder="jane@example.com" class="recipient-input">
          </div>
        </div>
      </div>
    `;
  
    // Remove 'last' class from all items
    document.querySelectorAll('.recipient-item').forEach(item => {
      item.classList.remove('last');
    });
  
    document.getElementById('recipientsList').insertAdjacentHTML('beforeend', recipientHtml);
  
    // Add 'last' class to the newly added item
    document.getElementById(recipientId).classList.add('last');
  }

  // Remove recipient
  function removeRecipient(recipientId) {
    const item = document.getElementById(recipientId);
    if (item) {
      item.remove();
      recipientCount--;
    
      // Renumber remaining recipients
      const items = document.querySelectorAll('.recipient-item');
      items.forEach((item, index) => {
        const number = item.querySelector('.recipient-number');
        if (number) {
          number.textContent = index + 1;
        }
      
        // Add 'last' class only to the last item
        item.classList.remove('last');
        if (index === items.length - 1) {
          item.classList.add('last');
        }
      });
    }
  }

  // Submit share
  async function submitShare() {
    const recipientItems = document.querySelectorAll('.recipient-item');
    const recipientData = [];
    let hasError = false;
  
    recipientItems.forEach(item => {
      const id = item.id;
      const firstName = document.getElementById(`${id}-firstName`);
      const lastName = document.getElementById(`${id}-lastName`);
      const email = document.getElementById(`${id}-email`);
    
      // Validation
      if (!firstName.value.trim()) {
        firstName.classList.add('error');
        hasError = true;
      } else {
        firstName.classList.remove('error');
      }
    
      if (!lastName.value.trim()) {
        lastName.classList.add('error');
        hasError = true;
      } else {
        lastName.classList.remove('error');
      }
    
      if (!email.value.trim() || !email.value.includes('@')) {
        email.classList.add('error');
        hasError = true;
      } else {
        email.classList.remove('error');
      }
    
      if (firstName.value.trim() && lastName.value.trim() && email.value.trim()) {
        recipientData.push({
          firstName: firstName.value.trim(),
          lastName: lastName.value.trim(),
          email: email.value.trim()
        });
      }
    });
  
    if (hasError) {
      showToast('Please fill in all required fields correctly', 'error');
      return;
    }
  
    if (recipientData.length === 0) {
      showToast('Please add at least one recipient', 'error');
      return;
    }
  
    const submitBtn = document.getElementById('shareSubmitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'üì§ Sending...';
  
    try {
      console.log('[SHARE] Sending invitations to:', {
        jobId,
        recipients: recipientData
      });
    
      // Real API call
      const response = await fetch(`${API_BASE}/jobs/${jobId}/share-with-recipients`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          recipients: recipientData
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to send invitations');
      }

      const result = await response.json();
      console.log('[SHARE] Success:', result);

      const recipientCount = recipientData.length;
      const recipientWord = recipientCount === 1 ? 'recipient' : 'recipients';
      showToast(`‚úÖ Invitations sent to ${recipientCount} ${recipientWord}`, 'success');
      closeShareModal();
    
    } catch (error) {
      console.error('[SHARE ERROR]', error);
      showToast('Failed to send invitations: ' + error.message, 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'üì§ Send Invitations';
    }
  }

  // Close modal when clicking outside
  document.getElementById('shareModal').addEventListener('click', (e) => {
    if (e.target.id === 'shareModal') {
      closeShareModal();
    }
  });
    
    // Edit section expansion
    document.querySelectorAll('.edit-option-header').forEach(header => {
      header.addEventListener('click', () => {
        const option = header.closest('.edit-option');
        option.classList.toggle('expanded');
      });
    });
    
    // Track form changes
    function trackChange(fieldName, value) {
      if (value === '' || value === null || value === undefined) {
        delete pendingChanges[fieldName];
      } else {
        pendingChanges[fieldName] = value;
      }
      updateResubmitButton();
      console.log('[CHANGES]', pendingChanges);
    }
    
    // Update resubmit button state
    function updateResubmitButton() {
      const btn = document.getElementById('resubmitBtn');
      const hasChanges = Object.keys(pendingChanges).length > 0;
      btn.disabled = !hasChanges;
      
      if (hasChanges) {
        btn.textContent = `üöÄ Resubmit Changes (${Object.keys(pendingChanges).length})`;
      } else {
        btn.textContent = 'üöÄ Resubmit Changes';
      }
    }
    
    // Setup change tracking for all form elements
    document.getElementById('visualPackage').addEventListener('change', (e) => {
      trackChange('visualPackage', e.target.value);
    });
    
    document.querySelectorAll('input[name="timingMode"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const mode = e.target.value;
        handleTimingModeChange(mode);
        trackChange('timingMode', mode);
        
        if (mode === 'perSlide') {
          trackChange('perSlideSec', document.getElementById('perSlideSec').value);
        } else if (mode === 'fixedRuntime') {
          trackChange('fixedRuntimeSec', document.getElementById('fixedRuntimeSec').value);
        }

        calculateVideoDuration();
      });
    });
    
    function handleTimingModeChange(mode) {
      document.getElementById('perSlideInput').style.display = 'none';
      document.getElementById('fixedRuntimeInput').style.display = 'none';
      
      document.querySelectorAll('.radio-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      const selectedRadio = document.querySelector(`input[name="timingMode"][value="${mode}"]`);
      if (selectedRadio) {
        selectedRadio.closest('.radio-option').classList.add('selected');
        
        if (mode === 'perSlide') {
          document.getElementById('perSlideInput').style.display = 'block';
        } else if (mode === 'fixedRuntime') {
          document.getElementById('fixedRuntimeInput').style.display = 'block';
        }
      }
    }
    
    document.getElementById('perSlideSec').addEventListener('input', (e) => {
      trackChange('perSlideSec', parseFloat(e.target.value));
      calculateVideoDuration();
    });
    
    document.getElementById('fixedRuntimeSec').addEventListener('input', (e) => {
      trackChange('fixedRuntimeSec', parseFloat(e.target.value));
      calculateVideoDuration();
    });

    document.getElementById('slideCount').addEventListener('input', calculateVideoDuration);
    
    document.getElementById('musicDistribution').addEventListener('change', (e) => {
      const value = e.target.value;
      trackChange('musicDistribution', value);
      handleMusicDistributionChange(value);
    });
    
    // Resubmit button handler
    document.getElementById('resubmitBtn').addEventListener('click', async () => {
      if (Object.keys(pendingChanges).length === 0) {
        showToast('No changes to submit', 'error');
        return;
      }
      
      const confirmed = confirm(
        `Create a new video with ${Object.keys(pendingChanges).length} change(s)?\n\n` +
        'You will receive an email in 5-15 minutes with your new video.'
      );
      
      if (!confirmed) return;
      
      try {
        showToast('Uploading files...', 'success');
        console.log('[RESUBMIT] Preparing submission...');
        
        // Build COMPLETE settings (not just deltas)
        const completeSettings = {
          ...currentSettings,
          timingMode: document.querySelector('input[name="timingMode"]:checked')?.value || currentSettings.timingMode || 'perSlide',
          perSlideSec: parseFloat(document.getElementById('perSlideSec').value) || currentSettings.perSlideSec || 5,
          fixedRuntimeSec: parseFloat(document.getElementById('fixedRuntimeSec').value) || currentSettings.fixedRuntimeSec || 350,
          visualPackage: document.getElementById('visualPackage').value || currentSettings.visualPackage || 'simple-fade-wipe',
          musicDistribution: document.getElementById('musicDistribution').value || currentSettings.musicDistribution || 'evenlyDistributed',
          jobId: undefined,
          originalJobId: undefined,
          songOrder: currentSongs.map(s => s.name),
          audioCount: currentSongs.length
        };
        
        // Remove undefined fields
        Object.keys(completeSettings).forEach(key => {
          if (completeSettings[key] === undefined) {
            delete completeSettings[key];
          }
        });

        // ‚úÖ ONLY ADD SONG RANGES IF musicDistribution is specifyPlacement AND they exist in pendingChanges
        if (completeSettings.musicDistribution === 'specifyPlacement' && pendingChanges.songRanges && pendingChanges.songRanges.length > 0) {
          completeSettings.songRanges = pendingChanges.songRanges;
          console.log('[RESUBMIT] Including songRanges:', pendingChanges.songRanges);
        } else {
          // ‚úÖ EXPLICITLY REMOVE songRanges if not using specifyPlacement
          delete completeSettings.songRanges;
          console.log('[RESUBMIT] Removed songRanges (not using specifyPlacement)');
        }

        console.log('[RESUBMIT] Complete settings:', completeSettings);
        
        const submitData = {
          originalJobId: jobId,
          changes: completeSettings
        };

        // ‚úÖ ADD THIS BLOCK:
        if (isSharedView) {
          const sharedByEmail = urlParams.get('email');
          const sharedByName = urlParams.get('name');
  
          submitData.sharedBy = {
            email: sharedByEmail,
            name: sharedByName
        };
      }
        
        // STEP 1: Upload PowerPoint file to S3 if present
        if (newPptxFile) {
          console.log('[UPLOAD] Getting presigned URL for PowerPoint...');
          
          const urlResponse = await fetch(`${API_BASE}/generate-upload-url`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              jobId: jobId,
              fileType: 'presentation',
              fileExtension: 'pptx'
            })
          });
          
          if (!urlResponse.ok) throw new Error('Failed to get PowerPoint upload URL');
          
          const {uploadUrl, s3Key} = await urlResponse.json();
          
          console.log('[UPLOAD] Uploading PowerPoint to S3...');
          
          const uploadResponse = await fetch(uploadUrl, {
            method: 'PUT',
            headers: {'Content-Type': 'application/vnd.openxmlformats-officedocument.presentationml.presentation'},
            body: newPptxFile
          });
          
          if (!uploadResponse.ok) throw new Error('Failed to upload PowerPoint');
          
          submitData.changes.newPresentationS3Key = s3Key;
          console.log('[UPLOAD] PowerPoint uploaded successfully');
        }
        
        // STEP 2: Upload new songs to S3 if present
        const newSongFiles = currentSongs.filter(s => s.isNew && s.file);
        
        if (newSongFiles.length > 0) {
          const uploadedSongs = [];
          
          for (let i = 0; i < newSongFiles.length; i++) {
            const song = newSongFiles[i];
            
            console.log(`[UPLOAD] Getting presigned URL for song ${i + 1}...`);
            
            const urlResponse = await fetch(`${API_BASE}/generate-upload-url`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                jobId: jobId,
                fileType: 'song',
                fileNumber: i + 1,
                fileExtension: 'mp3'
              })
            });
            
            if (!urlResponse.ok) throw new Error(`Failed to get upload URL for song ${i + 1}`);
            
            const {uploadUrl, s3Key} = await urlResponse.json();
            
            console.log(`[UPLOAD] Uploading song ${i + 1} to S3...`);
            
            const uploadResponse = await fetch(uploadUrl, {
              method: 'PUT',
              headers: {'Content-Type': 'audio/mpeg'},
              body: song.file
            });
            
            if (!uploadResponse.ok) throw new Error(`Failed to upload song ${i + 1}`);
            
            uploadedSongs.push({
              originalName: song.name,
              s3Key: s3Key
            });
            
            console.log(`[UPLOAD] Song ${i + 1} uploaded successfully`);
          }
          
          submitData.changes.newSongs = uploadedSongs;
          console.log('[UPLOAD] All songs uploaded');
        }
        
        // Add manualEditsRequested flag if it was set
        if (pendingChanges.manualEditsRequested) {
          submitData.changes.manualEditsRequested = true;
        }
        
        // STEP 3: Submit metadata to resubmit API
        console.log('[RESUBMIT] Submitting to API...');
        console.log('[RESUBMIT] Payload:', JSON.stringify(submitData, null, 2));
        showToast('Processing changes...', 'success');
        
        const response = await fetch(`${API_BASE}/jobs/${jobId}/resubmit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(submitData)
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || errorData.details || `HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('[RESUBMIT] Success:', result);
        
        showToast(
          `‚úÖ Video resubmitted successfully! New job: ${result.newJobId}. ` +
          'You\'ll receive an email in 5-15 minutes.',
          'success'
        );
        
        // Clear changes and disable button
        pendingChanges = {};
        newPptxFile = null;
        updateResubmitButton();
        
        // Hide edit sections after 2 seconds
        setTimeout(() => {
          document.getElementById('editSections').style.display = 'none';
          document.getElementById('editBtn').innerHTML = '‚úèÔ∏è Edit & Republish My Video (unlimited submissions)';
        }, 2000);
        
      } catch (error) {
        console.error('[RESUBMIT ERROR]', error);
        showToast('Failed to resubmit: ' + error.message, 'error');
      }
    });
  </script>
</body>
</html>
