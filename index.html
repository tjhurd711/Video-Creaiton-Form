<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Memorial Video</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    
    .content {
      padding: 30px;
    }
    
    /* Summary Sentence */
    .summary-box {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border-left: 4px solid #667eea;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      font-size: 16px;
      line-height: 1.6;
      color: #333;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
    }
    
    .summary-box strong {
      color: #667eea;
      font-weight: 700;
    }
    
    /* Video Player Section */
    .video-section {
      margin-bottom: 30px;
    }
    
    .video-wrapper {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    video {
      width: 100%;
      display: block;
    }
    
    .loading {
      padding: 100px 20px;
      text-align: center;
      color: #999;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      padding: 30px;
      background: #fee;
      border-left: 4px solid #e33;
      border-radius: 8px;
      color: #c33;
    }
    
    /* Action Buttons */
    .actions {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    
    .btn-primary:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }
    
    .btn-secondary {
      background: #2196F3;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #0b7dda;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }
    
    .btn-outline {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }
    
    .btn-outline:hover {
      background: #667eea;
      color: white;
    }

    .btn-edit {
      background: #FF9800;
      color: white;
    }

    .btn-edit:hover {
      background: #f57c00;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
    }
    
    /* Edit Sections */
    .edit-sections {
      border-top: 2px solid #f0f0f0;
      padding-top: 30px;
      margin-top: 30px;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 25px;
    }
    
    .section-header h2 {
      font-size: 22px;
      color: #333;
    }
    
    .section-header .badge {
      background: #667eea;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .edit-option {
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    
    .edit-option:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }
    
    .edit-option-header {
      padding: 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    
    .edit-option-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
    }
    
    .edit-option-icon {
      font-size: 24px;
    }
    
    .chevron {
      font-size: 20px;
      transition: transform 0.3s;
      color: #999;
    }
    
    .edit-option.expanded .chevron {
      transform: rotate(180deg);
    }
    
    .edit-option-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding: 0 20px;
    }
    
    .edit-option.expanded .edit-option-content {
      max-height: 3000px;
      padding: 0 20px 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
      font-size: 14px;
    }

    .form-group .help-text {
      font-size: 13px;
      color: #777;
      font-weight: 400;
      margin-top: 4px;
    }
    
    .form-group select,
    .form-group input[type="number"],
    .form-group input[type="file"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    
    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .radio-option {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .radio-option:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .radio-option.selected {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    .radio-option input[type="radio"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin-top: 2px;
      flex-shrink: 0;
    }

    .radio-option-content {
      flex: 1;
    }

    .radio-option-label {
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    .radio-option-desc {
      font-size: 13px;
      color: #666;
    }

    .conditional-input {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border-radius: 6px;
    }
    
    .placeholder {
      padding: 20px;
      background: #fff9e6;
      border: 2px dashed #ffd700;
      border-radius: 8px;
      text-align: center;
      color: #886600;
      font-style: italic;
    }

    .info-box {
      padding: 16px;
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #1565c0;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .song-list {
      margin-bottom: 20px;
    }

    .song-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }

    .song-item:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .song-item.new-upload {
      border-color: #4CAF50;
      background: #f1f8f4;
    }

    .song-item.library-song {
      border-color: #FF9800;
      background: #fff9f0;
    }

    .song-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .song-position {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .song-item:hover .song-position {
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .song-name {
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .song-badge {
      background: #4CAF50;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .song-badge.library {
      background: #FF9800;
    }

    .song-controls {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }

    .btn-play {
      background: #2196F3;
      color: white;
    }

    .btn-play:hover {
      background: #0b7dda;
    }

    .btn-play.playing {
      background: #FF9800;
    }

    .btn-move {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #ddd;
    }

    .btn-move:hover {
      background: #e0e0e0;
    }

    .btn-move:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    /* Song Library Styles */
    .library-section {
      background: linear-gradient(135deg, #fff9f0 0%, #ffe8cc 100%);
      border: 2px solid #FF9800;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .library-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      font-size: 16px;
      font-weight: 700;
      color: #e65100;
    }

    .library-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    .library-song-card {
      background: white;
      border: 2px solid #FFE0B2;
      border-radius: 10px;
      padding: 12px;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .library-song-card:hover {
      border-color: #FF9800;
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
      transform: translateY(-2px);
    }

    .library-song-card.added {
      border-color: #4CAF50;
      background: #f1f8f4;
    }

    .library-song-name {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      line-height: 1.3;
    }

    .library-song-controls {
      display: flex;
      gap: 6px;
    }

    .btn-add-library {
      flex: 1;
      padding: 8px 12px;
      background: #FF9800;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-add-library:hover:not(:disabled) {
      background: #f57c00;
    }

    .btn-add-library:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-add-library.added {
      background: #4CAF50;
    }

    .upload-section {
      margin-top: 15px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
      border: 2px dashed #ccc;
    }

    .upload-section.max-reached {
      opacity: 0.6;
      pointer-events: none;
    }

    .upload-label {
      display: inline-block;
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }

    .upload-label:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }

    .upload-label.disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* PowerPoint Upload Section */
    .pptx-upload-section {
      margin-top: 15px;
      padding: 20px;
      background: #fff9e6;
      border: 2px dashed #FF9800;
      border-radius: 8px;
    }

    .pptx-upload-section .upload-label {
      background: #FF9800;
      padding: 12px 24px;
      font-size: 15px;
    }

    .pptx-upload-section .upload-label:hover {
      background: #f57c00;
    }

    .pptx-file-preview {
      margin-top: 15px;
      padding: 12px;
      background: white;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .pptx-file-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pptx-file-icon {
      font-size: 24px;
    }

    .pptx-file-details {
      display: flex;
      flex-direction: column;
    }

    .pptx-file-name {
      font-weight: 600;
      color: #333;
    }

    .pptx-file-size {
      font-size: 13px;
      color: #666;
    }

    /* Song Range Sliders */
    .song-ranges-container {
      margin-top: 15px;
    }

    .song-range-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
    }

    .song-range-header {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slide-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .slide-input-group {
      display: flex;
      flex-direction: column;
    }

    .slide-input-group label {
      font-size: 13px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
    }

    .slide-input-group input {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }

    .slide-input-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    /* Resubmit Button */
    .resubmit-section {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 2px solid #f0f0f0;
      text-align: center;
    }
    
    .btn-resubmit {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 18px 40px;
      font-size: 18px;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-resubmit:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    }
    
    .btn-resubmit:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Notification Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 16px 24px;
      background: #333;
      color: white;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
      max-width: 400px;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .toast.success {
      background: #4CAF50;
    }
    
    .toast.error {
      background: #f44336;
    }
    
    @media (max-width: 768px) {
      .header h1 { font-size: 24px; }
      .actions { flex-direction: column; }
      .btn { width: 100%; justify-content: center; }
      .toast { right: 20px; left: 20px; max-width: none; }
      .slide-inputs { grid-template-columns: 1fr; }
      .song-controls { flex-wrap: wrap; }
      .library-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>‚ú® Your Memorial Video</h1>
      <p id="jobInfo">Loading...</p>
    </div>
    
    <div class="content">
      <!-- Summary Sentence -->
      <div id="summaryBox" class="summary-box" style="display:none;">
        <!-- Will be populated dynamically -->
      </div>
      
      <!-- Video Player Section -->
      <div class="video-section">
        <div id="videoContainer" class="loading">
          <div class="spinner"></div>
          <p>Loading your video...</p>
        </div>
      </div>
      
      <!-- Primary Actions -->
      <div class="actions" id="actionButtons">
        <button id="editBtn" class="btn btn-edit" style="display:none;">
          ‚úèÔ∏è Edit & Resubmit
        </button>
        <button id="finalizeBtn" class="btn btn-primary" style="display:none;">
          ‚úÖ I'm Finished (Download Video)
        </button>
        <button id="shareBtn" class="btn btn-secondary" style="display:none;">
          üîó Share Video
        </button>
      </div>
      
      <!-- Finalized State -->
      <div id="finalizedMessage" style="display:none;">
        <div style="background: #e8f5e9; border: 2px solid #4CAF50; border-radius: 12px; padding: 30px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
          <h2 style="color: #2e7d32; margin-bottom: 10px;">Order Complete!</h2>
          <p style="color: #555; margin-bottom: 20px;">Your memorial video has been finalized. A backup copy has been sent to your email.</p>
          <a id="finalDownloadBtn" href="#" class="btn btn-primary">
            üì• Download Video Again
          </a>
        </div>
      </div>
      
      <!-- Edit Sections -->
      <div class="edit-sections" id="editSections" style="display:none;">
        <div class="section-header">
          <h2>‚úèÔ∏è Make Changes to Your Video</h2>
        </div>
        
        <!-- Change Songs (MOVED TO TOP) -->
        <div class="edit-option" data-section="songs">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">üéµ</span>
              <span>Change Songs</span>
            </div>
            <span class="chevron">‚ñº</span>
          </div>
          <div class="edit-option-content">
            <!-- Song Library -->
            <div class="library-section">
              <div class="library-header">
                üéº Song Library - Choose from our curated memorial music
              </div>
              <div class="library-grid" id="libraryGrid">
                <!-- Will be populated dynamically -->
              </div>
            </div>

            <div class="form-group">
              <label>Your Selected Songs (drag to reorder, max 6 total)</label>
              <div id="songList" class="song-list">
                <!-- Will be populated dynamically -->
              </div>
            </div>
            
            <div class="upload-section" id="uploadSection">
              <label class="upload-label" id="uploadLabel">
                üì§ Upload Your Own Songs (MP3)
                <input type="file" id="newSongUpload" accept=".mp3,audio/mpeg" multiple style="display: none;">
              </label>
              <div style="margin-top: 8px; font-size: 13px; color: #666;">
                <span id="songCountDisplay">0 of 6 songs</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Change Transitions -->
        <div class="edit-option" data-section="transitions">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">üé®</span>
              <span>Change Transitions</span>
            </div>
            <span class="chevron">‚ñº</span>
          </div>
          <div class="edit-option-content">
            <div class="form-group">
              <label for="visualPackage">
                Visual Package
                <div class="help-text">Choose the style of transitions between slides</div>
              </label>
              <select id="visualPackage" name="visualPackage">
                <option value="">-- Select a package --</option>
                <option value="simple-fade-wipe">Simple Fade & Wipe</option>
                <option value="pages-of-life">Pages of Life</option>
                <option value="floating-frames">Floating Frames</option>
                <option value="zoom-through">Zoom Through</option>
                <option value="blinds-combs-bars">Blinds, Combs & Bars</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Change Timing -->
        <div class="edit-option" data-section="timing">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">‚è±Ô∏è</span>
              <span>Change Video Length</span>
            </div>
            <span class="chevron">‚ñº</span>
          </div>
          <div class="edit-option-content">
            <div class="form-group">
              <label>Timing Mode</label>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" name="timingMode" value="perSlide">
                  <div class="radio-option-content">
                    <span class="radio-option-label">Per Slide Duration</span>
                    <span class="radio-option-desc">Set how many seconds each slide should display</span>
                    <div class="conditional-input" id="perSlideInput" style="display:none;">
                      <label for="perSlideSec" style="font-size: 13px; margin-bottom: 6px;">Seconds per slide:</label>
                      <input type="number" id="perSlideSec" name="perSlideSec" min="2" max="30" value="5" style="padding: 8px;">
                    </div>
                  </div>
                </label>
                
                <label class="radio-option">
                  <input type="radio" name="timingMode" value="fixedRuntime">
                  <div class="radio-option-content">
                    <span class="radio-option-label">Fixed Total Runtime</span>
                    <span class="radio-option-desc">Set the total video length in seconds</span>
                    <div class="conditional-input" id="fixedRuntimeInput" style="display:none;">
                      <label for="fixedRuntimeSec" style="font-size: 13px; margin-bottom: 6px;">Total runtime (seconds):</label>
                      <input type="number" id="fixedRuntimeSec" name="fixedRuntimeSec" min="30" max="1800" value="320" style="padding: 8px;">
                    </div>
                  </div>
                </label>
                
                <label class="radio-option">
                  <input type="radio" name="timingMode" value="fitToSongs">
                  <div class="radio-option-content">
                    <span class="radio-option-label">Fit to Music Length</span>
                    <span class="radio-option-desc">Video duration matches your music (automatic)</span>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Change Song Logic -->
        <div class="edit-option" data-section="songlogic">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">üéº</span>
              <span>Change Song Logic</span>
            </div>
            <span class="chevron">‚ñº</span>
          </div>
          <div class="edit-option-content">
            <div class="form-group">
              <label for="musicDistribution">
                Music Distribution
                <div class="help-text">How songs should be spread across the video</div>
              </label>
              <select id="musicDistribution" name="musicDistribution">
                <option value="">-- Select distribution --</option>
                <option value="evenlyDistributed">Evenly Distributed</option>
                <option value="specifyPlacement">Specify Placement</option>
              </select>
            </div>

            <!-- Conditional Song Range Sliders -->
            <div id="songRangesContainer" class="song-ranges-container" style="display:none;">
              <div class="info-box">
                üìç Specify which slides each song should play during. The backend will automatically prevent overlaps and fill gaps.
              </div>
              <div id="songRangesList">
                <!-- Will be populated dynamically based on number of songs -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Manual Changes -->
        <div class="edit-option" data-section="manual">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">‚úèÔ∏è</span>
              <span>Edit Slideshow</span>
            </div>
            <span class="chevron">‚ñº</span>
          </div>
          <div class="edit-option-content">
            <div class="info-box" id="manualEditInfoBox">
              Edit your presentation directly, then come back here and click "Resubmit Changes" to create a new video with your edits.
            </div>
            <div id="manualEditButtons" class="button-group">
              <!-- Buttons will be populated based on presentation type -->
            </div>
            
            <!-- PowerPoint Upload Section (Only shows for PowerPoint providers) -->
            <div id="pptxUploadSection" class="pptx-upload-section" style="display:none;">
              <div style="margin-bottom: 12px; font-weight: 600; color: #FF9800;">
                üìÑ Upload a New PowerPoint File
              </div>
              <label class="upload-label">
                üì§ Choose PowerPoint File (.pptx)
                <input type="file" id="newPptxUpload" accept=".pptx,application/vnd.openxmlformats-officedocument.presentationml.presentation" style="display: none;">
              </label>
              <div id="pptxFilePreview" style="display:none;">
                <!-- File preview will appear here -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Resubmit Section -->
        <div class="resubmit-section">
          <button id="resubmitBtn" class="btn-resubmit" disabled>
            üöÄ Resubmit Changes
          </button>
          <p style="margin-top:12px; color:#999; font-size:14px;">
            Make changes above, then click to create a new video
          </p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>
  
  <script>
    // Configuration
    const API_BASE = 'https://4hyy6kr2id.execute-api.us-east-2.amazonaws.com/prod';
    const MAX_SONGS = 6;
    
    // Song Library with S3 URLs
    const SONG_LIBRARY = [
      {
        id: 'lib-abandoned-house',
        name: 'abandoned-house-115974.mp3',
        displayName: 'Abandoned House',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/abandoned-house-115974.mp3'
      },
      {
        id: 'lib-cathedral',
        name: 'cathedral-164234.mp3',
        displayName: 'Cathedral',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/cathedral-164234.mp3'
      },
      {
        id: 'lib-eulogy',
        name: 'eulogy-ambient-piano-music-for-furneral-exit-download-royalty-free-196437.mp3',
        displayName: 'Eulogy - Ambient Piano',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/eulogy-ambient-piano-music-for-furneral-exit-download-royalty-free-196437.mp3'
      },
      {
        id: 'lib-flowers',
        name: 'flowers-of-sorrow-115981.mp3',
        displayName: 'Flowers of Sorrow',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/flowers-of-sorrow-115981.mp3'
      },
      {
        id: 'lib-funeral-memories',
        name: 'funeral-memories-sad-asmr-piano-soft-farewell-334314.mp3',
        displayName: 'Funeral Memories - Soft Farewell',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/funeral-memories-sad-asmr-piano-soft-farewell-334314.mp3'
      },
      {
        id: 'lib-gentle-remembrance',
        name: 'gentle-remembrance-359855.mp3',
        displayName: 'Gentle Remembrance',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/gentle-remembrance-359855.mp3'
      },
      {
        id: 'lib-sad-cinematic',
        name: 'sad-cinematic-despair-mourning-tragic-music-340712.mp3',
        displayName: 'Sad Cinematic - Mourning',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/sad-cinematic-despair-mourning-tragic-music-340712.mp3'
      },
      {
        id: 'lib-shadows-towers',
        name: 'shadows-of-the-wailing-towers-2-304723.mp3',
        displayName: 'Shadows of the Wailing Towers',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/shadows-of-the-wailing-towers-2-304723.mp3'
      },
      {
        id: 'lib-souls-silence',
        name: 'souls-of-silence-369585.mp3',
        displayName: 'Souls of Silence',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/souls-of-silence-369585.mp3'
      },
      {
        id: 'lib-hands-loved',
        name: 'the-hands-that-loved-me-301869.mp3',
        displayName: 'The Hands That Loved Me',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/the-hands-that-loved-me-301869.mp3'
      },
      {
        id: 'lib-voices-eternity',
        name: 'voices-of-eternity-church-cathedral-choir-195196.mp3',
        displayName: 'Voices of Eternity - Cathedral Choir',
        url: 'https://order-by-age-uploads.s3.us-east-2.amazonaws.com/library-songs/voices-of-eternity-church-cathedral-choir-195196.mp3'
      }
    ];
    
    // Parse job ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const jobId = urlParams.get('job');
    const isFinalized = urlParams.get('finalized') === 'true';
    const isSharedView = urlParams.get('share') === 'true';
    
    // Track changes made by user
    let pendingChanges = {};
    let currentSettings = {};
    let currentSongs = [];
    let currentlyPlayingAudio = null;
    let newPptxFile = null;
    
    // Prevent going back if finalized
    if (isFinalized) {
      history.pushState(null, null, location.href);
      history.pushState(null, null, location.href);
      
      window.addEventListener('popstate', function(event) {
        history.pushState(null, null, location.href);
      });
    }
    
    if (!jobId) {
      showError('No job ID provided in URL. Please check your link.');
    } else {
      loadJobData(jobId);
    }
    
    // Render song library
    function renderLibrary() {
      const container = document.getElementById('libraryGrid');
      
      let html = '';
      SONG_LIBRARY.forEach(song => {
        const isAdded = currentSongs.some(s => s.id === song.id);
        const cardClass = isAdded ? 'library-song-card added' : 'library-song-card';
        const btnClass = isAdded ? 'btn-add-library added' : 'btn-add-library';
        const btnText = isAdded ? '‚úì Added' : '+ Add to Video';
        const audioId = `audio-lib-${song.id}`;
        
        html += `
          <div class="${cardClass}" data-song-id="${song.id}">
            <div class="library-song-name">${song.displayName}</div>
            <div class="library-song-controls">
              <button class="btn-small btn-play" onclick="togglePlay('${audioId}', this)">‚ñ∂Ô∏è</button>
              <button class="${btnClass}" onclick="addLibrarySong('${song.id}')" ${isAdded || currentSongs.length >= MAX_SONGS ? 'disabled' : ''}>
                ${btnText}
              </button>
            </div>
            <audio id="${audioId}" src="${song.url}" preload="none"></audio>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // Add library song to current songs
    function addLibrarySong(songId) {
      if (currentSongs.length >= MAX_SONGS) {
        showToast(`Maximum ${MAX_SONGS} songs reached`, 'error');
        return;
      }
      
      const libSong = SONG_LIBRARY.find(s => s.id === songId);
      if (!libSong) return;
      
      // Check if already added
      if (currentSongs.some(s => s.id === songId)) {
        showToast('Song already added', 'error');
        return;
      }
      
      currentSongs.push({
        id: libSong.id,
        name: libSong.name,
        displayName: libSong.displayName,
        url: libSong.url,
        isNew: false,
        isLibrary: true,
        file: null
      });
      
      renderLibrary();
      renderSongList();
      updateSongCount();
      updateSongRangeSliders();
      showToast(`Added "${libSong.displayName}"`, 'success');
    }
    
    // Load job data from API
    async function loadJobData(jobId) {
      try {
        console.log('[API] Calling:', `${API_BASE}/jobs/${jobId}`);
        const response = await fetch(`${API_BASE}/jobs/${jobId}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('[API] Response:', data);
        
        // Store current settings
        if (data.settings) {
          currentSettings = data.settings;
          populateFormDefaults(data.settings);
          displaySummary(data.settings);
        }
        
        // Initialize songs from API response
        if (data.songs && data.songs.length > 0) {
          currentSongs = data.songs.map(song => {
            // Check if this is a library song
            const libSong = SONG_LIBRARY.find(lib => lib.name === song.name);
            
            return {
              id: libSong ? libSong.id : song.name,
              name: song.name,
              displayName: song.displayName || song.name,
              url: song.url,
              isNew: false,
              isLibrary: !!libSong,
              file: null
            };
          });
        } else if (data.settings && data.settings.audioCount > 0) {
          const audioCount = data.settings.audioCount;
          for (let i = 1; i <= audioCount; i++) {
            currentSongs.push({
              id: `song${i}.mp3`,
              name: `song${i}.mp3`,
              displayName: `song${i}.mp3`,
              url: null,
              isNew: false,
              isLibrary: false,
              file: null
            });
          }
        }
        
        // Auto-redirect to finalized page if job is already finalized
        if (data.isFinalized && !isFinalized) {
          console.log('[REDIRECT] Job is finalized, redirecting...');
          window.location.replace(`${window.location.origin}${window.location.pathname}?job=${jobId}&finalized=true`);
          return;
        }
        
        displayVideo(data);
        setupManualEditButtons(data);
        renderLibrary();
        renderSongList();
        updateSongCount();
      } catch (error) {
        console.error('[API ERROR]', error);
        showError('Failed to load video data: ' + error.message);
      }
    }
    
    // Display summary sentence
    function displaySummary(settings) {
      const summaryBox = document.getElementById('summaryBox');
      
      // Format duration
      let durationText = '';
      if (settings.timingMode === 'fixedRuntime' && settings.fixedRuntimeSec) {
        const minutes = Math.floor(settings.fixedRuntimeSec / 60);
        const seconds = settings.fixedRuntimeSec % 60;
        durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      } else if (settings.timingMode === 'perSlide' && settings.perSlideSec) {
        durationText = `${settings.perSlideSec}s per slide`;
      } else if (settings.timingMode === 'fitToSongs') {
        durationText = 'matched to music length';
      } else {
        durationText = 'custom timing';
      }
      
      // Timing mode display name
      const timingModeNames = {
        'fixedRuntime': 'Fixed Runtime',
        'perSlide': 'Per Slide Duration',
        'fitToSongs': 'Fit to Music'
      };
      const timingModeName = timingModeNames[settings.timingMode] || settings.timingMode;
      
      // Visual package display name
      const visualPackageNames = {
        'simple-fade-wipe': 'Simple Fade & Wipe',
        'pages-of-life': 'Pages of Life',
        'floating-frames': 'Floating Frames',
        'zoom-through': 'Zoom Through',
        'blinds-combs-bars': 'Blinds, Combs & Bars'
      };
      const visualPackageName = visualPackageNames[settings.visualPackage] || settings.visualPackage;
      
      // Music distribution display name
      const musicDistNames = {
        'evenlyDistributed': 'Evenly Distributed',
        'specifyPlacement': 'Specify Placement'
      };
      const musicDistName = musicDistNames[settings.musicDistribution] || settings.musicDistribution;
      
      // Build summary
      const audioCount = settings.audioCount || 3;
      summaryBox.innerHTML = `
        Your <strong>${durationText}</strong> video uses <strong>${timingModeName}</strong> mode with <strong>${visualPackageName}</strong> transitions and <strong>${audioCount} song${audioCount !== 1 ? 's' : ''}</strong> (${musicDistName}).
      `;
      
      summaryBox.style.display = 'block';
    }
    
    // Populate form defaults from settings
    function populateFormDefaults(settings) {
      // Transitions
      if (settings.visualPackage) {
        document.getElementById('visualPackage').value = settings.visualPackage;
      }
      
      // Timing
      if (settings.timingMode) {
        const radio = document.querySelector(`input[name="timingMode"][value="${settings.timingMode}"]`);
        if (radio) {
          radio.checked = true;
          handleTimingModeChange(settings.timingMode);
        }
      }
      if (settings.perSlideSec) {
        document.getElementById('perSlideSec').value = settings.perSlideSec;
      }
      if (settings.fixedRuntimeSec) {
        document.getElementById('fixedRuntimeSec').value = settings.fixedRuntimeSec;
      }
      
      // Song Logic
      if (settings.musicDistribution) {
        document.getElementById('musicDistribution').value = settings.musicDistribution;
        handleMusicDistributionChange(settings.musicDistribution);
      }
    }
    
    // Render song list
    function renderSongList() {
      const container = document.getElementById('songList');
      
      if (currentSongs.length === 0) {
        container.innerHTML = '<div style="color: #999; font-style: italic;">No songs selected. Choose from the library above or upload your own!</div>';
        return;
      }
      
      let html = '';
      currentSongs.forEach((song, index) => {
        const audioId = `audio-${song.id}`;
        const newBadge = song.isNew ? '<span class="song-badge">NEW</span>' : '';
        const libraryBadge = song.isLibrary ? '<span class="song-badge library">LIBRARY</span>' : '';
        
        let itemClass = 'song-item';
        if (song.isNew) itemClass += ' new-upload';
        if (song.isLibrary) itemClass += ' library-song';
        
        const position = index + 1;
        
        html += `
          <div class="${itemClass}">
            <div class="song-info">
              <div class="song-position">${position}</div>
              <span class="song-name">${song.displayName}</span>
              ${newBadge}
              ${libraryBadge}
            </div>
            <div class="song-controls">
              ${song.url ? `<button class="btn-small btn-play" onclick="togglePlay('${audioId}', this)">‚ñ∂Ô∏è</button>` : ''}
              <button class="btn-small btn-move" onclick="moveSongUp(${index})" ${index === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
              <button class="btn-small btn-move" onclick="moveSongDown(${index})" ${index === currentSongs.length - 1 ? 'disabled' : ''}>‚¨áÔ∏è</button>
              <button class="btn-small btn-danger" onclick="removeSong(${index})">üóëÔ∏è</button>
            </div>
            ${song.url ? `<audio id="${audioId}" src="${song.url}" preload="none"></audio>` : ''}
          </div>
        `;
      });
      
      container.innerHTML = html;
      updateSongTracking();
    }
    
    // Toggle audio play/pause
    function togglePlay(audioId, button) {
      const audio = document.getElementById(audioId);
      
      if (currentlyPlayingAudio && currentlyPlayingAudio !== audio) {
        currentlyPlayingAudio.pause();
        currentlyPlayingAudio.currentTime = 0;
        document.querySelectorAll('.btn-play').forEach(btn => {
          btn.textContent = '‚ñ∂Ô∏è';
          btn.classList.remove('playing');
        });
      }
      
      if (audio.paused) {
        audio.play();
        button.textContent = '‚è∏Ô∏è';
        button.classList.add('playing');
        currentlyPlayingAudio = audio;
        
        audio.onended = () => {
          button.textContent = '‚ñ∂Ô∏è';
          button.classList.remove('playing');
          currentlyPlayingAudio = null;
        };
      } else {
        audio.pause();
        audio.currentTime = 0;
        button.textContent = '‚ñ∂Ô∏è';
        button.classList.remove('playing');
        currentlyPlayingAudio = null;
      }
    }
    
    // Move song up
    function moveSongUp(index) {
      if (index === 0) return;
      const temp = currentSongs[index];
      currentSongs[index] = currentSongs[index - 1];
      currentSongs[index - 1] = temp;
      renderSongList();
      updateSongRangeSliders();
    }
    
    // Move song down
    function moveSongDown(index) {
      if (index === currentSongs.length - 1) return;
      const temp = currentSongs[index];
      currentSongs[index] = currentSongs[index + 1];
      currentSongs[index + 1] = temp;
      renderSongList();
      updateSongRangeSliders();
    }
    
    // Remove song
    function removeSong(index) {
      if (!confirm(`Remove "${currentSongs[index].displayName}"?`)) return;
      currentSongs.splice(index, 1);
      renderLibrary();
      renderSongList();
      updateSongCount();
      updateSongRangeSliders();
    }
    
    // Update song count display
    function updateSongCount() {
      const display = document.getElementById('songCountDisplay');
      const uploadSection = document.getElementById('uploadSection');
      const uploadLabel = document.getElementById('uploadLabel');
      
      display.textContent = `${currentSongs.length} of ${MAX_SONGS} songs`;
      
      if (currentSongs.length >= MAX_SONGS) {
        uploadSection.classList.add('max-reached');
        uploadLabel.classList.add('disabled');
      } else {
        uploadSection.classList.remove('max-reached');
        uploadLabel.classList.remove('disabled');
      }
      
      // Update library add buttons
      renderLibrary();
    }
    
    // Handle new song uploads
    document.getElementById('newSongUpload').addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      
      files.forEach(file => {
        if (currentSongs.length >= MAX_SONGS) {
          showToast(`Maximum ${MAX_SONGS} songs reached`, 'error');
          return;
        }
        
        if (!file.type.includes('audio/mpeg') && !file.name.endsWith('.mp3')) {
          showToast(`${file.name} is not an MP3 file`, 'error');
          return;
        }
        
        const localUrl = URL.createObjectURL(file);
        
        currentSongs.push({
          id: `new-${Date.now()}-${Math.random()}`,
          name: file.name,
          displayName: file.name,
          url: localUrl,
          isNew: true,
          isLibrary: false,
          file: file
        });
      });
      
      renderSongList();
      updateSongCount();
      updateSongRangeSliders();
      
      e.target.value = '';
    });
    
    // Handle PowerPoint file upload
    document.getElementById('newPptxUpload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      
      if (!file) return;
      
      if (!file.name.endsWith('.pptx') && !file.type.includes('presentationml')) {
        showToast('Please select a valid PowerPoint (.pptx) file', 'error');
        e.target.value = '';
        return;
      }
      
      newPptxFile = file;
      
      const previewDiv = document.getElementById('pptxFilePreview');
      const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
      
      previewDiv.innerHTML = `
        <div class="pptx-file-preview">
          <div class="pptx-file-info">
            <span class="pptx-file-icon">üìÑ</span>
            <div class="pptx-file-details">
              <span class="pptx-file-name">${file.name}</span>
              <span class="pptx-file-size">${fileSizeMB} MB</span>
            </div>
          </div>
          <button class="btn-small btn-danger" onclick="clearPptxUpload()">üóëÔ∏è Remove</button>
        </div>
      `;
      previewDiv.style.display = 'block';
      
      trackChange('newPresentationFile', true);
      showToast('PowerPoint file ready to upload!', 'success');
    });
    
    // Clear PowerPoint upload
    function clearPptxUpload() {
      newPptxFile = null;
      document.getElementById('newPptxUpload').value = '';
      document.getElementById('pptxFilePreview').style.display = 'none';
      delete pendingChanges.newPresentationFile;
      updateResubmitButton();
      showToast('PowerPoint file removed', 'success');
    }
    
    // Track song changes for resubmit
    function updateSongTracking() {
      const songOrder = currentSongs.map(song => song.name);
      const newSongs = currentSongs.filter(s => s.isNew).map(s => ({
        originalName: s.name,
        file: s.file
      }));
      
      const hasChanges = currentSongs.some(s => s.isNew) || 
                        JSON.stringify(songOrder) !== JSON.stringify(currentSongs.map(s => s.name));
      
      if (hasChanges || newSongs.length > 0) {
        trackChange('songOrder', songOrder);
        if (newSongs.length > 0) {
          trackChange('newSongs', newSongs);
        }
      }
    }
    
    // Setup song range sliders
    function setupSongRangeSliders() {
      const container = document.getElementById('songRangesList');
  
      if (currentSongs.length === 0) {
        container.innerHTML = '<div style="color: #999; font-style: italic;">No songs available. Add songs first.</div>';
        return;
      }
  
      let html = '';
      currentSongs.forEach((song, index) => {
        const audioId = `audio-range-${song.id}`;
        const playButton = song.url ? `<button class="btn-small btn-play" onclick="togglePlay('${audioId}', this)" style="margin-left: 8px;">‚ñ∂Ô∏è</button>` : '';
    
        // Auto-populate start value: first song starts at 1, others start at previous end + 1
        const startValue = index === 0 ? '1' : '';
    
        html += `
          <div class="song-range-item">
            <div class="song-range-header">
              üéµ ${song.displayName}
              ${playButton}
              ${song.url ? `<audio id="${audioId}" src="${song.url}" preload="none"></audio>` : ''}
            </div>
            <div class="slide-inputs">
              <div class="slide-input-group">
                <label>Start Slide</label>
                <input type="number" 
                       id="songRange${index}Start" 
                       class="song-range-input"
                       data-song-index="${index}"
                       data-type="start"
                       min="1" 
                       max="250"
                       value="${startValue}"
                       placeholder="e.g., 1">
              </div>
              <div class="slide-input-group">
                <label>End Slide</label>
                <input type="number" 
                       id="songRange${index}End" 
                       class="song-range-input"
                       data-song-index="${index}"
                       data-type="end"
                       min="1" 
                       max="250" 
                       placeholder="e.g., 50">
              </div>
           </div>
        </div>
      `;
    });
  
    container.innerHTML = html;
  
    document.querySelectorAll('.song-range-input').forEach(input => {
      input.addEventListener('input', handleSongRangeChange);
    });
  }
    
    // Update song range sliders (wrapper for setup)
    function updateSongRangeSliders() {
      const musicDist = document.getElementById('musicDistribution').value;
      
      if (musicDist === 'specifyPlacement') {
        setupSongRangeSliders();
      }
    }
    
    // Handle song range input changes
    function handleSongRangeChange(e) {
      const changedIndex = parseInt(e.target.dataset.songIndex);
      const changedType = e.target.dataset.type;
  
      // If an "End Slide" changed, update the next song's start slide
      if (changedType === 'end' && changedIndex < currentSongs.length - 1) {
        const endValue = parseInt(e.target.value);
        if (!isNaN(endValue)) {
          const nextStartInput = document.getElementById(`songRange${changedIndex + 1}Start`);
          if (nextStartInput) {
            nextStartInput.value = endValue + 1;
          }
        }
     }
  
     // Rebuild songRanges array
     const songRanges = [];

     currentSongs.forEach((song, index) => {
       const startInput = document.getElementById(`songRange${index}Start`);
       const endInput = document.getElementById(`songRange${index}End`);

       if (startInput && endInput) {
         const startVal = parseInt(startInput.value);
         const endVal = parseInt(endInput.value);
  
         if (!isNaN(startVal) && !isNaN(endVal)) {
           // FIX: For uploaded songs, extract filename from S3 URL
           // For library songs, use the original name
           let songIdentifier = song.name;
        
           if (!song.isLibrary && song.url && song.url.startsWith('blob:')) {
             // New upload with blob URL - use the original filename
             songIdentifier = song.name;
           } else if (!song.isLibrary && song.url && song.url.includes('/temp-uploads/')) {
             // Previously uploaded song - extract filename from S3 URL
             songIdentifier = song.url.split('/').pop();
             console.log(`[SONG RANGE] Mapped uploaded song: ${song.name} -> ${songIdentifier}`);
           }
        
           songRanges.push({
             song: songIdentifier,
             startSlide: startVal,
             endSlide: endVal
           });
         }
       }
     });

     if (songRanges.length > 0) {
       trackChange('songRanges', songRanges);
     } else {
       delete pendingChanges.songRanges;
       updateResubmitButton();
     }

     console.log('[SONG RANGES]', songRanges);
   }
    
    // Handle music distribution change
    function handleMusicDistributionChange(value) {
      const container = document.getElementById('songRangesContainer');
      
      if (value === 'specifyPlacement') {
        container.style.display = 'block';
        setupSongRangeSliders();
      } else {
        container.style.display = 'none';
        delete pendingChanges.songRanges;
        updateResubmitButton();
      }
    }
    
    // Setup manual edit buttons based on presentation type
    function setupManualEditButtons(data) {
      const container = document.getElementById('manualEditButtons');
      const infoBox = document.getElementById('manualEditInfoBox');
      const pptxUploadSection = document.getElementById('pptxUploadSection');
      
      if (data.provider === 'google_slides') {
        infoBox.innerHTML = 'Select to edit your <strong>Google Slides</strong> to make manual changes, and once you are done you may select "Resubmit Changes" at the bottom along with any other changes you made. This version will be published in the next Video.';
        pptxUploadSection.style.display = 'none';
      } else if (data.provider === 'powerpoint') {
        infoBox.innerHTML = 'Select to edit your <strong>PowerPoint</strong> to make manual changes, or upload a new PowerPoint file below. Once you are done, select "Resubmit Changes" at the bottom along with any other changes you made. This version will be published in the next Video.';
        pptxUploadSection.style.display = 'block';
      }
      
      if (data.provider === 'google_slides' && data.original_url) {
        container.innerHTML = `
          <button class="btn btn-primary" onclick="handleManualEditClick('${data.original_url}')">
            üìä Edit Google Slides
          </button>
        `;
      } else if (data.provider === 'powerpoint' && data.original_url) {
        container.innerHTML = `
          <button class="btn btn-primary" onclick="handleManualEditClick('${data.original_url}')">
            üìÑ Edit PowerPoint
          </button>
        `;
      } else {
        container.innerHTML = `
          <div style="color: #999; font-style: italic;">
            Presentation link not available for this job.
          </div>
        `;
      }
    }
    
    // Handle manual edit button click
    function handleManualEditClick(url) {
      window.open(url, '_blank');
      trackChange('manualEditsRequested', true);
      showToast('Presentation opened! Make your changes, then click "Resubmit Changes" when done.', 'success');
    }
    
    // Display video and controls
    function displayVideo(data) {
      const container = document.getElementById('videoContainer');
      const jobInfo = document.getElementById('jobInfo');
      
      jobInfo.textContent = `Order #${data.jobId}`;
      
      if (isFinalized) {
        container.innerHTML = `
          <div class="video-wrapper">
            <video controls preload="auto">
              <source src="${data.videoUrl}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>
        `;
        
        document.getElementById('actionButtons').style.display = 'none';
        document.getElementById('finalizedMessage').style.display = 'block';
        document.getElementById('finalDownloadBtn').href = data.downloadUrl || data.videoUrl;
        return;
      }
      
      if (isSharedView) {
        container.innerHTML = `
          <div class="video-wrapper">
            <video controls preload="auto" crossorigin="anonymous">
              <source src="${data.videoUrl}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>
        `;
        
        document.getElementById('actionButtons').style.display = 'none';
        return;
      }
      
      container.innerHTML = `
        <div class="video-wrapper">
          <video controls preload="auto" crossorigin="anonymous">
            <source src="${data.videoUrl}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        </div>
      `;
      
      const video = container.querySelector('video');
      video.addEventListener('loadstart', () => console.log('[VIDEO] Loading started'));
      video.addEventListener('loadedmetadata', () => console.log('[VIDEO] Metadata loaded'));
      video.addEventListener('canplay', () => console.log('[VIDEO] Can play'));
      video.addEventListener('error', (e) => {
        console.error('[VIDEO ERROR]', e);
        console.error('[VIDEO ERROR] Details:', video.error);
        showError('Video failed to load. The file may be corrupted or the URL expired.');
      });
      
      document.getElementById('editBtn').style.display = 'inline-flex';
      document.getElementById('finalizeBtn').style.display = 'inline-flex';
      document.getElementById('shareBtn').style.display = 'inline-flex';
      
      window.videoData = data;
      
      setupFinalizeButton();
      setupEditButton();
    }
    
    // Show error message
    function showError(message) {
      const container = document.getElementById('videoContainer');
      container.innerHTML = `<div class="error">${message}</div>`;
    }
    
    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }
    
    // Edit button handler
    function setupEditButton() {
      document.getElementById('editBtn').addEventListener('click', () => {
        const editSections = document.getElementById('editSections');
        const isVisible = editSections.style.display !== 'none';
        
        if (isVisible) {
          editSections.style.display = 'none';
          document.getElementById('editBtn').innerHTML = '‚úèÔ∏è Edit & Resubmit';
        } else {
          editSections.style.display = 'block';
          document.getElementById('editBtn').innerHTML = '‚ùå Hide Edit Options';
          editSections.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }
    
    // Finalize button handler
    function setupFinalizeButton() {
      document.getElementById('finalizeBtn').addEventListener('click', async () => {
        const confirmed = confirm(
          "Are you sure? You won't be able to make anymore edits to the final video. " +
          "You will also be emailed a final copy as a backup."
        );
        
        if (!confirmed) return;
        
        try {
          const downloadUrl = window.videoData.downloadUrl || window.videoData.videoUrl;
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = `memorial_video_${jobId}.mp4`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          showToast('Finalizing your order...', 'success');
          const response = await fetch(`${API_BASE}/jobs/${jobId}/finalize`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error('Failed to finalize order');
          }
          
          const finalizedUrl = `${window.location.origin}${window.location.pathname}?job=${jobId}&finalized=true`;
          history.replaceState(null, '', finalizedUrl);
          location.reload();
          
        } catch (error) {
          console.error('[FINALIZE ERROR]', error);
          showToast('Download started, but email failed. Please contact support.', 'error');
        }
      });
    }
    
    // Share button handler
    document.getElementById('shareBtn').addEventListener('click', async () => {
      try {
        const shareUrl = `${window.location.origin}${window.location.pathname}?job=${jobId}&share=true`;
        await navigator.clipboard.writeText(shareUrl);
        showToast('Share link copied to clipboard! Recipients will only see the video.', 'success');
      } catch (error) {
        showToast('Failed to copy link: ' + error.message, 'error');
      }
    });
    
    // Edit section expansion
    document.querySelectorAll('.edit-option-header').forEach(header => {
      header.addEventListener('click', () => {
        const option = header.closest('.edit-option');
        option.classList.toggle('expanded');
      });
    });
    
    // Track form changes
    function trackChange(fieldName, value) {
      if (value === '' || value === null || value === undefined) {
        delete pendingChanges[fieldName];
      } else {
        pendingChanges[fieldName] = value;
      }
      updateResubmitButton();
      console.log('[CHANGES]', pendingChanges);
    }
    
    // Update resubmit button state
    function updateResubmitButton() {
      const btn = document.getElementById('resubmitBtn');
      const hasChanges = Object.keys(pendingChanges).length > 0;
      btn.disabled = !hasChanges;
      
      if (hasChanges) {
        btn.textContent = `üöÄ Resubmit Changes (${Object.keys(pendingChanges).length})`;
      } else {
        btn.textContent = 'üöÄ Resubmit Changes';
      }
    }
    
    // Setup change tracking for all form elements
    document.getElementById('visualPackage').addEventListener('change', (e) => {
      trackChange('visualPackage', e.target.value);
    });
    
    document.querySelectorAll('input[name="timingMode"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const mode = e.target.value;
        handleTimingModeChange(mode);
        trackChange('timingMode', mode);
        
        if (mode === 'perSlide') {
          trackChange('perSlideSec', document.getElementById('perSlideSec').value);
        } else if (mode === 'fixedRuntime') {
          trackChange('fixedRuntimeSec', document.getElementById('fixedRuntimeSec').value);
        }
      });
    });
    
    function handleTimingModeChange(mode) {
      document.getElementById('perSlideInput').style.display = 'none';
      document.getElementById('fixedRuntimeInput').style.display = 'none';
      
      document.querySelectorAll('.radio-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      const selectedRadio = document.querySelector(`input[name="timingMode"][value="${mode}"]`);
      if (selectedRadio) {
        selectedRadio.closest('.radio-option').classList.add('selected');
        
        if (mode === 'perSlide') {
          document.getElementById('perSlideInput').style.display = 'block';
        } else if (mode === 'fixedRuntime') {
          document.getElementById('fixedRuntimeInput').style.display = 'block';
        }
      }
    }
    
    document.getElementById('perSlideSec').addEventListener('input', (e) => {
      trackChange('perSlideSec', parseFloat(e.target.value));
    });
    
    document.getElementById('fixedRuntimeSec').addEventListener('input', (e) => {
      trackChange('fixedRuntimeSec', parseFloat(e.target.value));
    });
    
    document.getElementById('musicDistribution').addEventListener('change', (e) => {
      const value = e.target.value;
      trackChange('musicDistribution', value);
      handleMusicDistributionChange(value);
    });
    
    // Resubmit button handler
    document.getElementById('resubmitBtn').addEventListener('click', async () => {
      if (Object.keys(pendingChanges).length === 0) {
        showToast('No changes to submit', 'error');
        return;
      }
      
      const confirmed = confirm(
        `Create a new video with ${Object.keys(pendingChanges).length} change(s)?\n\n` +
        'You will receive an email in 5-15 minutes with your new video.'
      );
      
      if (!confirmed) return;
      
      try {
        showToast('Uploading files...', 'success');
        console.log('[RESUBMIT] Preparing submission...');
        
        // Build COMPLETE settings (not just deltas)
        const completeSettings = {
          ...currentSettings,
          timingMode: document.querySelector('input[name="timingMode"]:checked')?.value || currentSettings.timingMode || 'perSlide',
          perSlideSec: parseFloat(document.getElementById('perSlideSec').value) || currentSettings.perSlideSec || 5,
          fixedRuntimeSec: parseFloat(document.getElementById('fixedRuntimeSec').value) || currentSettings.fixedRuntimeSec || 350,
          visualPackage: document.getElementById('visualPackage').value || currentSettings.visualPackage || 'simple-fade-wipe',
          musicDistribution: document.getElementById('musicDistribution').value || currentSettings.musicDistribution || 'evenlyDistributed',
          jobId: undefined,
          originalJobId: undefined,
          songOrder: currentSongs.map(s => s.name),
          audioCount: currentSongs.length
        };
        
        // Remove undefined fields
        Object.keys(completeSettings).forEach(key => {
          if (completeSettings[key] === undefined) {
            delete completeSettings[key];
          }
        });

        // ‚úÖ ONLY ADD SONG RANGES IF musicDistribution is specifyPlacement AND they exist in pendingChanges
        if (completeSettings.musicDistribution === 'specifyPlacement' && pendingChanges.songRanges && pendingChanges.songRanges.length > 0) {
          completeSettings.songRanges = pendingChanges.songRanges;
          console.log('[RESUBMIT] Including songRanges:', pendingChanges.songRanges);
        } else {
          // ‚úÖ EXPLICITLY REMOVE songRanges if not using specifyPlacement
          delete completeSettings.songRanges;
          console.log('[RESUBMIT] Removed songRanges (not using specifyPlacement)');
        }

        console.log('[RESUBMIT] Complete settings:', completeSettings);
        
        const submitData = {
          originalJobId: jobId,
          changes: completeSettings
        };
        
        // STEP 1: Upload PowerPoint file to S3 if present
        if (newPptxFile) {
          console.log('[UPLOAD] Getting presigned URL for PowerPoint...');
          
          const urlResponse = await fetch(`${API_BASE}/generate-upload-url`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              jobId: jobId,
              fileType: 'presentation',
              fileExtension: 'pptx'
            })
          });
          
          if (!urlResponse.ok) throw new Error('Failed to get PowerPoint upload URL');
          
          const {uploadUrl, s3Key} = await urlResponse.json();
          
          console.log('[UPLOAD] Uploading PowerPoint to S3...');
          
          const uploadResponse = await fetch(uploadUrl, {
            method: 'PUT',
            headers: {'Content-Type': 'application/vnd.openxmlformats-officedocument.presentationml.presentation'},
            body: newPptxFile
          });
          
          if (!uploadResponse.ok) throw new Error('Failed to upload PowerPoint');
          
          submitData.changes.newPresentationS3Key = s3Key;
          console.log('[UPLOAD] PowerPoint uploaded successfully');
        }
        
        // STEP 2: Upload new songs to S3 if present
        const newSongFiles = currentSongs.filter(s => s.isNew && s.file);
        
        if (newSongFiles.length > 0) {
          const uploadedSongs = [];
          
          for (let i = 0; i < newSongFiles.length; i++) {
            const song = newSongFiles[i];
            
            console.log(`[UPLOAD] Getting presigned URL for song ${i + 1}...`);
            
            const urlResponse = await fetch(`${API_BASE}/generate-upload-url`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                jobId: jobId,
                fileType: 'song',
                fileNumber: i + 1,
                fileExtension: 'mp3'
              })
            });
            
            if (!urlResponse.ok) throw new Error(`Failed to get upload URL for song ${i + 1}`);
            
            const {uploadUrl, s3Key} = await urlResponse.json();
            
            console.log(`[UPLOAD] Uploading song ${i + 1} to S3...`);
            
            const uploadResponse = await fetch(uploadUrl, {
              method: 'PUT',
              headers: {'Content-Type': 'audio/mpeg'},
              body: song.file
            });
            
            if (!uploadResponse.ok) throw new Error(`Failed to upload song ${i + 1}`);
            
            uploadedSongs.push({
              originalName: song.name,
              s3Key: s3Key
            });
            
            console.log(`[UPLOAD] Song ${i + 1} uploaded successfully`);
          }
          
          submitData.changes.newSongs = uploadedSongs;
          console.log('[UPLOAD] All songs uploaded');
        }
        
        // Add manualEditsRequested flag if it was set
        if (pendingChanges.manualEditsRequested) {
          submitData.changes.manualEditsRequested = true;
        }
        
        // STEP 3: Submit metadata to resubmit API
        console.log('[RESUBMIT] Submitting to API...');
        console.log('[RESUBMIT] Payload:', JSON.stringify(submitData, null, 2));
        showToast('Processing changes...', 'success');
        
        const response = await fetch(`${API_BASE}/jobs/${jobId}/resubmit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(submitData)
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || errorData.details || `HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('[RESUBMIT] Success:', result);
        
        showToast(
          `‚úÖ Video resubmitted successfully! New job: ${result.newJobId}. ` +
          'You\'ll receive an email in 5-15 minutes.',
          'success'
        );
        
        // Clear changes and disable button
        pendingChanges = {};
        newPptxFile = null;
        updateResubmitButton();
        
        // Hide edit sections after 2 seconds
        setTimeout(() => {
          document.getElementById('editSections').style.display = 'none';
          document.getElementById('editBtn').innerHTML = '‚úèÔ∏è Edit & Resubmit';
        }, 2000);
        
      } catch (error) {
        console.error('[RESUBMIT ERROR]', error);
        showToast('Failed to resubmit: ' + error.message, 'error');
      }
    });
  </script>
</body>
</html>
