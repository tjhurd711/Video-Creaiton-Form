<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Memorial Video</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    
    .content {
      padding: 30px;
    }
    
    /* Video Player Section */
    .video-section {
      margin-bottom: 30px;
    }
    
    .video-wrapper {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    video {
      width: 100%;
      display: block;
    }
    
    .loading {
      padding: 100px 20px;
      text-align: center;
      color: #999;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      padding: 30px;
      background: #fee;
      border-left: 4px solid #e33;
      border-radius: 8px;
      color: #c33;
    }
    
    /* Action Buttons */
    .actions {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    
    .btn-primary:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }
    
    .btn-secondary {
      background: #2196F3;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #0b7dda;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }
    
    .btn-outline {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }
    
    .btn-outline:hover {
      background: #667eea;
      color: white;
    }

    .btn-edit {
      background: #FF9800;
      color: white;
    }

    .btn-edit:hover {
      background: #f57c00;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
    }
    
    /* Edit Sections */
    .edit-sections {
      border-top: 2px solid #f0f0f0;
      padding-top: 30px;
      margin-top: 30px;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 25px;
    }
    
    .section-header h2 {
      font-size: 22px;
      color: #333;
    }
    
    .section-header .badge {
      background: #667eea;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .edit-option {
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    
    .edit-option:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }
    
    .edit-option-header {
      padding: 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    
    .edit-option-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
    }
    
    .edit-option-icon {
      font-size: 24px;
    }
    
    .chevron {
      font-size: 20px;
      transition: transform 0.3s;
      color: #999;
    }
    
    .edit-option.expanded .chevron {
      transform: rotate(180deg);
    }
    
    .edit-option-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding: 0 20px;
    }
    
    .edit-option.expanded .edit-option-content {
      max-height: 2000px;
      padding: 0 20px 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
      font-size: 14px;
    }

    .form-group .help-text {
      font-size: 13px;
      color: #777;
      font-weight: 400;
      margin-top: 4px;
    }
    
    .form-group select,
    .form-group input[type="number"],
    .form-group input[type="file"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    
    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .radio-option {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .radio-option:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .radio-option.selected {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    .radio-option input[type="radio"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin-top: 2px;
      flex-shrink: 0;
    }

    .radio-option-content {
      flex: 1;
    }

    .radio-option-label {
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    .radio-option-desc {
      font-size: 13px;
      color: #666;
    }

    .conditional-input {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border-radius: 6px;
    }
    
    .placeholder {
      padding: 20px;
      background: #fff9e6;
      border: 2px dashed #ffd700;
      border-radius: 8px;
      text-align: center;
      color: #886600;
      font-style: italic;
    }

    .info-box {
      padding: 16px;
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #1565c0;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .song-list {
      margin-bottom: 20px;
    }

    .song-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }

    .song-item:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .song-item.new-upload {
      border-color: #4CAF50;
      background: #f1f8f4;
    }

    .song-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .song-position {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .song-item:hover .song-position {
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .song-name {
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .song-badge {
      background: #4CAF50;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .song-controls {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }

    .btn-play {
      background: #2196F3;
      color: white;
    }

    .btn-play:hover {
      background: #0b7dda;
    }

    .btn-play.playing {
      background: #FF9800;
    }

    .btn-move {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #ddd;
    }

    .btn-move:hover {
      background: #e0e0e0;
    }

    .btn-move:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    .upload-section {
      margin-top: 15px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
      border: 2px dashed #ccc;
    }

    .upload-section.max-reached {
      opacity: 0.6;
      pointer-events: none;
    }

    .upload-label {
      display: inline-block;
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }

    .upload-label:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }

    .upload-label.disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Song Range Sliders */
    .song-ranges-container {
      margin-top: 15px;
    }

    .song-range-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
    }

    .song-range-header {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slide-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .slide-input-group {
      display: flex;
      flex-direction: column;
    }

    .slide-input-group label {
      font-size: 13px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
    }

    .slide-input-group input {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }

    .slide-input-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    /* Resubmit Button */
    .resubmit-section {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 2px solid #f0f0f0;
      text-align: center;
    }
    
    .btn-resubmit {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 18px 40px;
      font-size: 18px;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-resubmit:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    }
    
    .btn-resubmit:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Notification Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 16px 24px;
      background: #333;
      color: white;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
      max-width: 400px;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .toast.success {
      background: #4CAF50;
    }
    
    .toast.error {
      background: #f44336;
    }
    
    @media (max-width: 768px) {
      .header h1 { font-size: 24px; }
      .actions { flex-direction: column; }
      .btn { width: 100%; justify-content: center; }
      .toast { right: 20px; left: 20px; max-width: none; }
      .slide-inputs { grid-template-columns: 1fr; }
      .song-controls { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>✨ Your Memorial Video</h1>
      <p id="jobInfo">Loading...</p>
    </div>
    
    <div class="content">
      <!-- Video Player Section -->
      <div class="video-section">
        <div id="videoContainer" class="loading">
          <div class="spinner"></div>
          <p>Loading your video...</p>
        </div>
      </div>
      
      <!-- Primary Actions -->
      <div class="actions" id="actionButtons">
        <button id="editBtn" class="btn btn-edit" style="display:none;">
          ✏️ Edit & Resubmit
        </button>
        <button id="finalizeBtn" class="btn btn-primary" style="display:none;">
          ✅ I'm Finished (Download Video)
        </button>
        <button id="shareBtn" class="btn btn-secondary" style="display:none;">
          🔗 Share Video
        </button>
      </div>
      
      <!-- Finalized State -->
      <div id="finalizedMessage" style="display:none;">
        <div style="background: #e8f5e9; border: 2px solid #4CAF50; border-radius: 12px; padding: 30px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 15px;">✅</div>
          <h2 style="color: #2e7d32; margin-bottom: 10px;">Order Complete!</h2>
          <p style="color: #555; margin-bottom: 20px;">Your memorial video has been finalized. A backup copy has been sent to your email.</p>
          <a id="finalDownloadBtn" href="#" class="btn btn-primary">
            📥 Download Video Again
          </a>
        </div>
      </div>
      
      <!-- Edit Sections -->
      <div class="edit-sections" id="editSections" style="display:none;">
        <div class="section-header">
          <h2>✏️ Make Changes to Your Video</h2>
        </div>
        
        <!-- Change Songs (MOVED TO TOP) -->
        <div class="edit-option" data-section="songs">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">🎵</span>
              <span>Change Songs</span>
            </div>
            <span class="chevron">▼</span>
          </div>
          <div class="edit-option-content">
            <div class="form-group">
              <label>Your Songs (drag to reorder, max 6 total)</label>
              <div id="songList" class="song-list">
                <!-- Will be populated dynamically -->
              </div>
            </div>
            
            <div class="upload-section" id="uploadSection">
              <label class="upload-label" id="uploadLabel">
                📤 Upload New Songs (MP3)
                <input type="file" id="newSongUpload" accept=".mp3,audio/mpeg" multiple style="display: none;">
              </label>
              <div style="margin-top: 8px; font-size: 13px; color: #666;">
                <span id="songCountDisplay">0 of 6 songs</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Change Transitions -->
        <div class="edit-option" data-section="transitions">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">🎨</span>
              <span>Change Transitions</span>
            </div>
            <span class="chevron">▼</span>
          </div>
          <div class="edit-option-content">
            <div class="form-group">
              <label for="visualPackage">
                Visual Package
                <div class="help-text">Choose the style of transitions between slides</div>
              </label>
              <select id="visualPackage" name="visualPackage">
                <option value="">-- Select a package --</option>
                <option value="simple-fade-wipe">Simple Fade & Wipe</option>
                <option value="pages-of-life">Pages of Life</option>
                <option value="floating-frames">Floating Frames</option>
                <option value="zoom-through">Zoom Through</option>
                <option value="blinds-combs-bars">Blinds, Combs & Bars</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Change Timing -->
        <div class="edit-option" data-section="timing">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">⏱️</span>
              <span>Change Video Length</span>
            </div>
            <span class="chevron">▼</span>
          </div>
          <div class="edit-option-content">
            <div class="form-group">
              <label>Timing Mode</label>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" name="timingMode" value="perSlide">
                  <div class="radio-option-content">
                    <span class="radio-option-label">Per Slide Duration</span>
                    <span class="radio-option-desc">Set how many seconds each slide should display</span>
                    <div class="conditional-input" id="perSlideInput" style="display:none;">
                      <label for="perSlideSec" style="font-size: 13px; margin-bottom: 6px;">Seconds per slide:</label>
                      <input type="number" id="perSlideSec" name="perSlideSec" min="2" max="30" value="5" style="padding: 8px;">
                    </div>
                  </div>
                </label>
                
                <label class="radio-option">
                  <input type="radio" name="timingMode" value="fixedRuntime">
                  <div class="radio-option-content">
                    <span class="radio-option-label">Fixed Total Runtime</span>
                    <span class="radio-option-desc">Set the total video length in seconds</span>
                    <div class="conditional-input" id="fixedRuntimeInput" style="display:none;">
                      <label for="fixedRuntimeSec" style="font-size: 13px; margin-bottom: 6px;">Total runtime (seconds):</label>
                      <input type="number" id="fixedRuntimeSec" name="fixedRuntimeSec" min="30" max="1800" value="320" style="padding: 8px;">
                    </div>
                  </div>
                </label>
                
                <label class="radio-option">
                  <input type="radio" name="timingMode" value="fitToSongs">
                  <div class="radio-option-content">
                    <span class="radio-option-label">Fit to Music Length</span>
                    <span class="radio-option-desc">Video duration matches your music (automatic)</span>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Change Song Logic -->
        <div class="edit-option" data-section="songlogic">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">🎼</span>
              <span>Change Song Logic</span>
            </div>
            <span class="chevron">▼</span>
          </div>
          <div class="edit-option-content">
            <div class="form-group">
              <label for="musicDistribution">
                Music Distribution
                <div class="help-text">How songs should be spread across the video</div>
              </label>
              <select id="musicDistribution" name="musicDistribution">
                <option value="">-- Select distribution --</option>
                <option value="evenlyDistributed">Evenly Distributed</option>
                <option value="specifyPlacement">Specify Placement</option>
              </select>
            </div>

            <!-- Conditional Song Range Sliders -->
            <div id="songRangesContainer" class="song-ranges-container" style="display:none;">
              <div class="info-box">
                📍 Specify which slides each song should play during. The backend will automatically prevent overlaps and fill gaps.
              </div>
              <div id="songRangesList">
                <!-- Will be populated dynamically based on number of songs -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Manual Changes -->
        <div class="edit-option" data-section="manual">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">✏️</span>
              <span>Make Manual Changes</span>
            </div>
            <span class="chevron">▼</span>
          </div>
          <div class="edit-option-content">
            <div class="info-box">
              Edit your presentation directly, then come back here and click "Resubmit Changes" to create a new video with your edits.
            </div>
            <div id="manualEditButtons" class="button-group">
              <!-- Buttons will be populated based on presentation type -->
            </div>
          </div>
        </div>
        
        <!-- Resubmit Section -->
        <div class="resubmit-section">
          <button id="resubmitBtn" class="btn-resubmit" disabled>
            🚀 Resubmit Changes
          </button>
          <p style="margin-top:12px; color:#999; font-size:14px;">
            Make changes above, then click to create a new video
          </p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>
  
  <script>
    // Configuration
    const API_BASE = 'https://4hyy6kr2id.execute-api.us-east-2.amazonaws.com/prod';
    const MAX_SONGS = 6;
    
    // Parse job ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const jobId = urlParams.get('job');
    const isFinalized = urlParams.get('finalized') === 'true';
    
    // Track changes made by user
    let pendingChanges = {};
    let currentSettings = {};
    let currentSongs = []; // Array of {id, name, url, isNew, file}
    let currentlyPlayingAudio = null;
    
    // Prevent going back if finalized
    if (isFinalized) {
      history.pushState(null, null, location.href);
      history.pushState(null, null, location.href);
      
      window.addEventListener('popstate', function(event) {
        history.pushState(null, null, location.href);
      });
    }
    
    if (!jobId) {
      showError('No job ID provided in URL. Please check your link.');
    } else {
      loadJobData(jobId);
    }
    
    // Load job data from API
    async function loadJobData(jobId) {
      try {
        console.log('[API] Calling:', `${API_BASE}/jobs/${jobId}`);
        const response = await fetch(`${API_BASE}/jobs/${jobId}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('[API] Response:', data);
        
        // Store current settings
        if (data.settings) {
          currentSettings = data.settings;
          populateFormDefaults(data.settings);
        }
        
        // Initialize songs from API response
        if (data.songs && data.songs.length > 0) {
          // Backend provides songs array with URLs
          currentSongs = data.songs.map(song => ({
            id: song.name,
            name: song.name,
            displayName: song.displayName || song.name,
            url: song.url,
            isNew: false,
            file: null
          }));
        } else if (data.settings && data.settings.audioCount > 0) {
          // Fallback: use audioCount to generate song list
          const audioCount = data.settings.audioCount;
          for (let i = 1; i <= audioCount; i++) {
            currentSongs.push({
              id: `song${i}.mp3`,
              name: `song${i}.mp3`,
              displayName: `Song ${i}.mp3`,
              url: null, // No URL yet (backend needs to provide)
              isNew: false,
              file: null
            });
          }
        }
        
        // Auto-redirect to finalized page if job is already finalized
        if (data.isFinalized && !isFinalized) {
          console.log('[REDIRECT] Job is finalized, redirecting...');
          window.location.replace(`${window.location.origin}${window.location.pathname}?job=${jobId}&finalized=true`);
          return;
        }
        
        displayVideo(data);
        setupManualEditButtons(data);
        renderSongList();
        updateSongCount();
      } catch (error) {
        console.error('[API ERROR]', error);
        showError('Failed to load video data: ' + error.message);
      }
    }
    
    // Populate form defaults from settings
    function populateFormDefaults(settings) {
      // Transitions
      if (settings.visualPackage) {
        document.getElementById('visualPackage').value = settings.visualPackage;
      }
      
      // Timing
      if (settings.timingMode) {
        const radio = document.querySelector(`input[name="timingMode"][value="${settings.timingMode}"]`);
        if (radio) {
          radio.checked = true;
          handleTimingModeChange(settings.timingMode);
        }
      }
      if (settings.perSlideSec) {
        document.getElementById('perSlideSec').value = settings.perSlideSec;
      }
      if (settings.fixedRuntimeSec) {
        document.getElementById('fixedRuntimeSec').value = settings.fixedRuntimeSec;
      }
      
      // Song Logic
      if (settings.musicDistribution) {
        document.getElementById('musicDistribution').value = settings.musicDistribution;
        handleMusicDistributionChange(settings.musicDistribution);
      }
    }
    
    // Render song list
    function renderSongList() {
      const container = document.getElementById('songList');
      
      if (currentSongs.length === 0) {
        container.innerHTML = '<div style="color: #999; font-style: italic;">No songs yet. Upload some MP3s below!</div>';
        return;
      }
      
      let html = '';
      currentSongs.forEach((song, index) => {
        const audioId = `audio-${song.id}`;
        const newBadge = song.isNew ? '<span class="song-badge">NEW</span>' : '';
        const itemClass = song.isNew ? 'song-item new-upload' : 'song-item';
        const position = index + 1; // 1-indexed position
        
        html += `
          <div class="${itemClass}">
            <div class="song-info">
              <div class="song-position">${position}</div>
              <span class="song-name">🎵 ${song.displayName}</span>
              ${newBadge}
            </div>
            <div class="song-controls">
              ${song.url ? `<button class="btn-small btn-play" onclick="togglePlay('${audioId}', this)">▶️</button>` : ''}
              <button class="btn-small btn-move" onclick="moveSongUp(${index})" ${index === 0 ? 'disabled' : ''}>⬆️</button>
              <button class="btn-small btn-move" onclick="moveSongDown(${index})" ${index === currentSongs.length - 1 ? 'disabled' : ''}>⬇️</button>
              <button class="btn-small btn-danger" onclick="removeSong(${index})">🗑️</button>
            </div>
            ${song.url ? `<audio id="${audioId}" src="${song.url}" preload="none"></audio>` : ''}
          </div>
        `;
      });
      
      container.innerHTML = html;
      updateSongTracking();
    }
    
    // Toggle audio play/pause
    function togglePlay(audioId, button) {
      const audio = document.getElementById(audioId);
      
      // Stop currently playing audio
      if (currentlyPlayingAudio && currentlyPlayingAudio !== audio) {
        currentlyPlayingAudio.pause();
        currentlyPlayingAudio.currentTime = 0;
        // Reset button of previously playing audio
        document.querySelectorAll('.btn-play').forEach(btn => {
          btn.textContent = '▶️';
          btn.classList.remove('playing');
        });
      }
      
      if (audio.paused) {
        audio.play();
        button.textContent = '⏸️';
        button.classList.add('playing');
        currentlyPlayingAudio = audio;
        
        // Reset button when audio ends
        audio.onended = () => {
          button.textContent = '▶️';
          button.classList.remove('playing');
          currentlyPlayingAudio = null;
        };
      } else {
        audio.pause();
        audio.currentTime = 0;
        button.textContent = '▶️';
        button.classList.remove('playing');
        currentlyPlayingAudio = null;
      }
    }
    
    // Move song up
    function moveSongUp(index) {
      if (index === 0) return;
      const temp = currentSongs[index];
      currentSongs[index] = currentSongs[index - 1];
      currentSongs[index - 1] = temp;
      renderSongList();
      updateSongRangeSliders();
    }
    
    // Move song down
    function moveSongDown(index) {
      if (index === currentSongs.length - 1) return;
      const temp = currentSongs[index];
      currentSongs[index] = currentSongs[index + 1];
      currentSongs[index + 1] = temp;
      renderSongList();
      updateSongRangeSliders();
    }
    
    // Remove song
    function removeSong(index) {
      if (!confirm(`Remove "${currentSongs[index].displayName}"?`)) return;
      currentSongs.splice(index, 1);
      renderSongList();
      updateSongCount();
      updateSongRangeSliders();
    }
    
    // Update song count display
    function updateSongCount() {
      const display = document.getElementById('songCountDisplay');
      const uploadSection = document.getElementById('uploadSection');
      const uploadLabel = document.getElementById('uploadLabel');
      
      display.textContent = `${currentSongs.length} of ${MAX_SONGS} songs`;
      
      if (currentSongs.length >= MAX_SONGS) {
        uploadSection.classList.add('max-reached');
        uploadLabel.classList.add('disabled');
      } else {
        uploadSection.classList.remove('max-reached');
        uploadLabel.classList.remove('disabled');
      }
    }
    
    // Handle new song uploads
    document.getElementById('newSongUpload').addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      
      files.forEach(file => {
        if (currentSongs.length >= MAX_SONGS) {
          showToast(`Maximum ${MAX_SONGS} songs reached`, 'error');
          return;
        }
        
        if (!file.type.includes('audio/mpeg') && !file.name.endsWith('.mp3')) {
          showToast(`${file.name} is not an MP3 file`, 'error');
          return;
        }
        
        // Add to current songs
        currentSongs.push({
          id: `new-${Date.now()}-${Math.random()}`,
          name: file.name,
          displayName: file.name,
          url: null, // No URL yet (will be uploaded on resubmit)
          isNew: true,
          file: file
        });
      });
      
      renderSongList();
      updateSongCount();
      updateSongRangeSliders();
      
      // Reset file input
      e.target.value = '';
    });
    
    // Track song changes for resubmit
    function updateSongTracking() {
      // Build songOrder array for backend
      const songOrder = currentSongs.map(song => song.name);
      const newSongs = currentSongs.filter(s => s.isNew).map(s => ({
        originalName: s.name,
        file: s.file
      }));
      
      // Only track if there are changes
      const hasChanges = currentSongs.some(s => s.isNew) || 
                        JSON.stringify(songOrder) !== JSON.stringify(currentSongs.map(s => s.name));
      
      if (hasChanges || newSongs.length > 0) {
        trackChange('songOrder', songOrder);
        if (newSongs.length > 0) {
          trackChange('newSongs', newSongs);
        }
      }
    }
    
    // Setup song range sliders (called when musicDistribution changes or song count changes)
    function setupSongRangeSliders() {
      const container = document.getElementById('songRangesList');
      
      if (currentSongs.length === 0) {
        container.innerHTML = '<div style="color: #999; font-style: italic;">No songs available. Add songs first.</div>';
        return;
      }
      
      let html = '';
      currentSongs.forEach((song, index) => {
        html += `
          <div class="song-range-item">
            <div class="song-range-header">
              🎵 ${song.displayName}
            </div>
            <div class="slide-inputs">
              <div class="slide-input-group">
                <label>Start Slide</label>
                <input type="number" 
                       id="songRange${index}Start" 
                       class="song-range-input"
                       data-song-index="${index}"
                       data-type="start"
                       min="1" 
                       max="250" 
                       placeholder="e.g., 1">
              </div>
              <div class="slide-input-group">
                <label>End Slide</label>
                <input type="number" 
                       id="songRange${index}End" 
                       class="song-range-input"
                       data-song-index="${index}"
                       data-type="end"
                       min="1" 
                       max="250" 
                       placeholder="e.g., 50">
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      
      // Add event listeners to all song range inputs
      document.querySelectorAll('.song-range-input').forEach(input => {
        input.addEventListener('input', handleSongRangeChange);
      });
    }
    
    // Update song range sliders when song count changes
    function updateSongRangeSliders() {
      const musicDist = document.getElementById('musicDistribution').value;
      if (musicDist === 'specifyPlacement') {
        setupSongRangeSliders();
      }
    }
    
    // Handle song range input changes
    function handleSongRangeChange() {
      const songRanges = [];
      
      currentSongs.forEach((song, index) => {
        const startInput = document.getElementById(`songRange${index}Start`);
        const endInput = document.getElementById(`songRange${index}End`);
        
        if (startInput && endInput) {
          const startVal = parseInt(startInput.value);
          const endVal = parseInt(endInput.value);
          
          // Only include if both values are provided
          if (!isNaN(startVal) && !isNaN(endVal)) {
            songRanges.push({
              song: song.name,
              startSlide: startVal,
              endSlide: endVal
            });
          }
        }
      });
      
      // Track changes
      if (songRanges.length > 0) {
        trackChange('songRanges', songRanges);
      } else {
        delete pendingChanges.songRanges;
        updateResubmitButton();
      }
      
      console.log('[SONG RANGES]', songRanges);
    }
    
    // Handle music distribution change
    function handleMusicDistributionChange(value) {
      const container = document.getElementById('songRangesContainer');
      
      if (value === 'specifyPlacement') {
        container.style.display = 'block';
        setupSongRangeSliders();
      } else {
        container.style.display = 'none';
        // Clear songRanges from pending changes if switching away
        delete pendingChanges.songRanges;
        updateResubmitButton();
      }
    }
    
    // Setup manual edit buttons based on presentation type
    function setupManualEditButtons(data) {
      const container = document.getElementById('manualEditButtons');
      
      if (data.presentationType === 'google_slides' && data.slides_url) {
        container.innerHTML = `
          <button class="btn btn-primary" onclick="window.open('${data.slides_url}', '_blank')">
            📊 Open in Google Slides
          </button>
        `;
      } else if (data.presentationType === 'powerpoint' && data.pptx_url) {
        container.innerHTML = `
          <a href="${data.pptx_url}" download class="btn btn-primary">
            📥 Download PowerPoint
          </a>
        `;
      } else {
        container.innerHTML = `
          <div style="color: #999; font-style: italic;">
            Presentation files not available for this job.
          </div>
        `;
      }
    }
    
    // Display video and controls
    function displayVideo(data) {
      const container = document.getElementById('videoContainer');
      const jobInfo = document.getElementById('jobInfo');
      
      // Update header
      jobInfo.textContent = `Order #${data.jobId}`;
      
      // Check if finalized
      if (isFinalized) {
        container.innerHTML = `
          <div class="video-wrapper">
            <video controls preload="auto">
              <source src="${data.videoUrl}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>
        `;
        
        document.getElementById('actionButtons').style.display = 'none';
        document.getElementById('finalizedMessage').style.display = 'block';
        document.getElementById('finalDownloadBtn').href = data.downloadUrl || data.videoUrl;
        return;
      }
      
      // Create video element
      container.innerHTML = `
        <div class="video-wrapper">
          <video controls preload="auto" crossorigin="anonymous">
            <source src="${data.videoUrl}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        </div>
      `;
      
      // Video event listeners
      const video = container.querySelector('video');
      video.addEventListener('loadstart', () => console.log('[VIDEO] Loading started'));
      video.addEventListener('loadedmetadata', () => console.log('[VIDEO] Metadata loaded'));
      video.addEventListener('canplay', () => console.log('[VIDEO] Can play'));
      video.addEventListener('error', (e) => {
        console.error('[VIDEO ERROR]', e);
        console.error('[VIDEO ERROR] Details:', video.error);
        showError('Video failed to load. The file may be corrupted or the URL expired.');
      });
      
      // Show action buttons
      document.getElementById('editBtn').style.display = 'inline-flex';
      document.getElementById('finalizeBtn').style.display = 'inline-flex';
      document.getElementById('shareBtn').style.display = 'inline-flex';
      
      // Store video data globally
      window.videoData = data;
      
      // Setup handlers
      setupFinalizeButton();
      setupEditButton();
    }
    
    // Show error message
    function showError(message) {
      const container = document.getElementById('videoContainer');
      container.innerHTML = `<div class="error">${message}</div>`;
    }
    
    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }
    
    // Edit button handler - toggles edit sections
    function setupEditButton() {
      document.getElementById('editBtn').addEventListener('click', () => {
        const editSections = document.getElementById('editSections');
        const isVisible = editSections.style.display !== 'none';
        
        if (isVisible) {
          editSections.style.display = 'none';
          document.getElementById('editBtn').innerHTML = '✏️ Edit & Resubmit';
        } else {
          editSections.style.display = 'block';
          document.getElementById('editBtn').innerHTML = '❌ Hide Edit Options';
          // Scroll to edit sections
          editSections.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }
    
    // Finalize button handler
    function setupFinalizeButton() {
      document.getElementById('finalizeBtn').addEventListener('click', async () => {
        const confirmed = confirm(
          "Are you sure? You won't be able to make anymore edits to the final video. " +
          "You will also be emailed a final copy as a backup."
        );
        
        if (!confirmed) return;
        
        try {
          // Download the video
          const downloadUrl = window.videoData.downloadUrl || window.videoData.videoUrl;
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = `memorial_video_${jobId}.mp4`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Call finalize API
          showToast('Finalizing your order...', 'success');
          const response = await fetch(`${API_BASE}/jobs/${jobId}/finalize`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error('Failed to finalize order');
          }
          
          // Redirect to finalized page
          const finalizedUrl = `${window.location.origin}${window.location.pathname}?job=${jobId}&finalized=true`;
          history.replaceState(null, '', finalizedUrl);
          location.reload();
          
        } catch (error) {
          console.error('[FINALIZE ERROR]', error);
          showToast('Download started, but email failed. Please contact support.', 'error');
        }
      });
    }
    
    // Share button handler
    document.getElementById('shareBtn').addEventListener('click', async () => {
      try {
        const shareUrl = `${window.location.origin}${window.location.pathname}?job=${jobId}`;
        await navigator.clipboard.writeText(shareUrl);
        showToast('Share link copied to clipboard!');
      } catch (error) {
        showToast('Failed to copy link: ' + error.message, 'error');
      }
    });
    
    // Edit section expansion
    document.querySelectorAll('.edit-option-header').forEach(header => {
      header.addEventListener('click', () => {
        const option = header.closest('.edit-option');
        option.classList.toggle('expanded');
      });
    });
    
    // Track form changes for all inputs
    function trackChange(fieldName, value) {
      if (value === '' || value === null || value === undefined) {
        delete pendingChanges[fieldName];
      } else {
        pendingChanges[fieldName] = value;
      }
      updateResubmitButton();
      console.log('[CHANGES]', pendingChanges);
    }
    
    // Update resubmit button state
    function updateResubmitButton() {
      const btn = document.getElementById('resubmitBtn');
      const hasChanges = Object.keys(pendingChanges).length > 0;
      btn.disabled = !hasChanges;
      
      if (hasChanges) {
        btn.textContent = `🚀 Resubmit Changes (${Object.keys(pendingChanges).length})`;
      } else {
        btn.textContent = '🚀 Resubmit Changes';
      }
    }
    
    // Setup change tracking for all form elements
    document.getElementById('visualPackage').addEventListener('change', (e) => {
      trackChange('visualPackage', e.target.value);
    });
    
    // Timing mode radio buttons
    document.querySelectorAll('input[name="timingMode"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const mode = e.target.value;
        handleTimingModeChange(mode);
        trackChange('timingMode', mode);
        
        // Track the associated value
        if (mode === 'perSlide') {
          trackChange('perSlideSec', document.getElementById('perSlideSec').value);
        } else if (mode === 'fixedRuntime') {
          trackChange('fixedRuntimeSec', document.getElementById('fixedRuntimeSec').value);
        }
      });
    });
    
    function handleTimingModeChange(mode) {
      // Hide all conditional inputs
      document.getElementById('perSlideInput').style.display = 'none';
      document.getElementById('fixedRuntimeInput').style.display = 'none';
      
      // Remove selected class from all options
      document.querySelectorAll('.radio-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      // Show the selected one
      const selectedRadio = document.querySelector(`input[name="timingMode"][value="${mode}"]`);
      if (selectedRadio) {
        selectedRadio.closest('.radio-option').classList.add('selected');
        
        if (mode === 'perSlide') {
          document.getElementById('perSlideInput').style.display = 'block';
        } else if (mode === 'fixedRuntime') {
          document.getElementById('fixedRuntimeInput').style.display = 'block';
        }
      }
    }
    
    document.getElementById('perSlideSec').addEventListener('input', (e) => {
      trackChange('perSlideSec', parseFloat(e.target.value));
    });
    
    document.getElementById('fixedRuntimeSec').addEventListener('input', (e) => {
      trackChange('fixedRuntimeSec', parseFloat(e.target.value));
    });
    
    // Song logic fields
    document.getElementById('musicDistribution').addEventListener('change', (e) => {
      const value = e.target.value;
      trackChange('musicDistribution', value);
      handleMusicDistributionChange(value);
    });
    
    // Resubmit button handler
    document.getElementById('resubmitBtn').addEventListener('click', async () => {
      if (Object.keys(pendingChanges).length === 0) {
        showToast('No changes to submit', 'error');
        return;
      }
      
      const confirmed = confirm(
        `Create a new video with ${Object.keys(pendingChanges).length} change(s)?\n\n` +
        'You will receive an email in 5-15 minutes with your new video.'
      );
      
      if (!confirmed) return;
      
      try {
        showToast('Submitting changes...', 'success');
        
        console.log('[RESUBMIT] Sending changes:', pendingChanges);
        
        // Note: newSongs with File objects can't be sent as JSON
        // Backend will need to handle file uploads separately via presigned URLs
        const submitData = {
          originalJobId: jobId,
          changes: {...pendingChanges}
        };
        
        // Remove file objects from changes (backend will handle via presigned URLs)
        if (submitData.changes.newSongs) {
          submitData.changes.newSongs = submitData.changes.newSongs.map(s => ({
            originalName: s.originalName
          }));
        }
        
        // Call resubmit API
        const response = await fetch(`${API_BASE}/jobs/${jobId}/resubmit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(submitData)
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || `HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('[RESUBMIT] Success:', result);
        
        showToast(
          `✅ Video resubmitted successfully! New job: ${result.newJobId || 'pending'}. ` +
          'You\'ll receive an email in 5-15 minutes.',
          'success'
        );
        
        // Clear changes and disable button
        pendingChanges = {};
        updateResubmitButton();
        
        // Hide edit sections after 2 seconds
        setTimeout(() => {
          document.getElementById('editSections').style.display = 'none';
          document.getElementById('editBtn').innerHTML = '✏️ Edit & Resubmit';
        }, 2000);
        
      } catch (error) {
        console.error('[RESUBMIT ERROR]', error);
        showToast('Failed to resubmit: ' + error.message, 'error');
      }
    });
  </script>
</body>
</html>
