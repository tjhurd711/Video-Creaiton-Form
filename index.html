<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Memorial Video</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml"
        href="https://www.dropbox.com/scl/fi/7tqrvmnchu17tkatqa9l5/MemorialVideoAI-Favicon.svg?rlkey=5cj4gwyhq3frrupo1g1d3y8so&st=znzwkpy9&raw=1">

  <!-- === Google Fonts (non-blocking load) === -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap"
    rel="stylesheet"
    media="print"
    onload="this.media='all'">
  <noscript>
    <link
      href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap"
      rel="stylesheet">
  </noscript>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    
    body {
      font-family: 'Atkinson Hyperlegible', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(180deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 950px;
      margin: 0 auto;
      background: #d0a789;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .header-logo {
      max-width: 500px;
      height: auto;
      margin-bottom: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    
    .content {
      padding: 30px 40px;
    }
    
    /* Summary Sentence */
    .summary-box {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border-left: 4px solid #2a5298;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      font-size: 16px;
      line-height: 1.6;
      color: #333;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
    }
    
    .summary-box strong {
      color: #2a5298;
      font-weight: 700;
    }
    
    /* Video Player Section */
    .video-section {
      margin-bottom: 30px;
    }
    
    .video-wrapper {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    video {
      width: 100%;
      display: block;
    }
    
    .loading {
      padding: 100px 20px;
      text-align: center;
      color: #999;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2a5298;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      padding: 30px;
      background: #fee;
      border-left: 4px solid #e33;
      border-radius: 8px;
      color: #c33;
    }
    
    /* Action Buttons */
    .actions {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    /* Top Row Actions - 4 Equal Buttons */
    #actionButtons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    #actionButtons .btn {
      width: 200px;
      flex: 0 0 200px;
      justify-content: center;
      padding: 20px 12px;
      font-size: 14px;
      line-height: 1.3;
    }
    
    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    
    .btn-primary:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }
    
    .btn-secondary {
      background: #2196F3;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #0b7dda;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }
    
    .btn-outline {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }
    
    .btn-outline:hover {
      background: #667eea;
      color: white;
    }

    .btn-edit {
      background: #FF9800;
      color: white;
    }

    .btn-edit:hover {
      background: #f57c00;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
    }
    
    /* Edit Sections */
    .edit-sections {
      border-top: 2px solid #f0f0f0;
      padding-top: 30px;
      margin-top: 30px;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 25px;
    }
    
    .section-header h2 {
      font-size: 22px;
      color: #333;
    }
    
    .section-header .badge {
      background: #667eea;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .edit-option {
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    
    .edit-option:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }
    
    .edit-option-header {
      padding: 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    
    .edit-option-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
    }
    
    .edit-option-icon {
      font-size: 24px;
    }
    
    .chevron {
      font-size: 20px;
      transition: transform 0.3s;
      color: #999;
    }
    
    .edit-option.expanded .chevron {
      transform: rotate(180deg);
    }
    
    .edit-option-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding: 0 20px;
    }
    
    .edit-option.expanded .edit-option-content {
      max-height: 3000px;
      padding: 0 20px 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
      font-size: 14px;
    }

    .form-group .help-text {
      font-size: 13px;
      color: #777;
      font-weight: 400;
      margin-top: 4px;
    }
    
    .form-group select,
    .form-group input[type="number"],
    .form-group input[type="file"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    
    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .radio-option {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .radio-option:hover {
      border-color: #2a5298;
      background: #f8f9ff;
    }
    
    .radio-option.selected {
      border-color: #2a5298;
      background: #f8f9ff;
    }
    
    .radio-option input[type="radio"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin-top: 1px;
      flex-shrink: 0;
    }
    
    .radio-option-content {
      flex: 1;
    }
    
    .radio-option-label {
      font-weight: 600;
      display: inline-block;
      line-height: 20px;
      vertical-align: top;
    }
    
    .radio-option-desc {
      font-size: 13px;
      color: #666;
      display: block;
      margin-top: 4px;
    }
    
    .conditional-input {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border-radius: 6px;
    }
    
    .placeholder {
      padding: 20px;
      background: #fff9e6;
      border: 2px dashed #ffd700;
      border-radius: 8px;
      text-align: center;
      color: #886600;
      font-style: italic;
    }

    .info-box {
      padding: 16px;
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #1565c0;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .song-list {
      margin-bottom: 20px;
    }

    .song-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }

    .song-item:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .song-item.new-upload {
      border-color: #4CAF50;
      background: #f1f8f4;
    }

    .song-item.library-song {
      border-color: #FF9800;
      background: #fff9f0;
    }

    .song-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .song-position {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .song-item:hover .song-position {
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .song-name {
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .song-badge {
      background: #4CAF50;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .song-badge.library {
      background: #FF9800;
    }

    .song-controls {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }

    .btn-play {
      background: #2196F3;
      color: white;
    }

    .btn-play:hover {
      background: #0b7dda;
    }

    .btn-play.playing {
      background: #FF9800;
    }

    .btn-move {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #ddd;
    }

    .btn-move:hover {
      background: #e0e0e0;
    }

    .btn-move:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    /* Song Library Styles */
    .library-section {
      background: linear-gradient(135deg, #fff9f0 0%, #ffe8cc 100%);
      border: 2px solid #FF9800;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .library-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      font-size: 16px;
      font-weight: 700;
      color: #e65100;
    }

    .library-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    .library-song-card {
      background: white;
      border: 2px solid #FFE0B2;
      border-radius: 10px;
      padding: 12px;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .library-song-card:hover {
      border-color: #FF9800;
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
      transform: translateY(-2px);
    }

    .library-song-card.added {
      border-color: #4CAF50;
      background: #f1f8f4;
    }

    .library-song-name {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      line-height: 1.3;
    }

    .library-song-controls {
      display: flex;
      gap: 6px;
    }

    .btn-add-library {
      flex: 1;
      padding: 8px 12px;
      background: #FF9800;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-add-library:hover:not(:disabled) {
      background: #f57c00;
    }

    .btn-add-library:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-add-library.added {
      background: #4CAF50;
    }

    .upload-section {
      margin-top: 15px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
      border: 2px dashed #ccc;
    }

    .upload-section.max-reached {
      opacity: 0.6;
      pointer-events: none;
    }

    .upload-label {
      display: inline-block;
      padding: 10px 20px;
      background: #2a5298;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }

    .upload-label:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }

    .upload-label.disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* PowerPoint Upload Section */
    .pptx-upload-section {
      margin-top: 15px;
      padding: 20px;
      background: #fff9e6;
      border: 2px dashed #FF9800;
      border-radius: 8px;
    }

    .pptx-upload-section .upload-label {
      background: #FF9800;
      padding: 12px 24px;
      font-size: 15px;
    }

    .pptx-upload-section .upload-label:hover {
      background: #f57c00;
    }

    .pptx-file-preview {
      margin-top: 15px;
      padding: 12px;
      background: white;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .pptx-file-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pptx-file-icon {
      font-size: 24px;
    }

    .pptx-file-details {
      display: flex;
      flex-direction: column;
    }

    .pptx-file-name {
      font-weight: 600;
      color: #333;
    }

    .pptx-file-size {
      font-size: 13px;
      color: #666;
    }

    /* Song Range Sliders */
    .song-ranges-container {
      margin-top: 15px;
    }

    .song-range-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
    }

    .song-range-header {
      font-weight: 600;
      color: #2a5298;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slide-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .slide-input-group {
      display: flex;
      flex-direction: column;
    }

    .slide-input-group label {
      font-size: 13px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
    }

    .slide-input-group input {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }

    .slide-input-group input:focus {
      outline: none;
      border-color: #2a5298;
    }
    
    /* Resubmit Button */
    .resubmit-section {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 2px solid #f0f0f0;
      text-align: center;
    }
    
    .btn-resubmit {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 18px 40px;
      font-size: 18px;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 6px 20px rgba(30, 60, 114, 0.4);
    }
    
    .btn-resubmit:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(30, 60, 114, 0.5);
    }
    
    .btn-resubmit:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
      animation: fadeIn 0.3s;
    }

    .modal-overlay.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Modal Container */
    .modal {
      background: white;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      animation: slideUp 0.3s;
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      padding: 24px 30px;
      border-radius: 16px 16px 0 0;
      position: relative;
    }

    .modal-header.help-header {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    }

    .modal-header.share-header {
      background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
    }
    
    .modal-header h2 {
      margin: 0 0 8px 0;
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-header p {
      margin: 0;
      opacity: 0.95;
      font-size: 15px;
      line-height: 1.5;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 30px;
    }

    .modal-form-group {
      margin-bottom: 20px;
    }

    .modal-form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }

    .modal-form-group label .required {
      color: #f44336;
      margin-left: 2px;
    }

    .modal-form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }

    .modal-form-group input:focus {
      outline: none;
      border-color: #4CAF50;
    }

    .modal-form-group input.error {
      border-color: #f44336;
    }

    .modal-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .modal-info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #1565c0;
      line-height: 1.6;
    }

    .modal-footer {
      padding: 20px 30px 30px;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn-primary {
      background: #4CAF50;
      color: white;
    }

    .modal-btn-primary:hover:not(:disabled) {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }

    .modal-btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .modal-btn-danger {
      background: #f44336;
      color: white;
    }

    .modal-btn-danger:hover:not(:disabled) {
      background: #d32f2f;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
    }

    .modal-btn-danger:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .modal-btn-secondary {
      background: #f5f5f5;
      color: #666;
      border: 2px solid #e0e0e0;
    }

    .modal-btn-secondary:hover {
      background: #e0e0e0;
    }

    .modal-btn-info {
      background: #2196F3;
      color: white;
    }

    .modal-btn-info:hover:not(:disabled) {
      background: #0b7dda;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }

    .modal-btn-info:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* Share Recipients List */
    .recipients-list {
      margin-bottom: 20px;
    }

    .recipient-item {
      background: #f5f5f5;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
      position: relative;
    }

    .recipient-item.last {
      border-color: #2196F3;
      background: #e3f2fd;
    }

    .recipient-number {
      position: absolute;
      top: 15px;
      left: 15px;
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }

    .recipient-fields {
      margin-left: 40px;
    }

   .recipient-remove {
     position: absolute;
     top: 15px;
     right: 15px;
     background: #f44336;
     color: white;
     border: none;
     width: 28px;
     height: 28px;
     border-radius: 50%;
     cursor: pointer;
     font-size: 16px;
     display: flex;
     align-items: center;
     justify-content: center;
     transition: all 0.2s;
   }

   .recipient-remove:hover {
     background: #d32f2f;
     transform: scale(1.1);
   }

   .btn-add-recipient {
     width: 100%;
     padding: 12px;
     background: #f5f5f5;
     border: 2px dashed #2196F3;
     border-radius: 8px;
     color: #2196F3;
     font-weight: 600;
     font-size: 14px;
     cursor: pointer;
     transition: all 0.2s;
     display: flex;
     align-items: center;
     justify-content: center;
     gap: 8px;
   }

   .btn-add-recipient:hover {
     background: #e3f2fd;
     border-color: #0b7dda;
     color: #0b7dda;
   }

   /* Calculation Modal Specific Styles */
   .modal-header.calc-header {
     background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
   }

   .calc-result-item {
     display: flex;
     justify-content: space-between;
     align-items: center;
     padding: 16px;
     background: #f8f9ff;
     border-radius: 8px;
     margin-bottom: 16px;
     border: 2px solid #e0e0e0;
   }

   .calc-label {
     font-weight: 600;
     color: #555;
     font-size: 16px;
   }

   .calc-value {
     font-weight: 700;
     color: #2a5298;
     font-size: 20px;
   }

   .calc-summary {
     background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
     border-left: 4px solid #667eea;
     border-radius: 8px;
     padding: 20px;
     margin-top: 20px;
     font-size: 15px;
     line-height: 1.6;
     color: #333;
   }

   .modal-btn-calc-primary {
     background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
     color: white;
     padding: 14px 24px;
     font-size: 16px;
     flex: 1;
   }

   .modal-btn-calc-primary:hover {
     transform: translateY(-2px);
     box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
   }
    
    /* Notification Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 16px 24px;
      background: #333;
      color: white;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
      max-width: 400px;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .toast.success {
      background: #4CAF50;
    }
    
    .toast.error {
      background: #f44336;
    }
    
    @media (max-width: 768px) {
      .header h1 { font-size: 24px; }
      .actions { flex-direction: column; }
      .btn { width: 100%; justify-content: center; }
      .toast { right: 20px; left: 20px; max-width: none; }
      .slide-inputs { grid-template-columns: 1fr; }
      .song-controls { flex-wrap: wrap; }
      .library-grid { grid-template-columns: 1fr; }
    }

    /* Thank You Overlay */
    .thank-you-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f8f9fa;
      z-index: 2000;
      display: none;
      overflow-y: auto;
    }

    .thank-you-content {
      background: white;
      max-width: 600px;
      margin: 80px auto;
      padding: 50px;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      text-align: center;
    }

    .thank-you-icon {
      width: 80px;
      height: 80px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 30px;
      font-size: 40px;
      color: white;
    }

    .thank-you-title {
      font-size: 32px;
      color: #2c3e50;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .thank-you-message {
      font-size: 18px;
      color: #6c757d;
      line-height: 1.7;
      margin-bottom: 30px;
    }

    .thank-you-footer {
      font-size: 14px;
      color: #adb5bd;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e9ecef;
    }

    .thank-you-footer {
      font-size: 14px;
      color: #adb5bd;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e9ecef;
    }
    
    /* Music Terms Modal */
    .terms-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    .terms-modal-overlay.show {
      display: flex;
    }

    .terms-modal-content {
      background: white;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }

    .terms-modal-header {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
      padding: 24px;
      border-radius: 16px 16px 0 0;
      text-align: center;
    }

    .terms-modal-header h2 {
      font-size: 24px;
      margin: 0;
    }

    .terms-modal-body {
      padding: 30px;
      line-height: 1.8;
      color: #333;
      font-size: 15px;
    }

    .terms-modal-footer {
      padding: 20px 30px;
      display: flex;
      gap: 12px;
      border-top: 2px solid #f0f0f0;
    }

    .terms-btn {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .terms-btn-cancel {
      background: #f44336;
      color: white;
    }

    .terms-btn-cancel:hover {
      background: #d32f2f;
    }

    .terms-btn-accept {
      background: #4CAF50;
      color: white;
    }

    .terms-btn-accept:hover {
      background: #45a049;
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://www.dropbox.com/scl/fi/i5ye9vg5wzfvxwyrwczq6/Untitled-940-x-600-px-1400-x-600-px.png?rlkey=rk5t9ot5gchvjcqx71lwiln1o&st=8orea38d&dl=1" alt="Company Logo" class="header-logo">
      <h1 id="headerTitle">✨ Your Memorial Video</h1>
      <p id="jobInfo">Loading...</p>
      <div id="versionSelector" style="display:none; margin-top: 15px;">
        <label for="versionDropdown" style="color: white; font-size: 14px; margin-right: 8px;">Video Version:</label>
        <select id="versionDropdown" style="padding: 8px 12px; border-radius: 6px; border: 2px solid white; font-weight: 600; font-size: 14px; cursor: pointer;">
          <!-- Will be populated dynamically -->
        </select>
        <button id="revertBtn" class="btn btn-outline" style="display:none; margin-left: 12px; padding: 8px 16px; font-size: 13px;">
          🔄 Revert to This Version
        </button>
      </div>
    </div>

      <!-- ADD THIS SUMMARY BOX HERE -->
      <div id="summaryBox" class="summary-box" style="display:none;">
        <!-- Summary will be populated by JavaScript -->
      </div>
      
      <!-- Video Player Section -->
      <div class="video-section">
        <div id="videoContainer" class="loading">
          <div class="spinner"></div>
          <p>Loading your video...</p>
        </div>
      </div>
    
      <!-- Primary Actions - Top Row -->
      <div class="actions" id="actionButtons" style="margin-bottom: 15px;">
        <button id="editBtn" class="btn btn-edit" style="display:none;">
          ✏️ Edit & Republish My Video (unlimited submissions)
        </button>
        <button id="shareBtn" class="btn btn-secondary" style="display:none;">
          📩 Share Draft Video with Others
        </button>
        <button id="deliverBtn" class="btn btn-primary" style="display:none;">
          ⛪️ Deliver Final Downloadable Video to My Event Coordinator
        </button>
        <button id="helpBtn" class="btn btn-danger" style="display:none;">
          🙋‍♀️ Help Needed
        </button>
      </div>
      
      <!-- Secondary Action - Bottom Row -->
      <div class="actions" id="finalizeButtonContainer" style="justify-content: center;">
        <button id="finalizeBtn" class="btn-resubmit" style="display:none; padding: 18px 40px; font-size: 16px;">
          ✅ I am finished (Send me a Video Download Link)
        </button>
      </div>
      
      <!-- Finalized State -->
      <div id="finalizedMessage" style="display:none;">
        <div style="background: #e8f5e9; border: 2px solid #4CAF50; border-radius: 12px; padding: 30px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 15px;">✅</div>
          <h2 style="color: #2e7d32; margin-bottom: 10px;">Order Complete!</h2>
          <p style="color: #555; margin-bottom: 20px;">Your memorial video has been finalized. A backup copy has been sent to your email.</p>
          <a id="finalDownloadBtn" href="#" class="btn btn-primary">
            📥 Download Video Again
          </a>
        </div>
      </div>
    
      <!-- Edit Sections -->
      <div class="edit-sections" id="editSections" style="display:none;">
        <div class="section-header">
          <h2>✏️ Make Changes to Your Video</h2>
        </div>
        
        <!-- Change Songs (MOVED TO TOP) -->
        <div class="edit-option" data-section="songs">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">🎵</span>
              <span>Change Songs</span>
            </div>
            <span class="chevron">▼</span>
          </div>
          <div class="edit-option-content">
            <!-- Song Library -->
            <div class="library-section">
              <div class="library-header">
               🎼 Song Library - Choose from our curated memorial music
              </div>
              <div style="margin-bottom: 15px;">
                <label for="genreSelect" style="font-weight: 600; color: #e65100; margin-bottom: 6px; display: block;">Select Genre:</label>
                <select id="genreSelect" style="padding: 10px; border: 2px solid #FF9800; border-radius: 8px; font-size: 14px; font-weight: 600; background: white; cursor: pointer; width: 200px;">
                  <option value="Classical">Classical</option>
                  <option value="Country">Country</option>
                  <option value="Gospel">Gospel</option>
                  <option value="Pop/Folk/Celtic">Pop/Folk/Celtic</option>
                </select>
              </div>
              <div class="library-grid" id="libraryGrid">
                
            </div>
            </div>

            <div class="upload-section" id="uploadSection">
              <label class="upload-label" id="uploadLabel">
                📤 Upload Your Own Songs (MP3)
                <input type="file" id="newSongUpload" accept=".mp3,audio/mpeg" multiple style="display: none;">
              </label>
              <div style="margin-top: 8px; font-size: 13px; color: #666;">
                <span id="songCountDisplay">0 songs selected</span>
              </div>
            </div>

            <div class="form-group">
              <label>Your Selected Songs (Max 6 total)</label>
              <div id="songList" class="song-list">
                <!-- Will be populated dynamically -->
              </div>
            </div>
          </div>
        </div>

        <!-- Change Transitions -->
        <div class="edit-option" data-section="transitions">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">🎨</span>
              <span>Change Transitions</span>
            </div>
            <span class="chevron">▼</span>
          </div>
          <div class="edit-option-content">
            <div style="display: flex; gap: 20px; align-items: flex-start;">
              <!-- Left side: Dropdown (1/3 width) -->
              <div style="flex: 0 0 280px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label for="visualPackage">
                    Visual Package
                    <div class="help-text">Choose the style of transitions between slides</div>
                  </label>
                  <select id="visualPackage" name="visualPackage">
                    <option value="">-- Select a package --</option>
                    <option value="simple-fade-wipe">Simple Fade & Wipe</option>
                    <option value="pages-of-life">Pages of Life</option>
                    <option value="floating-frames">Floating Frames</option>
                    <option value="zoom-through">Zoom Through</option>
                    <option value="blinds-combs-bars">Blinds, Combs & Bars</option>
                  </select>
                </div>
              </div>
      
              <!-- Right side: Video Preview (2/3 width) -->
              <div style="flex: 1;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #555; font-size: 14px;">
                  Preview
                </label>
                <div style="background: #000; border-radius: 8px; overflow: hidden;">
                  <video id="transitionPreview" controls preload="auto" style="width: 100%; display: block;">
                    <source id="transitionPreviewSource" src="https://www.dropbox.com/scl/fi/ij0b9ndn9mcg2me0ipb7y/Transition-Examples-Simple-Fade-and-Wipe-2.mp4?rlkey=pgrt4ad1qg3wy9203pv6c32zm&st=j9cme2mi&dl=1" type="video/mp4">
                    Your browser does not support the video tag.
                  </video>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Change Timing -->
        <div class="edit-option" data-section="timing">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">⏱️</span>
              <span>Change Video Length</span>
            </div>
            <span class="chevron">▼</span>
          </div>
          <div class="edit-option-content">
            
            <div class="form-group">
              <label>Timing Mode</label>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" name="timingMode" value="perSlide">
                  <span class="radio-option-label">Per Slide Duration</span>
                  <div class="radio-option-content">
                    <span class="radio-option-desc">Set how many seconds each slide should display</span>
                    <div class="conditional-input" id="perSlideInput" style="display:none;">
                      <label for="perSlideSec" style="font-size: 13px; margin-bottom: 6px;">Seconds per slide:</label>
                      <input type="number" id="perSlideSec" name="perSlideSec" min="2" max="30" step="0.1" value="5" style="padding: 8px;">
                    </div>
                  </div>
                </label>
                
                <label class="radio-option">
                  <input type="radio" name="timingMode" value="fixedRuntime">
                  <span class="radio-option-label">Fixed Total Runtime</span>
                  <div class="radio-option-content">
                    <span class="radio-option-desc">Set the total video length in seconds</span>
                    <div class="conditional-input" id="fixedRuntimeInput" style="display:none;">
                      <label for="fixedRuntimeSec" style="font-size: 13px; margin-bottom: 6px;">Total runtime (seconds):</label>
                      <input type="number" id="fixedRuntimeSec" name="fixedRuntimeSec" min="30" step="0.1" max="1800" value="320" style="padding: 8px;">
                    </div>
                  </div>
                </label>
                
                <label class="radio-option">
                  <input type="radio" name="timingMode" value="fitToSongs">
                  <span class="radio-option-label">Fit to Music Length</span>
                  <div class="radio-option-content">
                    <span class="radio-option-desc">Video duration matches your music (automatic)</span>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- ✅ NEW: Duration Display -->
        <div id="durationDisplay" class="preview-section" style="display:none; background: #e8f5e9; border-color: #4CAF50; margin-top: 20px; margin-bottom: 20px;">
          <div class="preview-header" style="color: #2e7d32;">
            ⏱️ Estimated Video Duration
          </div>
          <div style="padding: 15px; background: white; border-radius: 8px;">
            <div style="font-size: 32px; font-weight: 700; color: #4CAF50; text-align: center;" id="durationValue">
              --:--
            </div>
            <div style="font-size: 14px; color: #666; text-align: center; margin-top: 8px;" id="durationDetails">
              Enter slide count to calculate
            </div>
          </div>
        </div>
        
        <!-- Change Song Logic -->
        <div class="edit-option" data-section="songlogic">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">🎼</span>
              <span>Change Song Logic</span>
            </div>
            <span class="chevron">▼</span>
          </div>
          <div class="edit-option-content">
            <div id="fitToMusicNotice" class="info-box" style="display:none; background: #fff3cd; border-color: #ffc107; color: #856404;">
              ⚠️ <strong>"Fit to Music Length" is selected</strong> - Song Logic is determined automatically when video duration matches your music length.
            </div>
            <div class="form-group">
              <label for="musicDistribution">
                Music Distribution
                <div class="help-text">How songs should be spread across the video</div>
              </label>
              <select id="musicDistribution" name="musicDistribution">
                <option value="">-- Select distribution --</option>
                <option value="evenlyDistributed">Evenly Distributed</option>
                <option value="specifyPlacement">Specify Placement</option>
              </select>
            </div>

            <!-- Conditional Song Range Sliders -->
            <div id="songRangesContainer" class="song-ranges-container" style="display:none;">
              <div class="info-box">
                📍 Specify which slides each song should play during. The backend will automatically prevent overlaps and fill gaps.
              </div>
              <div id="songRangesList">
                <!-- Will be populated dynamically based on number of songs -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Manual Changes -->
        <div class="edit-option" data-section="manual">
          <div class="edit-option-header">
            <div class="edit-option-title">
              <span class="edit-option-icon">✏️</span>
              <span>Edit Slideshow</span>
            </div>
            <span class="chevron">▼</span>
          </div>
          <div class="edit-option-content">
            <div class="info-box" id="manualEditInfoBox">
              Edit your presentation directly, then come back here and click "Resubmit Changes" to create a new video with your edits.
            </div>
            <div id="manualEditButtons" class="button-group">
              <!-- Buttons will be populated based on presentation type -->
            </div>
            
            <!-- PowerPoint Upload Section (Only shows for PowerPoint providers) -->
            <div id="pptxUploadSection" class="pptx-upload-section" style="display:none;">
              <div style="margin-bottom: 12px; font-weight: 600; color: #FF9800;">
                📄 Upload a New PowerPoint File
              </div>
              <label class="upload-label">
                📤 Choose PowerPoint File (.pptx)
                <input type="file" id="newPptxUpload" accept=".pptx,application/vnd.openxmlformats-officedocument.presentationml.presentation" style="display: none;">
              </label>
              <div id="pptxFilePreview" style="display:none;">
                <!-- File preview will appear here -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Resubmit Section -->
        <div class="resubmit-section">
          <button id="resubmitBtn" class="btn-resubmit" disabled>
              🚀 Calculate My Video
          </button>
          <p style="margin-top:12px; color:#ffffff; font-size:14px;">
            Make changes above, then click to create a new video
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Resubmit Thank You Overlay -->
  <div id="resubmitThankYouOverlay" class="thank-you-overlay">
    <div class="thank-you-content">
      <div class="thank-you-icon">✓</div>
      <h1 class="thank-you-title">Changes Submitted!</h1>
      <p class="thank-you-message">
        Your video is being processed with your requested changes.
        <br><br>
        <strong>You'll receive an email in 5-15 minutes</strong> with your new video.
        <br><br>
        In the next video, you'll be able to access all previous versions using the version picker at the top.
      </p>
      <div class="thank-you-footer">
        Your changes have been successfully submitted. You may close this window.
      </div>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Deliver to Coordinator Modal -->
  <div id="deliverModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <button class="modal-close" onclick="closeDeliverModal()">×</button>
        <h2>⛪️ Deliver to Event Coordinator</h2>
        <p>Ready to deliver your final memorial video? Send downloadable link to your funeral home or end of life event coordinator.</p>
      </div>
      <div class="modal-body">
        <form id="deliverForm">
          <div class="modal-form-row">
            <div class="modal-form-group">
              <label>First Name<span class="required">*</span></label>
              <input type="text" id="coordFirstName" required placeholder="Jane">
            </div>
            <div class="modal-form-group">
              <label>Last Name<span class="required">*</span></label>
              <input type="text" id="coordLastName" required placeholder="Smith">
            </div>
          </div>
        
          <div class="modal-form-group">
            <label>Event Host Organization Name<span class="required">*</span></label>
            <input type="text" id="coordOrgName" required placeholder="e.g., Family Funeral Homes">
          </div>
        
          <div class="modal-form-group">
            <label>Email Address<span class="required">*</span></label>
            <input type="email" id="coordEmail" required placeholder="jane@familyfuneralhomes.com">
          </div>
        
          <div class="modal-info-box">
            📧 <strong>What happens next?</strong><br>
            The send button will deliver a video view link and MP4 file download link to your end of life event coordinator. It will include a video acceptance confirmation request. We will also copy you on this email to facilitate direct communication.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="modal-btn modal-btn-secondary" onclick="closeDeliverModal()">
          Cancel
        </button>
        <button type="button" class="modal-btn modal-btn-primary" onclick="submitDelivery()" id="deliverSubmitBtn">
          📤 Send to Coordinator
        </button>
      </div>
    </div>
  </div>

  <!-- Help Needed Modal -->
  <div id="helpModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header help-header">
        <button class="modal-close" onclick="closeHelpModal()">×</button>
        <h2>🙋‍♀️ Help Needed</h2>
        <p>I have tried editing and re-publishing my video, but it's not quite right. I would like some human help with final video revisions. Please send me a revision request form for your team to help me finalize my video.</p>
      </div>
      <div class="modal-body">
        <form id="helpForm">
          <div class="modal-form-row">
            <div class="modal-form-group">
              <label>First Name<span class="required">*</span></label>
              <input type="text" id="helpFirstName" required placeholder="John">
            </div>
            <div class="modal-form-group">
              <label>Last Name<span class="required">*</span></label>
              <input type="text" id="helpLastName" required placeholder="Doe">
            </div>
          </div>
        
          <div class="modal-form-group">
            <label>Email Address<span class="required">*</span></label>
            <input type="email" id="helpEmail" required placeholder="john@example.com">
          </div>
        
          <div class="modal-info-box">
            📝 <strong>What happens next?</strong><br>
            The send button will deliver you a revision request form to help you describe the assistance needed so that we can get your request to the right team member for review.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="modal-btn modal-btn-secondary" onclick="closeHelpModal()">
          Cancel
        </button>
        <button type="button" class="modal-btn modal-btn-danger" onclick="submitHelp()" id="helpSubmitBtn">
          ✉️ Send me a help request form
        </button>
      </div>
    </div>
  </div>

  <!-- Share Draft Video Modal -->
  <div id="shareModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header share-header">
        <button class="modal-close" onclick="closeShareModal()">×</button>
        <h2>📩 Share Draft Video</h2>
        <p>Invite family and friends to review & comment and/or edit your video</p>
      </div>
      <div class="modal-body">
        <form id="shareForm">
          <div class="recipients-list" id="recipientsList">
            <!-- Recipients will be added here dynamically -->
          </div>
        
          <button type="button" class="btn-add-recipient" onclick="addRecipient()">
            ➕ Add Another Recipient
          </button>
        
          <div class="modal-info-box" style="margin-top: 20px;">
            🔗 <strong>What happens next?</strong><br>
            Each recipient will receive an email with a link to view your draft video. They'll be able to leave comments and suggestions to help you finalize it.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="modal-btn modal-btn-secondary" onclick="closeShareModal()">
          Cancel
        </button>
        <button type="button" class="modal-btn modal-btn-info" onclick="submitShare()" id="shareSubmitBtn">
          📤 Send Invitations
        </button>
      </div>
    </div>
  </div>

  <!-- Confirmation Preview Modal -->
  <div id="confirmModal" class="modal-overlay">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header" id="confirmModalHeader">
        <button class="modal-close" onclick="closeConfirmModal()">×</button>
        <h2 id="confirmModalTitle">⛪️ Confirm Video</h2>
        <p id="confirmModalSubtitle">Please review your video before proceeding</p>
      </div>
      <div class="modal-body">
        <div class="modal-info-box" id="confirmModalMessage">
          Can you confirm this is the video you wish to send to your event coordinator?
        </div>
        
        <!-- Video Player Embed -->
        <div class="video-wrapper" style="margin-bottom: 20px;">
          <video id="confirmVideo" controls preload="auto">
            <source id="confirmVideoSource" src="" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="modal-btn modal-btn-secondary" onclick="closeConfirmModal()">
          ❌ No, Go Back
        </button>
        <button type="button" class="modal-btn modal-btn-primary" id="confirmProceedBtn" onclick="proceedFromConfirm()">
          ✅ Yes, Continue
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // Configuration
    const API_BASE = 'https://4hyy6kr2id.execute-api.us-east-2.amazonaws.com/prod';
    const MAX_SONGS = 6;

    // Global state
    let allVersions = [];
    let currentVersionIndex = 0;
    
    // Song Library with S3 URLs
    const SONG_LIBRARY = [
      // Classical
      {
        id: 'lib-abandoned-house',
        name: 'abandoned-house-115974.mp3',
        displayName: 'Abandoned House | S. Pavkin | 4:32',
        genre: 'Classical',
        duration: 272,
        url: 'https://www.dropbox.com/scl/fi/e2hj208ah5ecgjawqx8i4/abandoned-house-115974.mp3?rlkey=qr190y41qu4nthn2s3cjkt4r1&st=2fpoye9x&dl=1'
      },
      {
        id: 'lib-ave-maria',
        name: 'ave-maria-instrumental-150536.mp3',
        displayName: 'Ave Maria - instrumental | J. Monter | 4:30',
        genre: 'Classical',
        duration: 270,
        url: 'https://www.dropbox.com/scl/fi/1ul58k4wd6xxetzr5nryp/ave-maria-instrumental-150536.mp3?rlkey=94tykgno8ujyceuocvzog1s1s&st=kbbmvgga&dl=1'
      },
      {
        id: 'lib-drowning-echoes',
        name: 'drowning-echoes-dramatic-orchestra-345956.mp3',
        displayName: 'Drowning Echoes | L. Timachev | 1:35',
        genre: 'Classical',
        duration: 95,
        url: 'https://www.dropbox.com/scl/fi/5bliwk57z6xpgxkleeh2m/drowning-echoes-dramatic-orchestra-345956.mp3?rlkey=x32at9wcwccv2agjrn411hed9&st=v7rk7jfv&dl=1'
      },
      {
        id: 'lib-farewell-to-w',
        name: 'farewell-to-w-111721.mp3',
        displayName: 'Farwell to W | Jan Semmler | 1:56',
        genre: 'Classical',
        duration: 116,
        url: 'https://www.dropbox.com/scl/fi/bguyj98xf788sa7kkqkm2/farewell-to-w-111721.mp3?rlkey=7gch0vq5kk0xws3pbqtbmswpf&st=h1ftj9p4&dl=1'
      },
      {
        id: 'lib-funeral',
        name: 'funeral-165257.mp3',
        displayName: 'Funeral | A. Chubarova | 1:39',
        genre: 'Classical',
        duration: 99,
        url: 'https://www.dropbox.com/scl/fi/pk1nfassm9zu10u84w077/funeral-165257.mp3?rlkey=zeqegrvt6mn0raxq0z9jb2l2i&st=zy3g1yxu&dl=1'
      },
      {
        id: 'lib-funeral-memories',
        name: 'funeral-memories-piano-334314.mp3',
        displayName: 'Funeral Memories - Piano | O. F. Music | 2:10',
        genre: 'Classical',
        duration: 130,
        url: 'https://www.dropbox.com/scl/fi/qv1d6tg8eyzioedmh33n2/funeral-memories-piano-334314.mp3?rlkey=nb9dxdn3yndxxl6w2u8d9ctkp&st=m2ufybct&dl=1'
      },
      {
        id: 'lib-lullaby-for-you',
        name: 'lullaby-for-you-391546.mp3',
        displayName: 'Lullaby for You | Loli Valiente | 3:10',
        genre: 'Classical',
        duration: 190,
        url: 'https://www.dropbox.com/scl/fi/73arolj6zhu3j84bvne6e/lullaby-for-you-391546.mp3?rlkey=leh7t5lq0daryun5og9974pl8&st=y3ch2zfk&dl=1'
      },
      {
        id: 'lib-moonlight-sonata',
        name: 'beethoven-sonata-no14-op-27-moonlight-sonata-14237.mp3',
        displayName: 'Moonlight Sonata | Beethoven | 5:25',
        genre: 'Classical',
        duration: 325,
        url: 'https://www.dropbox.com/scl/fi/6697emjmf8eoaku8zsg3d/beethoven-sonata-no14-op-27-moonlight-sonata-14237.mp3?rlkey=3mx2attdzjxmaeabnsjq6n3vl&st=wl6wou9q&dl=1'
      },
      {
        id: 'lib-pachelbels-canon',
        name: 'pachelbelx27s-canon-canon-in-d-307319.mp3',
        displayName: "Pachelbel's Canon (in D) | C. Clavier | 2:41",
        genre: 'Classical',
        duration: 161,
        url: 'https://www.dropbox.com/scl/fi/nc3livbf5jegqpmyfub15/pachelbelx27s-canon-canon-in-d-307319.mp3?rlkey=u43qewxb7z85nrgkzudl1irqi&st=nmh16l4h&dl=1'
      },
      {
        id: 'lib-pathetique-sonata',
        name: 'pathetique-sonata-beethoven-350778.mp3',
        displayName: 'Pathetique Sonata - Beethoven | J. Chauvel | 5:03',
        genre: 'Classical',
        duration: 303,
        url: 'https://www.dropbox.com/scl/fi/2hbb6024to7pakgpdmoue/pathetique-sonata-beethoven-350778.mp3?rlkey=t1hz0tv63jszoh903e4t7wai5&st=5cnkfz9t&dl=1'
      },
      {
        id: 'lib-prelude-in-e-minor',
        name: 'chopin-prelude-in-e-minor-165243.mp3',
        displayName: 'Prelude in e-minor | Chopin | 1:55',
        genre: 'Classical',
        duration: 115,
        url: 'https://www.dropbox.com/scl/fi/qpm80orqgh1535zhuj21b/chopin-prelude-in-e-minor-165243.mp3?rlkey=qxzfp5gu7zo50g7p3ikxz0wqw&st=nssflnfx&dl=1'
      },
      {
        id: 'lib-remember',
        name: 'remember-116568.mp3',
        displayName: 'Remember | Sergii Pavkin | 3:52',
        genre: 'Classical',
        duration: 232,
        url: 'https://www.dropbox.com/scl/fi/gn9wrfgu68od861d7jp6m/remember-116568.mp3?rlkey=39ksfzdo1jct5she6at0fadg4&st=vikyio0s&dl=1'
      },
      {
        id: 'lib-sad-moment',
        name: 'sad-moment-sad-and-melancholy-piano-background-music-124488.mp3',
        displayName: 'Sad Moment | Oleg Fedak | 2:39',
        genre: 'Classical',
        duration: 159,
        url: 'https://www.dropbox.com/scl/fi/mbm8geh0luwustak9smd2/sad-moment-sad-and-melancholy-piano-background-music-124488.mp3?rlkey=wsm1n1gt0osemzjejw07v43gp&st=619ztz7q&dl=1'
      },
      {
        id: 'lib-sad-violin',
        name: 'sad-violin-150146.mp3',
        displayName: 'Sad Violin | A. Chubarova | 1:56',
        genre: 'Classical',
        duration: 116,
        url: 'https://www.dropbox.com/scl/fi/h30dhlibvdvntrb7du2pt/sad-violin-150146.mp3?rlkey=tbf9768lw6n91fqovclt7tih9&st=njiipgri&dl=1'
      },

      // Country
      {
        id: 'lib-country-background',
        name: 'country-background-349052.mp3',
        displayName: 'Country Background - acoustic | T. Tank | 2:03',
        genre: 'Country',
        duration: 123,
        url: 'https://www.dropbox.com/scl/fi/iujxwgqeeizp6a8zbzp1b/country-background-349052.mp3?rlkey=k0p7jnieopq7kkyu1sjkiy2vm&st=3m17x37i&dl=1'
      },
      {
        id: 'lib-country-ballad',
        name: 'country-rodeo-cowboy-ballad-music-full-351039.mp3',
        displayName: 'Country Ballad - acoustic | U. Catch | 3:27',
        genre: 'Country',
        duration: 207,
        url: 'https://www.dropbox.com/scl/fi/eei0x2q4swzvkc0zxavnj/country-rodeo-cowboy-ballad-music-full-351039.mp3?rlkey=4dk26852xjegr6vc5cqxmc3kc&st=va434lvi&dl=1'
      },
      {
        id: 'lib-dust-and-memory',
        name: 'dust-and-memory-420131.mp3',
        displayName: 'Dust and Memory - acoustic | S. Koushik | 3:02',
        genre: 'Country',
        duration: 182,
        url: 'https://www.dropbox.com/scl/fi/85sm3xdnh2vuyge8yajbs/dust-and-memory-420131.mp3?rlkey=dt6gmsw3fi0vr84bdvpd6fd3a&st=zx6v3tk0&dl=1'
      },
      {
        id: 'lib-empty-chair',
        name: 'empty-chair-at-the-table-250271.mp3',
        displayName: 'Empty Chair at the Table (v) | T. Keiji | 3:26',
        genre: 'Country',
        duration: 206,
        url: 'https://www.dropbox.com/scl/fi/ns51tjb029uz5qoxg0per/empty-chair-at-the-table-250271.mp3?rlkey=7u6wegqhi7ed3nxwo9j2k7q2g&st=d4n03iox&dl=1'
      },
      {
        id: 'lib-hands-to-heaven',
        name: 'hands-to-heaven-318378.mp3',
        displayName: 'Hands to Heaven (v) | T. Keiji | 3:41',
        genre: 'Country',
        duration: 221,
        url: 'https://www.dropbox.com/scl/fi/l0xrjhpi0zbekenl263cw/hands-to-heaven-318378.mp3?rlkey=sf674v2hyp40ov4n35hk75dpm&st=gwu1ain2&dl=1'
      },
      {
        id: 'lib-i-only-loved-lucy',
        name: 'i-only-loved-lucy-243840.mp3',
        displayName: 'I Only Loved Lucy - acoustic | Alan Jordan | 1:51',
        genre: 'Country',
        duration: 111,
        url: 'https://www.dropbox.com/scl/fi/fk964atxj41ni75umx3aj/i-only-loved-lucy-243840.mp3?rlkey=f4eiozvod5f0jw9lilgvwru9q&st=ffjemwz8&dl=1'
      },
      {
        id: 'lib-meet-you-in-texas',
        name: 'meet-you-in-texas-243843.mp3',
        displayName: "I'll Meet You in Texas - guitar | Alan Jordan | 3:10",
        genre: 'Country',
        duration: 190,
        url: 'https://www.dropbox.com/scl/fi/0c7gu8274gpr8m11x8xhp/meet-you-in-texas-243843.mp3?rlkey=af1pki1zk5j5cbiwomlx85989&st=uykw2hbt&dl=1'
      },
      {
        id: 'lib-in-god-we-trust',
        name: 'in-god-we-trust-307905.mp3',
        displayName: 'In God We Trust (v) | Phill Buck | 4:00',
        genre: 'Country',
        duration: 240,
        url: 'https://www.dropbox.com/scl/fi/pg9k7ovgsuouqvefldne6/in-god-we-trust-307905.mp3?rlkey=66lbr2kwqkzdchla6g6kpjtpe&st=gcb94vau&dl=1'
      },
      {
        id: 'lib-instrumental-acoustic-country',
        name: 'instrumental-music-acoustic-country-193189.mp3',
        displayName: 'Instrumental Acoustic Country | T. Lam | 4:12',
        genre: 'Country',
        duration: 252,
        url: 'https://www.dropbox.com/scl/fi/geh4muq5btkt98f02mvrs/instrumental-music-acoustic-country-193189.mp3?rlkey=y4iq9pch720b9dmp33ydq275m&st=1hiowi5y&dl=1'
      },

      // Gospel
      {
        id: 'lib-acoustic-mix-gospel',
        name: 'Acoustic-mix-gospel-worship-400470.mp3',
        displayName: 'Accoustic Mix Gospel Worship | A. Poraddovsky | 5:08',
        genre: 'Gospel',
        duration: 308,
        url: 'https://www.dropbox.com/scl/fi/o3rk8mv07pi5d2mf91bbj/Acoustic-mix-gospel-worship-400470.mp3?rlkey=dgex1s9wv38e6bm00z28uwmcz&st=9z8ezliy&dl=1'
      },
      {
        id: 'lib-amazing-grace',
        name: 'gospel-worship-amazing-grace-347221.mp3',
        displayName: 'Amazing Grace (v) | TuneTank | 5:39',
        genre: 'Gospel',
        duration: 339,
        url: 'https://www.dropbox.com/scl/fi/omsixfslmr3mucjgoovsn/gospel-worship-amazing-grace-347221.mp3?rlkey=wxa2bigxaslpcejmbayt6ilk5&st=9mv6090a&dl=1'
      },
      {
        id: 'lib-ave-maria-vocal',
        name: 'ave-maria-vocal-417992.mp3',
        displayName: 'Ave Maria (v) | N. Panek | 3:31',
        genre: 'Gospel',
        duration: 211,
        url: 'https://www.dropbox.com/scl/fi/t2uztgts60erotjommpaf/ave-maria-vocal-417992.mp3?rlkey=97kq65nl6cu5m8ijimos6jshm&st=5x4vqn3b&dl=1'
      },
      {
        id: 'lib-cathedral',
        name: 'cathedral-164234.mp3',
        displayName: 'Cathedral - Choir | A. Chubarova | 1:25',
        genre: 'Gospel',
        duration: 85,
        url: 'https://www.dropbox.com/scl/fi/to05jxu8n2807qpx7g9kp/cathedral-164234.mp3?rlkey=pblgghcuqjzpl1801e3ya5hk2&st=cv364yr8&dl=1'
      },
      {
        id: 'lib-gospel-ballad',
        name: 'gospel-ballad-boys-choir-humming-4216.mp3',
        displayName: 'Gospel Ballad Boys Choir | Juliius H. | 4:06',
        genre: 'Gospel',
        duration: 246,
        url: 'https://www.dropbox.com/scl/fi/edx9phtnrepco2otytkgj/gospel-ballad-boys-choir-humming-4216.mp3?rlkey=ez4bv0preiarcewgd01urd47a&st=8zkh3eul&dl=1'
      },
      {
        id: 'lib-gospel-worship',
        name: 'gospel-worship-christian-church-music-323163.mp3',
        displayName: 'Gospel Worship | L. Poltavskyi | 2:13',
        genre: 'Gospel',
        duration: 133,
        url: 'https://www.dropbox.com/scl/fi/qt7vc3pub1d14nql5jggl/gospel-worship-christian-church-music-323163.mp3?rlkey=i2ibmhmcb57tkua7gvrpm54s0&st=85kz2m87&dl=1'
      },
      {
        id: 'lib-voices-of-eternity',
        name: 'voices-of-eternity-church-cathedral-choir-195196.mp3',
        displayName: 'Voices of Eternity - Choir | Natalia | 2:34',
        genre: 'Gospel',
        duration: 154,
        url: 'https://www.dropbox.com/scl/fi/r4ktzhxptz7ec7h4brmz5/voices-of-eternity-church-cathedral-choir-195196.mp3?rlkey=88y5nkzaq9379e7myx6pslt2n&st=bjwcl7b7&dl=1'
      },
      {
        id: 'lib-you-restore-my-soul',
        name: 'you-restore-my-soul-413723.mp3',
        displayName: 'You Restore My Soul (v) | J. Haryanto | 2:56',
        genre: 'Gospel',
        duration: 176,
        url: 'https://www.dropbox.com/scl/fi/xvb6azif218so0m89ljus/you-restore-my-soul-413723.mp3?rlkey=15wy41lqcv8ufax7zudn3820g&st=ne961b3z&dl=1'
      },

      // Pop/Folk/Celtic
      {
        id: 'lib-across-the-oceans',
        name: 'across-the-oceans-269104.mp3',
        displayName: 'Across the Oceans (v) | D. Ram | 3:49',
        genre: 'Pop/Folk/Celtic',
        duration: 229,
        url: 'https://www.dropbox.com/scl/fi/cjrv91gurffdzkhe52wl0/across-the-oceans-269104.mp3?rlkey=zlypsu83xz9ub23rksrkk0y4z&st=wd9hcv41&dl=1'
      },
      {
        id: 'lib-eulogy',
        name: 'eulogy-ambient-piano-196437.mp3',
        displayName: 'Eulogy - Ambient Piano | Liderc | 1:15',
        genre: 'Pop/Folk/Celtic',
        duration: 75,
        url: 'https://www.dropbox.com/scl/fi/oync6ubxyrjse9tww8472/eulogy-ambient-piano-196437.mp3?rlkey=636s0nywfcqlr29jje5jc35tt&st=9hpij88n&dl=1'
      },
      {
        id: 'lib-farewell-full-of-love',
        name: 'farewell-full-of-love-346874.mp3',
        displayName: 'Farewell Full Of Love (v) | E. Wyns | 3:46',
        genre: 'Pop/Folk/Celtic',
        duration: 226,
        url: 'https://www.dropbox.com/scl/fi/veydq16v6o1fc9wbib9mb/farewell-full-of-love-346874.mp3?rlkey=z2c1op2lwux73w42h27pyjemo&st=9hqb5auf&dl=1'
      },
      {
        id: 'lib-heart-of-the-highlands',
        name: 'heart-of-the-highlands-celtic-342779.mp3',
        displayName: 'Heart of the Highlands - Celtic | P. Winter | 4:24',
        genre: 'Pop/Folk/Celtic',
        duration: 264,
        url: 'https://www.dropbox.com/scl/fi/94vhd8b7qepj09rmg9b6e/heart-of-the-highlands-celtic-342779.mp3?rlkey=9ve2jqfap91gqb3chgchk37wn&st=vkzwfutt&dl=1'
      },
      {
        id: 'lib-heartbroken-winter',
        name: 'heartbroken-winter-instrumental-306095.mp3',
        displayName: 'Heartbroken Winter - instrumental | S. Koushik | 3:22',
        genre: 'Pop/Folk/Celtic',
        duration: 202,
        url: 'https://www.dropbox.com/scl/fi/wmagfxr5sg8sjl2hntauh/heartbroken-winter-instrumental-306095.mp3?rlkey=59izyd5zrzbhrdd1wu71cawsr&st=r2cmje2m&dl=1'
      },
      {
        id: 'lib-instrumental-pop',
        name: 'instrumental-pop-339552.mp3',
        displayName: 'Instrumental Pop | J. January | 3:39',
        genre: 'Pop/Folk/Celtic',
        duration: 219,
        url: 'https://www.dropbox.com/scl/fi/thtksxggskeg4fwpbgtk2/instrumental-pop-339552.mp3?rlkey=2k3za21tttuyo819ywqf1md7l&st=15nt3hac&dl=1'
      },
      {
        id: 'lib-ki',
        name: 'ki-instrumental-ambient-337501.mp3',
        displayName: 'KI - Instrumental Ambient | S. Wurtz | 2:51',
        genre: 'Pop/Folk/Celtic',
        duration: 171,
        url: 'https://www.dropbox.com/scl/fi/6bsowlgcxjmlfim7mvqqa/ki-instrumental-ambient-337501.mp3?rlkey=4cswyiin63lmork1u2ikwfj10&st=5yj71syh&dl=1'
      },
      {
        id: 'lib-life-with-you',
        name: 'life-with-you-297782.mp3',
        displayName: 'Life With You - instrumental | M. Dembitsky | 2:20',
        genre: 'Pop/Folk/Celtic',
        duration: 140,
        url: 'https://www.dropbox.com/scl/fi/zeyhdnjl8b4lteq1r0c1f/life-with-you-297782.mp3?rlkey=rf62otj1qwp32zfusol7m04ik&st=9jofi351&dl=1'
      },
      {
        id: 'lib-sad-song',
        name: 'sad-song-326267.mp3',
        displayName: 'Sad Song | R. Dutta | 3:57',
        genre: 'Pop/Folk/Celtic',
        duration: 237,
        url: 'https://www.dropbox.com/scl/fi/jnpgd88i5fb9iunth1pgy/sad-song-326267.mp3?rlkey=9ez0kvz8h3ksz6gsh44tobq8w&st=ityngxdd&dl=1'
      },
      {
        id: 'lib-emerald-isles',
        name: 'emerald-isles-celtic-342785.mp3',
        displayName: 'The Emerald Isles - Celtic | P. Winter | 3:26',
        genre: 'Pop/Folk/Celtic',
        duration: 206,
        url: 'https://www.dropbox.com/scl/fi/0u654ps1xs9drthwdu7nn/emerald-isles-celtic-342785.mp3?rlkey=i3jotyo0ms8tbrptrv75dljqn&st=we70zpk6&dl=1'
      },
      {
        id: 'lib-hands-that-loved-me',
        name: 'the-hands-that-loved-me-301869.mp3',
        displayName: 'The Hands that Loved Me (v) | S. Evans | 2:38',
        genre: 'Pop/Folk/Celtic',
        duration: 158,
        url: 'https://www.dropbox.com/scl/fi/4qd06vw7aqq5dgg9jelbt/the-hands-that-loved-me-301869.mp3?rlkey=si49bufckmlmn4rznqder9eif&st=lgxtdem6&dl=1'
      },
      {
        id: 'lib-tomorrow',
        name: 'tomorrow-144278.mp3',
        displayName: 'Tomorrow - instrumental | H. Jeon | 2:06',
        genre: 'Pop/Folk/Celtic',
        duration: 126,
        url: 'https://www.dropbox.com/scl/fi/5az4s1pktmf26dygt3um1/tomorrow-144278.mp3?rlkey=c3d69257si27ssnvipvrcc84h&st=fdesilhm&dl=1'
      },
      {
        id: 'lib-tomorrow-we-fade',
        name: 'today-we-are-tomorrow-we-fade-1-312133.mp3',
        displayName: 'Tomorrow we Fade (v) | Jetty Jan | 3:06',
        genre: 'Pop/Folk/Celtic',
        duration: 186,
        url: 'https://www.dropbox.com/scl/fi/0asgkicde2n28tf87b8qo/today-we-are-tomorrow-we-fade-1-312133.mp3?rlkey=v6ei0lgzs8w0pkn8bbdac8o6b&st=iqwkrjxm&dl=1'
      }
    ];
    
    // Parse job ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const jobId = urlParams.get('job');
    const isFinalized = urlParams.get('finalized') === 'true';
    const isSharedView = urlParams.get('share') === 'true';
    
    // Track changes made by user
    let pendingChanges = {};
    let currentSettings = {};
    let currentSongs = [];
    let currentlyPlayingAudio = null;
    let newPptxFile = null;
    
    // Prevent going back if finalized
    if (isFinalized) {
      history.pushState(null, null, location.href);
      history.pushState(null, null, location.href);
      
      window.addEventListener('popstate', function(event) {
        history.pushState(null, null, location.href);
      });
    }
    
    if (!jobId) {
      showError('No job ID provided in URL. Please check your link.');
    } else {
      loadJobData(jobId);
    }
    
    // Render song library
    function renderLibrary() {
      const container = document.getElementById('libraryGrid');
      const selectedGenre = document.getElementById('genreSelect').value;
  
      // Filter songs by selected genre
      const filteredSongs = SONG_LIBRARY.filter(song => song.genre === selectedGenre);
  
      let html = '';
      filteredSongs.forEach(song => {
        const isAdded = currentSongs.some(s => s.id === song.id);
        const cardClass = isAdded ? 'library-song-card added' : 'library-song-card';
        const btnClass = isAdded ? 'btn-add-library added' : 'btn-add-library';
        const btnText = isAdded ? '✓ Added' : '+ Add';
        const audioId = `audio-lib-${song.id}`;
    
        html += `
          <div class="${cardClass}" data-song-id="${song.id}">
            <div class="library-song-name">${song.displayName}</div>
            <div class="library-song-controls">
              <button class="btn-small btn-play" onclick="togglePlay('${audioId}', this)">▶️ Play Song</button>
              <button class="${btnClass}" onclick="addLibrarySong('${song.id}')" ${isAdded || currentSongs.length >= MAX_SONGS ? 'disabled' : ''}>
                ${btnText}
              </button>
            </div>
            <audio id="${audioId}" src="${song.url}" preload="none"></audio>
          </div>
        `;
      });
  
      container.innerHTML = html;
    }
    
    // Add library song to current songs
    function addLibrarySong(songId) {
      if (currentSongs.length >= MAX_SONGS) {
        showToast(`Maximum ${MAX_SONGS} songs reached`, 'error');
        return;
      }
      
      const libSong = SONG_LIBRARY.find(s => s.id === songId);
      if (!libSong) return;
      
      // Check if already added
      if (currentSongs.some(s => s.id === songId)) {
        showToast('Song already added', 'error');
        return;
      }
      
      currentSongs.push({
        id: libSong.id,
        name: libSong.name,
        displayName: libSong.displayName,
        url: libSong.url,
        isNew: false,
        isLibrary: true,
        file: null,
        duration: libSong.duration
      });
      
      renderLibrary();
      renderSongList();
      updateSongCount();
      updateSongRangeSliders();
      calculateVideoDuration();
      showToast(`Added "${libSong.displayName}"`, 'success');
    }
    
    // Load job data from API
    async function loadJobData(jobId) {
      try {
        console.log('[API] Calling:', `${API_BASE}/jobs/${jobId}`);
        const response = await fetch(`${API_BASE}/jobs/${jobId}`);
    
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    
        const data = await response.json();
        console.log('[API] Response:', data);

        // Load version history
        await loadVersionHistory(jobId);
    
        // Store current settings
        if (data.settings) {
          currentSettings = data.settings;
          
          const deceasedName = data.settings.fullName;
          if (deceasedName && deceasedName !== 'your loved one' && deceasedName !== '') {
            document.getElementById('headerTitle').textContent = `✨ ${deceasedName}'s Memorial Video`;
            document.title = `${deceasedName}'s Memorial Video`;
          }

          displaySummary(data.settings);
        }
    
        // Initialize songs from API response
        if (data.songs && data.songs.length > 0) {
          currentSongs = data.songs.map(song => {
            // Check if this is a library song
            const libSong = SONG_LIBRARY.find(lib => lib.name === song.name);

            // ✅ GET ORIGINAL FILENAME FROM SETTINGS
            const originalName = data.settings?.originalFilenames?.[song.name] || song.name;
            console.log(`[SONG MAP] ${song.name} -> originalName: ${originalName}`);
        
            return {
              id: libSong ? libSong.id : song.name,
              name: song.name,
              displayName: libSong ? libSong.displayName : originalName,
              url: song.url,
              isNew: false,
              isLibrary: !!libSong,
              file: null,
              duration: libSong ? libSong.duration : (song.duration || null)  // ✅ ADD THIS LINE
            };
          });

          currentSongs.forEach(song => {
            if (!song.isLibrary && song.url) {
              const audio = new Audio(song.url);
              audio.addEventListener('loadedmetadata', () => {
                const duration = Math.round(audio.duration);
                song.duration = duration;
                console.log(`[DURATION LOADED] ${song.name}: ${duration}s`);
                calculateVideoDuration(); // Recalculate when duration loads
              });
              audio.addEventListener('error', (e) => {
                console.error(`[DURATION ERROR] Failed to load ${song.name}:`, e);
              });
            }
          });
        } else if (data.settings && data.settings.audioCount > 0) {
          const audioCount = data.settings.audioCount;
          for (let i = 1; i <= audioCount; i++) {
            currentSongs.push({
              id: `song${i}.mp3`,
              name: `song${i}.mp3`,
              displayName: `song${i}.mp3`,
              url: null,
              isNew: false,
              isLibrary: false,
              file: null
            });
          }
        }
    
        // ✅ MOVED HERE: populate form defaults AFTER songs are loaded
        if (data.settings) {
          populateFormDefaults(data.settings);
        }
    
        // Auto-redirect to finalized page if job is already finalized
        if (data.isFinalized && !isFinalized) {
          console.log('[REDIRECT] Job is finalized, redirecting...');
          window.location.replace(`${window.location.origin}${window.location.pathname}?job=${jobId}&finalized=true`);
          return;
        }
    
        displayVideo(data);
        setupManualEditButtons(data);
        renderLibrary();
        renderSongList();
        updateSongCount();
      } catch (error) {
        console.error('[API ERROR]', error);
        showError('Failed to load video data: ' + error.message);
      }
    }

    // Load version history for this job
    async function loadVersionHistory(baseJobId) {
      try {
        console.log('[VERSIONS] Loading version history for:', baseJobId);
        const response = await fetch(`${API_BASE}/jobs/${baseJobId}/versions`);
    
        if (!response.ok) {
          console.warn('[VERSIONS] No version history available');
          return;
        }
    
        const versions = await response.json();
        console.log('[VERSIONS] Loaded:', versions);
    
        allVersions = versions;
        currentVersionIndex = versions.findIndex(v => v.jobId === baseJobId);
    
        if (versions.length > 1) {
          populateVersionDropdown();
        }
      } catch (error) {
        console.error('[VERSIONS ERROR]', error);
      }
    }

    // Populate version dropdown
    function populateVersionDropdown() {
      const selector = document.getElementById('versionSelector');
      const dropdown = document.getElementById('versionDropdown');
  
      if (allVersions.length <= 1) {
        selector.style.display = 'none';
        return;
      }
  
      let html = '';
      allVersions.forEach((version, index) => {
        const versionNum = version.version;
        const createdBy = version.createdBy || 'Unknown';
        const isCurrent = version.jobId === jobId;
        html += `<option value="${index}" ${isCurrent ? 'selected' : ''}>
          v${versionNum} - Made by ${createdBy}${isCurrent ? ' (Current)' : ''}
        </option>`;
      });
  
      dropdown.innerHTML = html;
      selector.style.display = 'block';
  
      updateRevertButton();
    }

    // Update revert button visibility
    function updateRevertButton() {
      const revertBtn = document.getElementById('revertBtn');
      const dropdown = document.getElementById('versionDropdown');
      const selectedIndex = parseInt(dropdown.value);
  
      // Show revert button if viewing an older version
      if (selectedIndex !== currentVersionIndex) {
        revertBtn.style.display = 'inline-block';
      } else {
        revertBtn.style.display = 'none';
      }
    }
    
    function displaySummary(settings) {
      const summaryBox = document.getElementById('summaryBox');
  
      if (!summaryBox) {
        console.warn('[DISPLAY SUMMARY] summaryBox element not found');
        return;
      }
      
      // Format duration
      let durationText = '';
      if (settings.timingMode === 'fixedRuntime' && settings.fixedRuntimeSec) {
        const minutes = Math.floor(settings.fixedRuntimeSec / 60);
        const seconds = settings.fixedRuntimeSec % 60;
        durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      } else if (settings.timingMode === 'perSlide' && settings.perSlideSec) {
        durationText = `${settings.perSlideSec}s per slide`;
      } else if (settings.timingMode === 'fitToSongs') {
        durationText = 'matched to music length';
      } else {
        durationText = 'custom timing';
      }
      
      // Timing mode display name
      const timingModeNames = {
        'fixedRuntime': 'Fixed Runtime',
        'perSlide': 'Per Slide Duration',
        'fitToSongs': 'Fit to Music'
      };
      const timingModeName = timingModeNames[settings.timingMode] || settings.timingMode;
      
      // Visual package display name
      const visualPackageNames = {
        'simple-fade-wipe': 'Simple Fade & Wipe',
        'pages-of-life': 'Pages of Life',
        'floating-frames': 'Floating Frames',
        'zoom-through': 'Zoom Through',
        'blinds-combs-bars': 'Blinds, Combs & Bars'
      };
      const visualPackageName = visualPackageNames[settings.visualPackage] || settings.visualPackage;
      
      // Music distribution display name
      const musicDistNames = {
        'evenlyDistributed': 'Evenly Distributed',
        'specifyPlacement': 'Specify Placement'
      };
      const musicDistName = musicDistNames[settings.musicDistribution] || settings.musicDistribution;
      
      // Build summary
      const audioCount = settings.audioCount || 3;
      summaryBox.innerHTML = `
        Your <strong>${durationText}</strong> video uses <strong>${timingModeName}</strong> mode with <strong>${visualPackageName}</strong> transitions and <strong>${audioCount} song${audioCount !== 1 ? 's' : ''}</strong> (${musicDistName}).
      `;
      
      summaryBox.style.display = 'block';
    }
    
    // Populate form defaults from settings
    function populateFormDefaults(settings) {
      // Transitions
      if (settings.visualPackage) {
        document.getElementById('visualPackage').value = settings.visualPackage;
      }
      
      // Timing
      if (settings.timingMode) {
        const radio = document.querySelector(`input[name="timingMode"][value="${settings.timingMode}"]`);
        if (radio) {
          radio.checked = true;
          handleTimingModeChange(settings.timingMode);
        }
      }
      if (settings.perSlideSec) {
        document.getElementById('perSlideSec').value = settings.perSlideSec;
      }
      if (settings.fixedRuntimeSec) {
        document.getElementById('fixedRuntimeSec').value = settings.fixedRuntimeSec;
      }
      
      // Song Logic - only set if NOT using fitToSongs
      if (settings.timingMode !== 'fitToSongs' && settings.musicDistribution) {
        document.getElementById('musicDistribution').value = settings.musicDistribution;
        handleMusicDistributionChange(settings.musicDistribution);
      }
    }
    // Render song list
    function renderSongList() {
      const container = document.getElementById('songList');
      
      if (currentSongs.length === 0) {
        container.innerHTML = '<div style="color: #999; font-style: italic;">No songs selected. Choose from the library above or upload your own!</div>';
        return;
      }
      
      let html = '';
      currentSongs.forEach((song, index) => {
        const audioId = `audio-${song.id}`;
        const newBadge = song.isNew ? '<span class="song-badge">NEW</span>' : '';
        const libraryBadge = song.isLibrary ? '<span class="song-badge library">LIBRARY</span>' : '';
        
        let itemClass = 'song-item';
        if (song.isNew) itemClass += ' new-upload';
        if (song.isLibrary) itemClass += ' library-song';
        
        const position = index + 1;
        
        html += `
          <div class="${itemClass}">
            <div class="song-info">
              <div class="song-position">${position}</div>
              <span class="song-name">${song.displayName}</span>
              ${newBadge}
              ${libraryBadge}
            </div>
            <div class="song-controls">
              ${song.url ? `<button class="btn-small btn-play" onclick="togglePlay('${audioId}', this)">▶️ Play Song</button>` : ''}
              <button class="btn-small btn-move" onclick="moveSongUp(${index})" ${index === 0 ? 'disabled' : ''}>⬆️ Move Up</button>
              <button class="btn-small btn-move" onclick="moveSongDown(${index})" ${index === currentSongs.length - 1 ? 'disabled' : ''}>⬇️ Move Down</button>
              <button class="btn-small btn-danger" onclick="removeSong(${index})">🗑️</button>
            </div>
            ${song.url ? `<audio id="${audioId}" src="${song.url}" preload="none"></audio>` : ''}
          </div>
        `;
      });
      
      container.innerHTML = html;
      updateSongTracking();
    }
    
    // Toggle audio play/pause
    function togglePlay(audioId, button) {
      const audio = document.getElementById(audioId);
  
      if (currentlyPlayingAudio && currentlyPlayingAudio !== audio) {
        currentlyPlayingAudio.pause();
        currentlyPlayingAudio.currentTime = 0;
        document.querySelectorAll('.btn-play').forEach(btn => {
          btn.textContent = '▶️ Play Song';
          btn.classList.remove('playing');
        });
      }
  
      if (audio.paused) {
        audio.play().catch(err => {
          console.error('Play error:', err);
          button.textContent = '▶️ Play Song';
          button.classList.remove('playing');
        });
        button.textContent = '⏸️ Pause Song';
        button.classList.add('playing');
        currentlyPlayingAudio = audio;
    
        audio.onended = () => {
          button.textContent = '▶️ Play Song';
          button.classList.remove('playing');
          currentlyPlayingAudio = null;
        };
      } else {
        audio.pause();
        audio.currentTime = 0;
        button.textContent = '▶️ Play Song';
        button.classList.remove('playing');
        currentlyPlayingAudio = null;
      }
    }
    
    // Move song up
    function moveSongUp(index) {
      if (index === 0) return;
      const temp = currentSongs[index];
      currentSongs[index] = currentSongs[index - 1];
      currentSongs[index - 1] = temp;
      renderSongList();
      updateSongRangeSliders();
    }
    
    // Move song down
    function moveSongDown(index) {
      if (index === currentSongs.length - 1) return;
      const temp = currentSongs[index];
      currentSongs[index] = currentSongs[index + 1];
      currentSongs[index + 1] = temp;
      renderSongList();
      updateSongRangeSliders();
    }
    
    // Remove song
    function removeSong(index) {
      if (!confirm(`Remove "${currentSongs[index].displayName}"?`)) return;
      currentSongs.splice(index, 1);
      renderLibrary();
      renderSongList();
      updateSongCount();
      updateSongRangeSliders();
      calculateVideoDuration();
    }
      
    // Update song count display
    function updateSongCount() {
      const display = document.getElementById('songCountDisplay');
      const uploadSection = document.getElementById('uploadSection');
      const uploadLabel = document.getElementById('uploadLabel');
      
      const songWord = currentSongs.length === 1 ? 'song' : 'songs';
      display.textContent = `${currentSongs.length} ${songWord} selected`;
      
      if (currentSongs.length >= MAX_SONGS) {
        uploadSection.classList.add('max-reached');
        uploadLabel.classList.add('disabled');
      } else {
        uploadSection.classList.remove('max-reached');
        uploadLabel.classList.remove('disabled');
      }
      
      // Update library add buttons
      renderLibrary();
    }

    // ✅ ADD THIS ENTIRE FUNCTION HERE
    // Calculate and display video duration
    function calculateVideoDuration() {
      const slideCount = null; // Removed manual input - slideCount comes from API
      const timingMode = document.querySelector('input[name="timingMode"]:checked')?.value;

      const displayDiv = document.getElementById('durationDisplay');
      const valueDiv = document.getElementById('durationValue');
      const detailsDiv = document.getElementById('durationDetails');

      console.log('[DURATION CALC] Slide count:', slideCount);
      console.log('[DURATION CALC] Timing mode:', timingMode);
      console.log('[DURATION CALC] Current songs:', currentSongs);
      
      // Hide if no slide count
      if (!slideCount) {
        displayDiv.style.display = 'none';
        return;
      }

      let totalSeconds = 0;
      let detailsText = '';

      if (timingMode === 'perSlide') {
        const perSlideSec = parseInt(document.getElementById('perSlideSec').value) || 5;
        totalSeconds = (slideCount - 2) * perSlideSec + (2 * perSlideSec * 2);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        detailsText = `Video will be ${timeDisplay} long with ${slideCount} slides at ${perSlideSec} seconds per slide (beginning and end slide at ${perSlideSec * 2}s)`;

      } else if (timingMode === 'fixedRuntime') {
        totalSeconds = parseInt(document.getElementById('fixedRuntimeSec').value) || 320;
        const avgPerSlide = Math.round(totalSeconds / slideCount);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        detailsText = `Video will be ${timeDisplay} long across ${slideCount} slides at approximately ${avgPerSlide} seconds per slide`;

      } else if (timingMode === 'fitToSongs') {
        console.log('[FIT TO SONGS] Calculating total duration...'); // ✅ ADD THIS LINE
  
        totalSeconds = currentSongs.reduce((sum, song) => {
          console.log(`[FIT TO SONGS] Song: ${song.displayName}, Duration: ${song.duration}`); // ✅ ADD THIS LINE TOO
          return sum + (song.duration || 0);
        }, 0);
  
        console.log('[FIT TO SONGS] Total seconds:', totalSeconds); // ✅ AND THIS LINE

        if (totalSeconds === 0) {
          detailsText = 'Add songs to calculate duration';
          displayDiv.style.display = 'none';
          return;
        }

        const avgPerSlide = Math.round(totalSeconds / slideCount);
        const songWord = currentSongs.length === 1 ? 'song' : 'songs';
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        detailsText = `Video will be ${timeDisplay} long based on ${currentSongs.length} selected ${songWord} at ${avgPerSlide} seconds per slide (beginning and end slide at ${avgPerSlide * 2}s)`;
      }

      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;

      valueDiv.textContent = formattedTime;
      detailsDiv.textContent = detailsText;
      displayDiv.style.display = 'block';
    }
    
    // Handle new song uploads
    document.getElementById('uploadLabel').addEventListener('click', showMusicTermsModal);
    document.getElementById('newSongUpload').addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
  
      files.forEach(file => {
        if (currentSongs.length >= MAX_SONGS) {
          showToast(`Maximum ${MAX_SONGS} songs reached`, 'error');
          return;
        }
    
        if (!file.type.includes('audio/mpeg') && !file.name.endsWith('.mp3')) {
          showToast(`${file.name} is not an MP3 file`, 'error');
          return;
        }
    
        const localUrl = URL.createObjectURL(file);
    
        // ✅ CREATE AUDIO ELEMENT TO DETECT DURATION
        const audio = new Audio(localUrl);
        audio.addEventListener('loadedmetadata', () => {
          const duration = Math.round(audio.duration);
      
        // Find the song and update its duration
        const song = currentSongs.find(s => s.url === localUrl);
        if (song) {
          song.duration = duration;
          console.log(`[DURATION] ${file.name}: ${duration}s`);
          calculateVideoDuration(); // Recalculate after getting duration
        }
      });
    
      currentSongs.push({
        id: `new-${Date.now()}-${Math.random()}`,
        name: file.name,
        displayName: file.name,
        url: localUrl,
        isNew: true,
        isLibrary: false,
        file: file,
        duration: null  // ✅ ADD THIS - Will be set when metadata loads
      });
    });
  
    renderSongList();
    updateSongCount();
    updateSongRangeSliders();
    calculateVideoDuration();  // ✅ ADD THIS
  
    e.target.value = '';
  });
    document.getElementById('genreSelect').addEventListener('change', () => {
      renderLibrary();
    });

    // Version dropdown change handler
    document.getElementById('versionDropdown').addEventListener('change', async (e) => {
      updateRevertButton();
  
      const selectedIndex = parseInt(e.target.value);
      const selectedVersion = allVersions[selectedIndex];
  
      if (!selectedVersion) return;
  
      console.log('[VERSIONS] Switching to version:', selectedVersion.jobId);
  
      // Reload page with selected version's jobId
      const newUrl = `${window.location.origin}${window.location.pathname}?job=${selectedVersion.jobId}`;
      window.location.href = newUrl;
    });

    // Revert button handler
    document.getElementById('revertBtn').addEventListener('click', async () => {
      const dropdown = document.getElementById('versionDropdown');
      const selectedIndex = parseInt(dropdown.value);
      const selectedVersion = allVersions[selectedIndex];
  
      if (!selectedVersion) return;
  
      const versionNum = selectedVersion.version;
      const confirmed = confirm(
        `Revert to version ${versionNum}?\n\n` +
        'This will create a new version based on the settings from this previous version. ' +
        'You can always switch back to any version later.'
      );
  
      if (!confirmed) return;
  
      try {
        showToast('Creating new version from v' + versionNum + '...', 'success');
    
        // Submit as a resubmission using the old version's settings
        const response = await fetch(`${API_BASE}/jobs/${jobId}/resubmit`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            originalJobId: jobId,
            revertToJobId: selectedVersion.jobId,
            changes: selectedVersion.settings
          })
        });
    
        if (!response.ok) {
          throw new Error('Failed to revert version');
        }
    
        const result = await response.json();
        console.log('[REVERT] Success:', result);
    
        showToast(
          `✅ Successfully created new version from v${versionNum}! ` +
          'You\'ll receive an email in 5-15 minutes.',
          'success'
        );
    
        // Reload after 2 seconds
        setTimeout(() => {
          location.reload();
        }, 2000);
    
      } catch (error) {
        console.error('[REVERT ERROR]', error);
        showToast('Failed to revert: ' + error.message, 'error');
      }
    });
    
    // Handle PowerPoint file upload
    document.getElementById('newPptxUpload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      
      if (!file) return;
      
      if (!file.name.endsWith('.pptx') && !file.type.includes('presentationml')) {
        showToast('Please select a valid PowerPoint (.pptx) file', 'error');
        e.target.value = '';
        return;
      }
      
      newPptxFile = file;
      
      const previewDiv = document.getElementById('pptxFilePreview');
      const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
      
      previewDiv.innerHTML = `
        <div class="pptx-file-preview">
          <div class="pptx-file-info">
            <span class="pptx-file-icon">📄</span>
            <div class="pptx-file-details">
              <span class="pptx-file-name">${file.name}</span>
              <span class="pptx-file-size">${fileSizeMB} MB</span>
            </div>
          </div>
          <button class="btn-small btn-danger" onclick="clearPptxUpload()">🗑️ Remove</button>
        </div>
      `;
      previewDiv.style.display = 'block';
      
      trackChange('newPresentationFile', true);
      showToast('PowerPoint file ready to upload!', 'success');
    });
    
    // Clear PowerPoint upload
    function clearPptxUpload() {
      newPptxFile = null;
      document.getElementById('newPptxUpload').value = '';
      document.getElementById('pptxFilePreview').style.display = 'none';
      delete pendingChanges.newPresentationFile;
      updateResubmitButton();
      showToast('PowerPoint file removed', 'success');
    }
    
    // Track song changes for resubmit
    function updateSongTracking() {
      // ✅ USE DISPLAYNAME WHICH HAS THE ORIGINAL FILENAME
      const songOrder = currentSongs.map(song => {
        // For existing songs from previous submission, use the displayName (which is the original filename)
        // For new songs, use the actual filename
        if (song.isNew && song.file) {
          return song.file.name;
        } else if (song.isLibrary) {
          return song.name; // Library songs use their actual filename
        } else {
          // Existing custom song - use displayName which has the original filename
          return song.displayName;
        }
      });
  
      const newSongs = currentSongs.filter(s => s.isNew).map(s => ({
        originalName: s.file ? s.file.name : s.name,
        file: s.file
      }));
  
      const hasChanges = currentSongs.some(s => s.isNew) || 
                        JSON.stringify(songOrder) !== JSON.stringify(currentSongs.map(s => s.name));
  
      if (hasChanges || newSongs.length > 0) {
        trackChange('songOrder', songOrder);
        if (newSongs.length > 0) {
          trackChange('newSongs', newSongs);
        }
     }
  }
    
    // Setup song range sliders
    function setupSongRangeSliders() {
      const container = document.getElementById('songRangesList');
  
      if (currentSongs.length === 0) {
        container.innerHTML = '<div style="color: #999; font-style: italic;">No songs available. Add songs first.</div>';
        return;
      }
  
      let html = '';
      let exampleStart = 1;
      let exampleEnd = 19;
  
      currentSongs.forEach((song, index) => {
        const audioId = `audio-range-${song.id}`;
        const playButton = song.url ? `<button class="btn-small btn-play" onclick="togglePlay('${audioId}', this)" style="margin-left: 8px;">▶️ Play Song</button>` : '';
    
        // Auto-populate start value: first song starts at 1, others start at previous end + 1
        const startValue = index === 0 ? '1' : '';
        
        // Calculate example placeholders
        const startPlaceholder = `Example: ${exampleStart}`;
        const endPlaceholder = `Example: ${exampleEnd}`;
    
        html += `
          <div class="song-range-item">
            <div class="song-range-header">
              🎵 ${song.displayName}
              ${playButton}
              ${song.url ? `<audio id="${audioId}" src="${song.url}" preload="none"></audio>` : ''}
            </div>
            <div class="slide-inputs">
              <div class="slide-input-group">
                <label>Start Slide</label>
                <input type="number" 
                       id="songRange${index}Start" 
                       class="song-range-input"
                       data-song-index="${index}"
                       data-type="start"
                       min="1" 
                       max="250"
                       value="${startValue}"
                       placeholder="${startPlaceholder}">
              </div>
              <div class="slide-input-group">
                <label>End Slide</label>
                <input type="number" 
                       id="songRange${index}End" 
                       class="song-range-input"
                       data-song-index="${index}"
                       data-type="end"
                       min="1" 
                       max="250" 
                       placeholder="${endPlaceholder}">
              </div>
           </div>
        </div>
      `;
        
       // Update examples for next song
        exampleStart = exampleEnd + 1;
        exampleEnd = exampleStart + 17; // Each song spans about 18 slides in examples
    });
  
    container.innerHTML = html;
  
    document.querySelectorAll('.song-range-input').forEach(input => {
      input.addEventListener('input', handleSongRangeChange);
    });
  }
    
    // Update song range sliders (wrapper for setup)
    function updateSongRangeSliders() {
      const musicDist = document.getElementById('musicDistribution').value;
      
      if (musicDist === 'specifyPlacement') {
        setupSongRangeSliders();
      }
    }
    
    // Handle song range input changes
    function handleSongRangeChange(e) {
      const changedIndex = parseInt(e.target.dataset.songIndex);
      const changedType = e.target.dataset.type;
  
      // If an "End Slide" changed, update the next song's start slide
      if (changedType === 'end' && changedIndex < currentSongs.length - 1) {
        const endValue = parseInt(e.target.value);
        if (!isNaN(endValue)) {
          const nextStartInput = document.getElementById(`songRange${changedIndex + 1}Start`);
          if (nextStartInput) {
            nextStartInput.value = endValue + 1;
          }
        }
     }
  
     // Rebuild songRanges array
     const songRanges = [];

     currentSongs.forEach((song, index) => {
       const startInput = document.getElementById(`songRange${index}Start`);
       const endInput = document.getElementById(`songRange${index}End`);

       if (startInput && endInput) {
         const startVal = parseInt(startInput.value);
         const endVal = parseInt(endInput.value);
  
         if (!isNaN(startVal) && !isNaN(endVal)) {
           // FIX: For uploaded songs, extract filename from S3 URL
           // For library songs, use the original name
           let songIdentifier = song.name;
        
           if (!song.isLibrary && song.url && song.url.startsWith('blob:')) {
             // New upload with blob URL - use the original filename
             songIdentifier = song.name;
           } else if (!song.isLibrary && song.url && song.url.includes('/temp-uploads/')) {
             // Previously uploaded song - extract filename from S3 URL
             songIdentifier = song.url.split('/').pop();
             console.log(`[SONG RANGE] Mapped uploaded song: ${song.name} -> ${songIdentifier}`);
           }
        
           songRanges.push({
             song: songIdentifier,
             startSlide: startVal,
             endSlide: endVal
           });
         }
       }
     });

     if (songRanges.length > 0) {
       trackChange('songRanges', songRanges);
     } else {
       delete pendingChanges.songRanges;
       updateResubmitButton();
     }

     console.log('[SONG RANGES]', songRanges);
   }
    
    // Handle music distribution change
    function handleMusicDistributionChange(value) {
      const container = document.getElementById('songRangesContainer');
      
      if (value === 'specifyPlacement') {
        container.style.display = 'block';
        setupSongRangeSliders();
      } else {
        container.style.display = 'none';
        delete pendingChanges.songRanges;
        updateResubmitButton();
      }
    }
    
    // Setup manual edit buttons based on presentation type
    function setupManualEditButtons(data) {
      const container = document.getElementById('manualEditButtons');
      const infoBox = document.getElementById('manualEditInfoBox');
      const pptxUploadSection = document.getElementById('pptxUploadSection');
      
      if (data.provider === 'google_slides') {
        infoBox.innerHTML = 'Select to edit your <strong>Google Slides</strong> to make manual changes, and once you are done you may select "Resubmit Changes" at the bottom along with any other changes you made. This version will be published in the next Video.';
        pptxUploadSection.style.display = 'none';
      } else if (data.provider === 'powerpoint') {
        infoBox.innerHTML = 'Select to edit your <strong>PowerPoint</strong> to make manual changes, or upload a new PowerPoint file below. Once you are done, select "Resubmit Changes" at the bottom along with any other changes you made. This version will be published in the next Video.';
        pptxUploadSection.style.display = 'block';
      }
      
      if (data.provider === 'google_slides' && data.original_url) {
        container.innerHTML = `
          <button class="btn btn-primary" onclick="handleManualEditClick('${data.original_url}')">
            📊 Edit Google Slides
          </button>
        `;
      } else if (data.provider === 'powerpoint' && data.original_url) {
        container.innerHTML = `
          <button class="btn btn-primary" onclick="handleManualEditClick('${data.original_url}')">
            📄 Edit PowerPoint
          </button>
        `;
      } else {
        container.innerHTML = `
          <div style="color: #999; font-style: italic;">
            Presentation link not available for this job.
          </div>
        `;
      }
    }
    
    // Handle manual edit button click
    function handleManualEditClick(url) {
      window.open(url, '_blank');
      trackChange('manualEditsRequested', true);
      showToast('Presentation opened! Make your changes, then click "Resubmit Changes" when done.', 'success');
    }
    
    // Display video and controls
    function displayVideo(data) {
      const container = document.getElementById('videoContainer');
      const jobInfo = document.getElementById('jobInfo');
      
      jobInfo.textContent = `Order #${data.jobId}`;
      
      if (isFinalized) {
        container.innerHTML = `
          <div class="video-wrapper">
            <video controls preload="auto">
              <source src="${data.videoUrl}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>
        `;
        
        document.getElementById('actionButtons').style.display = 'none';
        document.getElementById('finalizedMessage').style.display = 'block';
        document.getElementById('finalDownloadBtn').href = data.downloadUrl || data.videoUrl;
        return;
      }
      
      container.innerHTML = `
        <div class="video-wrapper">
          <video controls preload="auto" crossorigin="anonymous">
            <source src="${data.videoUrl}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        </div>
      `;
      
      const video = container.querySelector('video');
      video.addEventListener('loadstart', () => console.log('[VIDEO] Loading started'));
      video.addEventListener('loadedmetadata', () => console.log('[VIDEO] Metadata loaded'));
      video.addEventListener('canplay', () => console.log('[VIDEO] Can play'));
      video.addEventListener('error', (e) => {
        console.error('[VIDEO ERROR]', e);
        console.error('[VIDEO ERROR] Details:', video.error);
        showError('Video failed to load. The file may be corrupted or the URL expired.');
      });
      
      document.getElementById('editBtn').style.display = 'inline-flex';
      document.getElementById('shareBtn').style.display = 'inline-flex';
      document.getElementById('deliverBtn').style.display = 'inline-flex';
      document.getElementById('helpBtn').style.display = 'inline-flex';
      document.getElementById('finalizeBtn').style.display = 'inline-flex';
      
      window.videoData = data;
      
      setupFinalizeButton();
      setupEditButton();
    }
    
    // Show error message
    function showError(message) {
      const container = document.getElementById('videoContainer');
      container.innerHTML = `<div class="error">${message}</div>`;
    }
    
    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }
    
    // Edit button handler
    function setupEditButton() {
      document.getElementById('editBtn').addEventListener('click', () => {
        const editSections = document.getElementById('editSections');
        const isVisible = editSections.style.display !== 'none';
        
        if (isVisible) {
          editSections.style.display = 'none';
          document.getElementById('editBtn').innerHTML = '✏️ Edit & Republish My Video (unlimited submissions)';
        } else {
          editSections.style.display = 'block';
          document.getElementById('editBtn').innerHTML = '❌ Hide Edit Options';
          editSections.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }
    
    // Finalize button handler
    function setupFinalizeButton() {
      document.getElementById('finalizeBtn').addEventListener('click', () => {
        openConfirmModal('finalize');
      });
    }
    
    // Share button handler
    document.getElementById('shareBtn').addEventListener('click', async () => {
      openShareModal();
    });

    // Deliver to Coordinator button handler
    document.getElementById('deliverBtn').addEventListener('click', () => {
      openConfirmModal('deliver');
    });

    // Open deliver modal
    function openDeliverModal() {
      document.getElementById('deliverModal').classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    // Close deliver modal
    function closeDeliverModal() {
      document.getElementById('deliverModal').classList.remove('show');
      document.body.style.overflow = 'auto';
      document.getElementById('deliverForm').reset();
      document.querySelectorAll('.modal-form-group input').forEach(input => {
        input.classList.remove('error');
      });
    }

    // Submit delivery
    async function submitDelivery() {
      const firstName = document.getElementById('coordFirstName').value.trim();
      const lastName = document.getElementById('coordLastName').value.trim();
      const orgName = document.getElementById('coordOrgName').value.trim();
      const email = document.getElementById('coordEmail').value.trim();
  
     // Validation
     let hasError = false;
  
     if (!firstName) {
       document.getElementById('coordFirstName').classList.add('error');
       hasError = true;
     } else {
       document.getElementById('coordFirstName').classList.remove('error');
     }
  
     if (!lastName) {
       document.getElementById('coordLastName').classList.add('error');
       hasError = true;
     } else {
       document.getElementById('coordLastName').classList.remove('error');
     }
  
     if (!orgName) {
       document.getElementById('coordOrgName').classList.add('error');
       hasError = true;
     } else {
       document.getElementById('coordOrgName').classList.remove('error');
     }
  
     if (!email || !email.includes('@')) {
       document.getElementById('coordEmail').classList.add('error');
       hasError = true;
     } else {
       document.getElementById('coordEmail').classList.remove('error');
     }
  
     if (hasError) {
       showToast('Please fill in all required fields correctly', 'error');
       return;
     }
  
     const submitBtn = document.getElementById('deliverSubmitBtn');
     submitBtn.disabled = true;
     submitBtn.textContent = '📤 Sending...';
  
     try {
       console.log('[DELIVER] Sending to coordinator:', {
         jobId,
         firstName,
         lastName,
         orgName,
         email
      });
    
      // Real API call
      const response = await fetch(`${API_BASE}/jobs/${jobId}/deliver-to-coordinator`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
        firstName: firstName,
        lastName: lastName,
        orgName: orgName,
        email: email
      })
    });

if (!response.ok) {
  const errorData = await response.json();
  throw new Error(errorData.error || 'Failed to deliver video');
}

const result = await response.json();
console.log('[DELIVER] Success:', result);

showToast('✅ Video successfully delivered to ' + email, 'success');
closeDeliverModal();
    
    } catch (error) {
      console.error('[DELIVER ERROR]', error);
      showToast('Failed to deliver video: ' + error.message, 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = '📤 Send to Coordinator';
    }
  }

  // Close modal when clicking outside
  document.getElementById('deliverModal').addEventListener('click', (e) => {
    if (e.target.id === 'deliverModal') {
      closeDeliverModal();
    }
  });
    
  // Help Needed button handler
  document.getElementById('helpBtn').addEventListener('click', () => {
    openHelpModal();
  });

  // Open help modal
  function openHelpModal() {
    document.getElementById('helpModal').classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  // Close help modal
  function closeHelpModal() {
    document.getElementById('helpModal').classList.remove('show');
    document.body.style.overflow = 'auto';
    document.getElementById('helpForm').reset();
    document.querySelectorAll('#helpForm .modal-form-group input').forEach(input => {
      input.classList.remove('error');
    });
  }

  // Submit help request
  async function submitHelp() {
    const firstName = document.getElementById('helpFirstName').value.trim();
    const lastName = document.getElementById('helpLastName').value.trim();
    const email = document.getElementById('helpEmail').value.trim();

    // Validation
    let hasError = false;

    if (!firstName) {
      document.getElementById('helpFirstName').classList.add('error');
      hasError = true;
    } else {
      document.getElementById('helpFirstName').classList.remove('error');
    }

    if (!lastName) {
      document.getElementById('helpLastName').classList.add('error');
      hasError = true;
    } else {
      document.getElementById('helpLastName').classList.remove('error');
    } 

    if (!email || !email.includes('@')) {
      document.getElementById('helpEmail').classList.add('error');
      hasError = true;
    } else {
      document.getElementById('helpEmail').classList.remove('error');
    }

    if (hasError) {
      showToast('Please fill in all required fields correctly', 'error');
      return;
    }

    const submitBtn = document.getElementById('helpSubmitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = '✉️ Sending...';

    try {
      console.log('[HELP] Sending help request:', {
        jobId,
        firstName,
        lastName,
        email
      });

      // Real API call
      const response = await fetch(`${API_BASE}/jobs/${jobId}/request-help`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
        firstName: firstName,
        lastName: lastName,
        email: email
      })
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to send help request');
    }

    const result = await response.json();
    console.log('[HELP] Success:', result);

    showToast('✅ Help request form sent to ' + email, 'success');
    closeHelpModal();

    } catch (error) {
      console.error('[HELP ERROR]', error);
      showToast('Failed to send help request: ' + error.message, 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = '✉️ Send me a help request form';
    }
  }

  // Close modal when clicking outside
  document.getElementById('helpModal').addEventListener('click', (e) => {
    if (e.target.id === 'helpModal') {
      closeHelpModal();
    }
  });

  // Share Modal Functions
  let recipientCount = 0;
  let recipients = [];

  // Open share modal
  function openShareModal() {
    document.getElementById('shareModal').classList.add('show');
    document.body.style.overflow = 'hidden';
  
    // Initialize with one recipient if empty
    if (recipientCount === 0) {
      addRecipient();
    }
  }

  // Close share modal
  function closeShareModal() {
    document.getElementById('shareModal').classList.remove('show');
    document.body.style.overflow = 'auto';
  
    // Reset recipients
    recipientCount = 0;
    recipients = [];
    document.getElementById('recipientsList').innerHTML = '';
  }

  // Add recipient
  function addRecipient() {
    recipientCount++;
    const recipientId = `recipient-${recipientCount}`;
  
    const recipientHtml = `
      <div class="recipient-item ${recipientCount === 1 ? '' : 'last'}" id="${recipientId}">
        <div class="recipient-number">${recipientCount}</div>
        ${recipientCount > 1 ? `<button type="button" class="recipient-remove" onclick="removeRecipient('${recipientId}')">×</button>` : ''}
        <div class="recipient-fields">
          <div class="modal-form-row">
            <div class="modal-form-group">
              <label>First Name<span class="required">*</span></label>
              <input type="text" id="${recipientId}-firstName" required placeholder="Jane" class="recipient-input">
            </div>
            <div class="modal-form-group">
              <label>Last Name<span class="required">*</span></label>
              <input type="text" id="${recipientId}-lastName" required placeholder="Smith" class="recipient-input">
            </div>
          </div>
          <div class="modal-form-group">
            <label>Email Address<span class="required">*</span></label>
            <input type="email" id="${recipientId}-email" required placeholder="jane@example.com" class="recipient-input">
          </div>
        </div>
      </div>
    `;
  
    // Remove 'last' class from all items
    document.querySelectorAll('.recipient-item').forEach(item => {
      item.classList.remove('last');
    });
  
    document.getElementById('recipientsList').insertAdjacentHTML('beforeend', recipientHtml);
  
    // Add 'last' class to the newly added item
    document.getElementById(recipientId).classList.add('last');
  }

  // Remove recipient
  function removeRecipient(recipientId) {
    const item = document.getElementById(recipientId);
    if (item) {
      item.remove();
      recipientCount--;
    
      // Renumber remaining recipients
      const items = document.querySelectorAll('.recipient-item');
      items.forEach((item, index) => {
        const number = item.querySelector('.recipient-number');
        if (number) {
          number.textContent = index + 1;
        }
      
        // Add 'last' class only to the last item
        item.classList.remove('last');
        if (index === items.length - 1) {
          item.classList.add('last');
        }
      });
    }
  }

  // Submit share
  async function submitShare() {
    const recipientItems = document.querySelectorAll('.recipient-item');
    const recipientData = [];
    let hasError = false;
  
    recipientItems.forEach(item => {
      const id = item.id;
      const firstName = document.getElementById(`${id}-firstName`);
      const lastName = document.getElementById(`${id}-lastName`);
      const email = document.getElementById(`${id}-email`);
    
      // Validation
      if (!firstName.value.trim()) {
        firstName.classList.add('error');
        hasError = true;
      } else {
        firstName.classList.remove('error');
      }
    
      if (!lastName.value.trim()) {
        lastName.classList.add('error');
        hasError = true;
      } else {
        lastName.classList.remove('error');
      }
    
      if (!email.value.trim() || !email.value.includes('@')) {
        email.classList.add('error');
        hasError = true;
      } else {
        email.classList.remove('error');
      }
    
      if (firstName.value.trim() && lastName.value.trim() && email.value.trim()) {
        recipientData.push({
          firstName: firstName.value.trim(),
          lastName: lastName.value.trim(),
          email: email.value.trim()
        });
      }
    });
  
    if (hasError) {
      showToast('Please fill in all required fields correctly', 'error');
      return;
    }
  
    if (recipientData.length === 0) {
      showToast('Please add at least one recipient', 'error');
      return;
    }
  
    const submitBtn = document.getElementById('shareSubmitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = '📤 Sending...';
  
    try {
      console.log('[SHARE] Sending invitations to:', {
        jobId,
        recipients: recipientData
      });
    
      // Real API call
      const response = await fetch(`${API_BASE}/jobs/${jobId}/share-with-recipients`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          recipients: recipientData
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to send invitations');
      }

      const result = await response.json();
      console.log('[SHARE] Success:', result);

      const recipientCount = recipientData.length;
      const recipientWord = recipientCount === 1 ? 'recipient' : 'recipients';
      showToast(`✅ Invitations sent to ${recipientCount} ${recipientWord}`, 'success');
      closeShareModal();
    
    } catch (error) {
      console.error('[SHARE ERROR]', error);
      showToast('Failed to send invitations: ' + error.message, 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = '📤 Send Invitations';
    }
  }

  // Close modal when clicking outside
  document.getElementById('shareModal').addEventListener('click', (e) => {
    if (e.target.id === 'shareModal') {
      closeShareModal();
    }
  });
    
    // Edit section expansion
    document.querySelectorAll('.edit-option-header').forEach(header => {
      header.addEventListener('click', () => {
        const option = header.closest('.edit-option');
        option.classList.toggle('expanded');
      });
    });
    
    // Track form changes
    function trackChange(fieldName, value) {
      if (value === '' || value === null || value === undefined) {
        delete pendingChanges[fieldName];
      } else {
        pendingChanges[fieldName] = value;
      }
      updateResubmitButton();
      console.log('[CHANGES]', pendingChanges);
    }
    
    // Update resubmit button state
    function updateResubmitButton() {
      const btn = document.getElementById('resubmitBtn');
      btn.onclick = calculateVideo;
      const hasChanges = Object.keys(pendingChanges).length > 0;
      btn.disabled = !hasChanges;
  
      // Updated text to match calculation flow
      btn.textContent = '🚀 Calculate My Video';
    }
    
    // Transition preview video mapping
    const TRANSITION_VIDEOS = {
      'simple-fade-wipe': 'https://www.dropbox.com/scl/fi/k6pgu0l030j717hwl9su5/Transition-Examples-Simple-Fade-and-Wipe-2.mp4?rlkey=vuouggk7p2l8qd6ecsxqcj0id&st=0p2ivtrj&dl=1',
      'pages-of-life': 'https://www.dropbox.com/scl/fi/o285ltxtsrpqws5gvaw3h/Transition-Examples-Pages-of-Life-2.mp4?rlkey=xkhdb1oa8wd0m46vgewi3gp9f&st=zv8vokof&dl=1',
      'floating-frames': 'https://www.dropbox.com/scl/fi/l7ifvko5rdumtp2ssa1cb/Transition-Examples-Floating-Frames-2.mp4?rlkey=seyficxdrpnu9vmg63ydbw09i&st=lgbll6sa&dl=1',
      'zoom-through': 'https://www.dropbox.com/scl/fi/xbochmmlgl0v430lo7l6q/Transition-Examples-Zoom-Through-2.mp4?rlkey=kkgfphukmjg2sa8m69egd36nq&st=9hr8hm8c&dl=1',
      'blinds-combs-bars': 'https://www.dropbox.com/scl/fi/yu49ywzg9lnpfvbkpngun/Transition-Examples-Blinds-Combs-Bars-2.mp4?rlkey=itoxqenf61i2cm746kvn2fjbl&st=wk0xl254&dl=1'
    };

    // Setup change tracking for all form elements
    document.getElementById('visualPackage').addEventListener('change', (e) => {
      const selectedValue = e.target.value;
      const videoSource = document.getElementById('transitionPreviewSource');
      const video = document.getElementById('transitionPreview');
  
      if (selectedValue && TRANSITION_VIDEOS[selectedValue]) {
        videoSource.src = TRANSITION_VIDEOS[selectedValue];
        video.load();
      }
  
      trackChange('visualPackage', e.target.value);
    });
    
    document.querySelectorAll('input[name="timingMode"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const mode = e.target.value;
        handleTimingModeChange(mode);
        trackChange('timingMode', mode);
    
        // Handle Song Logic section based on timing mode
        const songLogicSection = document.querySelector('[data-section="songlogic"]');
        const musicDistSelect = document.getElementById('musicDistribution');
    
        if (mode === 'fitToSongs') {
          // Disable Song Logic section when Fit to Music is selected
          if (songLogicSection) {
            songLogicSection.style.opacity = '0.5';
            songLogicSection.style.pointerEvents = 'none';
          }
          musicDistSelect.value = '';
          delete pendingChanges.musicDistribution;
          delete pendingChanges.songRanges;
          document.getElementById('songRangesContainer').style.display = 'none';
          updateResubmitButton();
        } else {
          // Re-enable Song Logic section
          if (songLogicSection) {
            songLogicSection.style.opacity = '1';
            songLogicSection.style.pointerEvents = 'auto';
          }
        }
    
        if (mode === 'perSlide') {
          trackChange('perSlideSec', document.getElementById('perSlideSec').value);
        } else if (mode === 'fixedRuntime') {
          trackChange('fixedRuntimeSec', document.getElementById('fixedRuntimeSec').value);
        }

        calculateVideoDuration();
      });
    });
    
    function handleTimingModeChange(mode) {
      document.getElementById('perSlideInput').style.display = 'none';
      document.getElementById('fixedRuntimeInput').style.display = 'none';
  
      // Handle the fit to music notice
      const fitToMusicNotice = document.getElementById('fitToMusicNotice');
      const musicDistSelect = document.getElementById('musicDistribution');
  
      if (mode === 'fitToSongs') {
        if (fitToMusicNotice) fitToMusicNotice.style.display = 'block';
        musicDistSelect.disabled = true;
      } else {
        if (fitToMusicNotice) fitToMusicNotice.style.display = 'none';
        musicDistSelect.disabled = false;
      }
  
      document.querySelectorAll('.radio-option').forEach(opt => {
        opt.classList.remove('selected');
      });
  
      const selectedRadio = document.querySelector(`input[name="timingMode"][value="${mode}"]`);
      if (selectedRadio) {
        selectedRadio.closest('.radio-option').classList.add('selected');
    
        if (mode === 'perSlide') {
          document.getElementById('perSlideInput').style.display = 'block';
        } else if (mode === 'fixedRuntime') {
          document.getElementById('fixedRuntimeInput').style.display = 'block';
        }
     }
  }
    
    document.getElementById('perSlideSec').addEventListener('input', (e) => {
      trackChange('perSlideSec', parseFloat(e.target.value));
      calculateVideoDuration();
    });
    
    document.getElementById('fixedRuntimeSec').addEventListener('input', (e) => {
      trackChange('fixedRuntimeSec', parseFloat(e.target.value));
      calculateVideoDuration();
    });

    
    document.getElementById('musicDistribution').addEventListener('change', (e) => {
      const value = e.target.value;
  
      // Check if Fit to Music is selected
      const timingMode = document.querySelector('input[name="timingMode"]:checked')?.value;
      if (timingMode === 'fitToSongs') {
        showToast('"Fit to Music Length" determines your Song Logic automatically', 'error');
        e.target.value = ''; // Reset selection
        return;
      }
  
      trackChange('musicDistribution', value);
      handleMusicDistributionChange(value);
    });

    // ========== CALCULATION FUNCTIONS ==========
    
    // Calculate video before submission
    async function calculateVideo() {
      console.log('[CALCULATE] Starting calculation...');
      
      // Show loading state on the button
      const calculateBtn = document.getElementById('resubmitBtn');
      const originalText = calculateBtn.textContent;
      calculateBtn.textContent = 'Calculating...';
      calculateBtn.disabled = true;
      
      try {
        // Get presentation type from pending changes or form
        const presentationType = pendingChanges.presentationType || 
                                (currentSettings.provider === 'powerpoint' ? 'powerpoint_url' : currentSettings.provider) || 
                                document.querySelector('input[name="presentationType"]:checked')?.value;
        
        if (!presentationType) {
          alert('Please select a presentation type');
          calculateBtn.textContent = originalText;
          calculateBtn.disabled = false;
          return;
        }
        
        // Get presentation source based on type
        let presentationSource;
        if (presentationType === 'google_slides') {
          presentationSource = pendingChanges.presentationUrl || currentSettings.original_url;
        } else if (presentationType === 'powerpoint_url') {
          presentationSource = pendingChanges.presentationUrl || currentSettings.original_url;
        } else if (presentationType === 'powerpoint_file' || presentationType === 'pptx') {
          // If there's a new file uploaded, we need to upload it first
          if (newPptxFile) {
            console.log('[CALCULATE] Uploading new PowerPoint file first...');
            presentationSource = await uploadPowerPointForCalculation(jobId, newPptxFile);
          } else {
            // Use existing presentation from S3
            presentationSource = currentSettings.original_url || `https://order-by-age-uploads.s3.us-east-2.amazonaws.com/input/${jobId}/presentation.pptx`;
          }
        }
        
        if (!presentationSource) {
          alert('No presentation source found. Please upload or select a presentation.');
          calculateBtn.textContent = originalText;
          calculateBtn.disabled = false;
          return;
        }
        
        console.log('[CALCULATE] Calling Lambda...', {
          jobId: jobId,
          presentationType: presentationType,
          presentationSource: presentationSource
        });
        
        // Call the calculation Lambda (same one used by main form)
        const response = await fetch(`${API_BASE}/jobs/${jobId}/calculate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            presentationType: presentationType,
            presentationSource: presentationSource
          })
        });
        
        const result = await response.json();
        console.log('[CALCULATE] Lambda response:', result);
        
        if (!response.ok) {
          throw new Error(result.error || 'Failed to calculate video');
        }
        
        const slideCount = result.slideCount;
        
        // STEP 3: Calculate duration based on timing mode and songs
        const timingMode = document.querySelector('input[name="timingMode"]:checked').value;
        let estimatedSeconds = 0;
        let durationText = '';
        let summaryText = '';
        
        // Calculate total music duration
        let totalMusicSeconds = 0;
        for (const song of currentSongs) {
          totalMusicSeconds += song.duration || 180; // Default 3 min if no duration
        }
        
        if (timingMode === 'fixedRuntime') {
          estimatedSeconds = parseInt(document.getElementById('fixedRuntimeSec').value) || 350;
          const minutes = Math.floor(estimatedSeconds / 60);
          const seconds = estimatedSeconds % 60;
          durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          
          const perSlide = (estimatedSeconds / slideCount).toFixed(1);
          summaryText = `Your video will be exactly ${minutes} minutes and ${seconds} seconds long with ${slideCount} slides (approximately ${perSlide} seconds per slide).`;
          
        } else if (timingMode === 'perSlide') {
          const perSlide = parseInt(document.getElementById('perSlideSec').value) || 5;
          estimatedSeconds = slideCount * perSlide;
          const minutes = Math.floor(estimatedSeconds / 60);
          const seconds = estimatedSeconds % 60;
          durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          
          summaryText = `Your video will be approximately ${minutes} minutes and ${seconds} seconds long with ${slideCount} slides at ${perSlide} seconds per slide.`;
          
        } else if (timingMode === 'matchMusic') {
          estimatedSeconds = totalMusicSeconds;
          const minutes = Math.floor(estimatedSeconds / 60);
          const seconds = estimatedSeconds % 60;
          durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          
          const perSlide = (estimatedSeconds / slideCount).toFixed(1);
          summaryText = `Your video will match your music length of ${minutes} minutes and ${seconds} seconds with ${slideCount} slides (approximately ${perSlide} seconds per slide).`;
        }
        
        // Show modal with results
        showCalculationModal(slideCount, durationText, summaryText);
        
      } catch (error) {
        console.error('[CALCULATE ERROR]', error);
        alert(`Failed to calculate video: ${error.message}`);
      } finally {
        calculateBtn.textContent = originalText;
        calculateBtn.disabled = false;
      }
    }
    
    // Upload PowerPoint file for calculation only
    async function uploadPowerPointForCalculation(jobId, file) {
      console.log('[CALCULATE UPLOAD] Uploading PowerPoint to temp location...');
      
      const urlResponse = await fetch(`${API_BASE}/generate-upload-url`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          jobId: jobId,
          fileType: 'presentation',
          fileExtension: 'pptx'
        })
      });
      
      if (!urlResponse.ok) throw new Error('Failed to get PowerPoint upload URL');
      
      const {uploadUrl, s3Key} = await urlResponse.json();
      
      const uploadResponse = await fetch(uploadUrl, {
        method: 'PUT',
        headers: {'Content-Type': 'application/vnd.openxmlformats-officedocument.presentationml.presentation'},
        body: file
      });
      
      if (!uploadResponse.ok) throw new Error('Failed to upload PowerPoint');
      
      // Return S3 URL
      const s3Url = `https://order-by-age-uploads.s3.us-east-2.amazonaws.com/${s3Key}`;
      console.log('[CALCULATE UPLOAD] PowerPoint uploaded:', s3Url);
      return s3Url;
    }
    
    // Show calculation modal
    function showCalculationModal(slideCount, duration) {
      document.getElementById('modalSlideCount').textContent = `${slideCount} slides`;
      document.getElementById('modalDuration').textContent = duration;
      document.getElementById('modalSummary').textContent = 
        `Your updated video will have ${slideCount} slides with an estimated duration of ${duration}.`;

      document.getElementById('calculationModal').classList.add('show');
    }

    // Close calculation modal
    function closeCalculationModal() {
      document.getElementById('calculationModal').classList.remove('show');
    }

    // Close modal when clicking outside - wrapped to run after DOM loads
    window.addEventListener('DOMContentLoaded', function() {
      const calcModal = document.getElementById('calculationModal');
      if (calcModal) {
        calcModal.addEventListener('click', (e) => {
          if (e.target.id === 'calculationModal') {
            closeCalculationModal();
          }
        });
      }
    });
    
    // ========== END CALCULATION FUNCTIONS ==========

    // Final submit function (called from calculation modal)
    async function finalSubmit() {
      // Close the calculation modal
      closeCalculationModal();
      
      if (Object.keys(pendingChanges).length === 0) {
        showToast('No changes to submit', 'error');
        return;
      }
      
      const confirmed = confirm(
        `Create a new video with ${Object.keys(pendingChanges).length} change(s)?\n\n` +
        'You will receive an email in 5-15 minutes with your new video.'
      );
      
      if (!confirmed) return;
      
      try {
        showToast('Uploading files...', 'success');
        console.log('[RESUBMIT] Preparing submission...');
        
        // Build settings from form values (form is pre-populated for user convenience)
        const completeSettings = {
          customerEmail: currentSettings.customerEmail,
          fullName: currentSettings.fullName,
          provider: currentSettings.provider,
          original_url: currentSettings.original_url,
          timingMode: document.querySelector('input[name="timingMode"]:checked')?.value || 'perSlide',
          perSlideSec: parseFloat(document.getElementById('perSlideSec').value) || 5,
          fixedRuntimeSec: parseFloat(document.getElementById('fixedRuntimeSec').value) || 350,
          visualPackage: document.getElementById('visualPackage').value || 'simple-fade-wipe',
          musicDistribution: document.getElementById('musicDistribution').value || 'evenlyDistributed',
          songOrder: currentSongs.map(s => s.name),
          audioCount: currentSongs.length
        };

        // ✅ ONLY ADD SONG RANGES IF musicDistribution is specifyPlacement AND they exist in pendingChanges
        if (completeSettings.musicDistribution === 'specifyPlacement' && pendingChanges.songRanges && pendingChanges.songRanges.length > 0) {
          completeSettings.songRanges = pendingChanges.songRanges;
          console.log('[RESUBMIT] Including songRanges:', pendingChanges.songRanges);
        } else {
          // ✅ EXPLICITLY REMOVE songRanges if not using specifyPlacement
          delete completeSettings.songRanges;
          console.log('[RESUBMIT] Removed songRanges (not using specifyPlacement)');
        }

        console.log('[RESUBMIT] Complete settings:', completeSettings);
        
        const submitData = {
          originalJobId: jobId,
          changes: completeSettings
        };

        // ✅ ADD THIS BLOCK:
        if (isSharedView) {
          const sharedByEmail = urlParams.get('email');
          const sharedByName = urlParams.get('name');
  
          submitData.sharedBy = {
            email: sharedByEmail,
            name: sharedByName
        };
      }
        
        // STEP 1: Upload PowerPoint file to S3 if present
        if (newPptxFile) {
          console.log('[UPLOAD] Getting presigned URL for PowerPoint...');
          
          const urlResponse = await fetch(`${API_BASE}/generate-upload-url`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              jobId: jobId,
              fileType: 'presentation',
              fileExtension: 'pptx'
            })
          });
          
          if (!urlResponse.ok) throw new Error('Failed to get PowerPoint upload URL');
          
          const {uploadUrl, s3Key} = await urlResponse.json();
          
          console.log('[UPLOAD] Uploading PowerPoint to S3...');
          
          const uploadResponse = await fetch(uploadUrl, {
            method: 'PUT',
            headers: {'Content-Type': 'application/vnd.openxmlformats-officedocument.presentationml.presentation'},
            body: newPptxFile
          });
          
          if (!uploadResponse.ok) throw new Error('Failed to upload PowerPoint');
          
          submitData.changes.newPresentationS3Key = s3Key;
          console.log('[UPLOAD] PowerPoint uploaded successfully');
        }
        
        // STEP 2: Upload new songs to S3 if present
        const newSongFiles = currentSongs.filter(s => s.isNew && s.file);
        
        if (newSongFiles.length > 0) {
          const uploadedSongs = [];
          
          for (let i = 0; i < newSongFiles.length; i++) {
            const song = newSongFiles[i];
            
            console.log(`[UPLOAD] Getting presigned URL for song ${i + 1}...`);
            
            const urlResponse = await fetch(`${API_BASE}/generate-upload-url`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                jobId: jobId,
                fileType: 'song',
                fileNumber: i + 1,
                fileExtension: 'mp3'
              })
            });
            
            if (!urlResponse.ok) throw new Error(`Failed to get upload URL for song ${i + 1}`);
            
            const {uploadUrl, s3Key} = await urlResponse.json();
            
            console.log(`[UPLOAD] Uploading song ${i + 1} to S3...`);
            
            const uploadResponse = await fetch(uploadUrl, {
              method: 'PUT',
              headers: {'Content-Type': 'audio/mpeg'},
              body: song.file
            });
            
            if (!uploadResponse.ok) throw new Error(`Failed to upload song ${i + 1}`);
            
            uploadedSongs.push({
              originalName: song.name,
              s3Key: s3Key
            });
            
            console.log(`[UPLOAD] Song ${i + 1} uploaded successfully`);
          }
          
          submitData.changes.newSongs = uploadedSongs;
          console.log('[UPLOAD] All songs uploaded');
        }
        
        // Add manualEditsRequested flag if it was set
        if (pendingChanges.manualEditsRequested) {
          submitData.changes.manualEditsRequested = true;
        }
        
        // STEP 3: Submit metadata to resubmit API
        console.log('[RESUBMIT] Submitting to API...');
        console.log('[RESUBMIT] Payload:', JSON.stringify(submitData, null, 2));
        showToast('Processing changes...', 'success');
        
        const response = await fetch(`${API_BASE}/jobs/${jobId}/resubmit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(submitData)
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || errorData.details || `HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('[RESUBMIT] Success:', result);
        
        // Show thank you overlay
        document.getElementById('resubmitThankYouOverlay').style.display = 'block';

        // Hide the main container
        document.querySelector('.container').style.display = 'none';

        // Clear changes
        pendingChanges = {};
        newPptxFile = null;
        
      } catch (error) {
        console.error('[RESUBMIT ERROR]', error);
        showToast('Failed to resubmit: ' + error.message, 'error');
      }
    }

    // Confirmation Modal State
    let confirmModalAction = null; // 'deliver' or 'finalize'

    // Open confirmation modal
    function openConfirmModal(action) {
      confirmModalAction = action;
      const modal = document.getElementById('confirmModal');
      const title = document.getElementById('confirmModalTitle');
      const subtitle = document.getElementById('confirmModalSubtitle');
      const message = document.getElementById('confirmModalMessage');
      const proceedBtn = document.getElementById('confirmProceedBtn');
      const header = document.getElementById('confirmModalHeader');
    
      // Get video URL from current video
      const currentVideo = document.querySelector('.video-wrapper video');
      const videoUrl = currentVideo ? currentVideo.querySelector('source').src : '';
    
      // Set video source
      document.getElementById('confirmVideoSource').src = videoUrl;
      document.getElementById('confirmVideo').load();
    
      // Customize based on action
      if (action === 'deliver') {
        header.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
        title.innerHTML = '⛪️ Confirm Video for Coordinator';
        subtitle.textContent = 'Please review your video before sending';
        message.innerHTML = '📧 Can you confirm this is the video you wish to send to your event coordinator?';
        proceedBtn.innerHTML = '✅ Yes, Continue to Delivery';
        proceedBtn.className = 'modal-btn modal-btn-primary';
      } else if (action === 'finalize') {
        header.style.background = 'linear-gradient(135deg, #2196F3 0%, #0b7dda 100%)';
        title.innerHTML = '✅ Confirm Final Video';
        subtitle.textContent = 'Please review your video before finalizing';
        message.innerHTML = '🎬 Can you confirm this is the final video you wish to submit? You won\'t be able to make anymore edits after this.';
        proceedBtn.innerHTML = '✅ Yes, Continue to Finalize';
        proceedBtn.className = 'modal-btn modal-btn-info';
      }
    
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    // Close confirmation modal
    function closeConfirmModal() {
      const modal = document.getElementById('confirmModal');
      const video = document.getElementById('confirmVideo');
    
      // Pause video
      video.pause();
      video.currentTime = 0;
    
      modal.classList.remove('show');
      document.body.style.overflow = 'auto';
      confirmModalAction = null;
    }

    // Proceed from confirmation
    function proceedFromConfirm() {
      console.log('[CONFIRM] Action:', confirmModalAction);
  
      // SAVE the action BEFORE closing (which resets it to null)
      const actionToTake = confirmModalAction;
  
      closeConfirmModal();
  
      // Add a small delay to ensure modal closes before opening next one
      setTimeout(() => {
        console.log('[CONFIRM] Proceeding with action:', actionToTake);
    
        if (actionToTake === 'deliver') {
          console.log('[CONFIRM] Opening deliver modal...');
          const deliverModal = document.getElementById('deliverModal');
          deliverModal.classList.add('show');
          document.body.style.overflow = 'hidden';
        } else if (actionToTake === 'finalize') {
          console.log('[CONFIRM] Finalizing video...');
          finalizeVideoDirectly();
        }
      }, 300);
    }

    // Finalize video directly (extracted from original button handler)
    async function finalizeVideoDirectly() {
      const confirmed = confirm(
        "Final confirmation: You won't be able to make anymore edits to the final video. " +
        "You will also be emailed a final copy as a backup."
      );
    
      if (!confirmed) return;
    
      try {
        const downloadUrl = window.videoData.downloadUrl || window.videoData.videoUrl;
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `memorial_video_${jobId}.mp4`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      
        showToast('Finalizing your order...', 'success');
        const response = await fetch(`${API_BASE}/jobs/${jobId}/finalize`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
      
        if (!response.ok) {
          throw new Error('Failed to finalize order');
        }
      
        const finalizedUrl = `${window.location.origin}${window.location.pathname}?job=${jobId}&finalized=true`;
        history.replaceState(null, '', finalizedUrl);
        location.reload();
      
      } catch (error) {
        console.error('[FINALIZE ERROR]', error);
        showToast('Download started, but email failed. Please contact support.', 'error');
      }
    }

    // Close modal when clicking outside
    document.getElementById('confirmModal').addEventListener('click', (e) => {
      if (e.target.id === 'confirmModal') {
        closeConfirmModal();
      }
    });
    // Music terms modal functions
    function showMusicTermsModal(e) {
      e.preventDefault();
      document.getElementById('musicTermsModal').classList.add('show');
    }

    function cancelMusicUpload() {
      document.getElementById('musicTermsModal').classList.remove('show');
      document.getElementById('newSongUpload').value = ''; // Clear file input
    }

    function acceptMusicTerms() {
      document.getElementById('musicTermsModal').classList.remove('show');
      // Trigger the file input
      document.getElementById('newSongUpload').click();
    }
    
  </script>

<!-- Calculation Modal -->
  <div id="calculationModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header calc-header">
        <h2>📊 Your Video Calculation</h2>
      </div>
      
      <div class="modal-body">
        <div class="calc-result-item">
          <span class="calc-label">Slide Count:</span>
          <span class="calc-value" id="modalSlideCount">--</span>
        </div>
        
        <div class="calc-result-item">
          <span class="calc-label">Estimated Duration:</span>
          <span class="calc-value" id="modalDuration">--</span>
        </div>
        
        <div class="calc-summary" id="modalSummary">
          Calculating...
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="modal-btn modal-btn-secondary" onclick="closeCalculationModal()">
          ← Make Another Update
        </button>
        <button class="modal-btn modal-btn-calc-primary" onclick="finalSubmit()">
          Create This Video →
        </button>
      </div>
    </div>
  </div>
  
  <!-- Music Terms Modal -->
  <div id="musicTermsModal" class="terms-modal-overlay">
    <div class="terms-modal-content">
      <div class="terms-modal-header">
        <h2>⚠️ User Uploaded Music</h2>
      </div>
    
      <div class="terms-modal-body">
        <p>By clicking "Agree and Accept," you confirm that you have the legal right to upload and publicly display all content (including photos, videos, and music) in your memorial video.</p>
      
        <p>You agree that Memorial Video AI is not responsible for any copyright or other legal issues arising from content you upload, and you will protect and reimburse Memorial Video AI for any claims, costs, or damages (including legal fees) that result from your uploaded content violating someone else's rights.</p>
      </div>
    
      <div class="terms-modal-footer">
        <button class="terms-btn terms-btn-cancel" onclick="cancelMusicUpload()">
          Cancel Upload
        </button>
        <button class="terms-btn terms-btn-accept" onclick="acceptMusicTerms()">
          Agree and Accept
        </button>
      </div>
    </div>
  </div>
  
</body>
</html>
